function f(n){if(!n)throw new Error("Assertion failed.")}var Ie=n=>{let e=(n%360+360)%360;if(e===0||e===90||e===180||e===270)return e;throw new Error(`Invalid rotation ${n}.`)},M=n=>n&&n[n.length-1],Ae=n=>n>=0&&n<2**32,v=(n,e,t)=>{let r=0;for(let i=e;i<t;i++){let a=Math.floor(i/8),s=n[a],o=7-(i&7),d=(s&1<<o)>>o;r<<=1,r|=d}return r},Ha=(n,e,t,r)=>{for(let i=e;i<t;i++){let a=Math.floor(i/8),s=n[a],o=7-(i&7);s&=~(1<<o),s|=(r&1<<t-i-1)>>t-i-1<<o,n[a]=s}},Q=n=>n instanceof ArrayBuffer?new Uint8Array(n):new Uint8Array(n.buffer,n.byteOffset,n.byteLength),Y=n=>n instanceof ArrayBuffer?new DataView(n):new DataView(n.buffer,n.byteOffset,n.byteLength),se=new TextEncoder,Gr=n=>Object.fromEntries(Object.entries(n).map(([e,t])=>[t,e])),ge={bt709:1,bt470bg:5,smpte170m:6,bt2020:9,smpte432:12},Lt=Gr(ge),be={bt709:1,smpte170m:6,linear:8,"iec61966-2-1":13,pg:16,hlg:18},Ht=Gr(be),ke={rgb:0,bt709:1,bt470bg:5,smpte170m:6,"bt2020-ncl":9},$t=Gr(ke),Qt=n=>!!n&&!!n.primaries&&!!n.transfer&&!!n.matrix&&n.fullRange!==void 0,Ue=n=>n instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&n instanceof SharedArrayBuffer||ArrayBuffer.isView(n)&&!(n instanceof DataView),de=class{constructor(){this.currentPromise=Promise.resolve()}async acquire(){let e,t=new Promise(i=>{e=i}),r=this.currentPromise;return this.currentPromise=t,await r,e}},$a=n=>[...n].map(e=>e.toString(16).padStart(2,"0")).join(""),Qa=n=>(n=n>>1&1431655765|(n&1431655765)<<1,n=n>>2&858993459|(n&858993459)<<2,n=n>>4&252645135|(n&252645135)<<4,n=n>>8&16711935|(n&16711935)<<8,n=n>>16&65535|(n&65535)<<16,n>>>0),U=(n,e,t)=>{let r=0,i=n.length-1,a=-1;for(;r<=i;){let s=r+i>>1,o=t(n[s]);o===e?(a=s,i=s-1):o<e?r=s+1:i=s-1}return a},R=(n,e,t)=>{let r=-1,i=0,a=n.length-1;for(;i<=a;){let s=i+(a-i+1)/2|0;t(n[s])<=e?(r=s,i=s+1):a=s-1}return r},W=()=>{let n,e;return{promise:new Promise((r,i)=>{n=r,e=i}),resolve:n,reject:e}},qa=(n,e)=>{let t=n.indexOf(e);t!==-1&&n.splice(t,1)},Kr=(n,e)=>{for(let t=n.length-1;t>=0;t--)if(e(n[t]))return n[t]},qt=(n,e)=>{for(let t=n.length-1;t>=0;t--)if(e(n[t]))return t;return-1},Ga=async function*(n){Symbol.iterator in n?yield*n[Symbol.iterator]():yield*n[Symbol.asyncIterator]()},Ka=n=>{if(!(Symbol.iterator in n)&&!(Symbol.asyncIterator in n))throw new TypeError("Argument must be an iterable or async iterable.")};var jr=(n,e,t)=>{let r=n.getUint8(e),i=n.getUint8(e+1),a=n.getUint8(e+2);return t?r|i<<8|a<<16:r<<16|i<<8|a},ja=(n,e,t)=>jr(n,e,t)<<8>>8,Xr=(n,e,t,r)=>{t=t>>>0,t=t&16777215,r?(n.setUint8(e,t&255),n.setUint8(e+1,t>>>8&255),n.setUint8(e+2,t>>>16&255)):(n.setUint8(e,t>>>16&255),n.setUint8(e+1,t>>>8&255),n.setUint8(e+2,t&255))},Xa=(n,e,t,r)=>{t=L(t,-8388608,8388607),t<0&&(t=t+16777216&16777215),Xr(n,e,t,r)},Ya=(n,e,t,r)=>{r?(n.setUint32(e+0,t,!0),n.setInt32(e+4,Math.floor(t/2**32),!0)):(n.setInt32(e+0,Math.floor(t/2**32),!0),n.setUint32(e+4,t,!0))},ot=(n,e)=>({async next(){let t=await n.next();return t.done?{value:void 0,done:!0}:{value:e(t.value),done:!1}},return(){return n.return()},throw(t){return n.throw(t)},[Symbol.asyncIterator](){return this}}),L=(n,e,t)=>Math.max(e,Math.min(t,n)),j="und",Be=(n,e)=>{let t=10**e;return Math.round(n*t)/t},Za=(n,e)=>Math.round(n/e)*e,Ja=n=>{let e=0;for(;n;)e++,n>>=1;return e},qi=/^[a-z]{3}$/,Ne=n=>qi.test(n),ue=1e6*(1+Number.EPSILON);var Gt=class{static supports(e,t){return!1}},Kt=class{static supports(e,t){return!1}},jt=class{static supports(e,t){return!1}},Xt=class{static supports(e,t){return!1}},ct=[],dt=[],We=[],Le=[],Gi=n=>{if(n.prototype instanceof Gt)ct.push(n);else if(n.prototype instanceof Kt)dt.push(n);else throw new TypeError("Decoder must be a CustomVideoDecoder or CustomAudioDecoder.")},Ki=n=>{if(n.prototype instanceof jt)We.push(n);else if(n.prototype instanceof Xt)Le.push(n);else throw new TypeError("Encoder must be a CustomVideoEncoder or CustomAudioEncoder.")};var H=["avc","hevc","vp9","av1","vp8"],D=["pcm-s16","pcm-s16be","pcm-s24","pcm-s24be","pcm-s32","pcm-s32be","pcm-f32","pcm-f32be","pcm-u8","pcm-s8","ulaw","alaw"],we=["aac","opus","mp3","vorbis","flac"],q=[...we,...D],re=["webvtt"],ei=[{maxMacroblocks:99,maxBitrate:64e3,level:10},{maxMacroblocks:396,maxBitrate:192e3,level:11},{maxMacroblocks:396,maxBitrate:384e3,level:12},{maxMacroblocks:396,maxBitrate:768e3,level:13},{maxMacroblocks:396,maxBitrate:2e6,level:20},{maxMacroblocks:792,maxBitrate:4e6,level:21},{maxMacroblocks:1620,maxBitrate:4e6,level:22},{maxMacroblocks:1620,maxBitrate:1e7,level:30},{maxMacroblocks:3600,maxBitrate:14e6,level:31},{maxMacroblocks:5120,maxBitrate:2e7,level:32},{maxMacroblocks:8192,maxBitrate:2e7,level:40},{maxMacroblocks:8192,maxBitrate:5e7,level:41},{maxMacroblocks:8704,maxBitrate:5e7,level:42},{maxMacroblocks:22080,maxBitrate:135e6,level:50},{maxMacroblocks:36864,maxBitrate:24e7,level:51},{maxMacroblocks:36864,maxBitrate:24e7,level:52},{maxMacroblocks:139264,maxBitrate:24e7,level:60},{maxMacroblocks:139264,maxBitrate:48e7,level:61},{maxMacroblocks:139264,maxBitrate:8e8,level:62}],ti=[{maxPictureSize:36864,maxBitrate:128e3,tier:"L",level:30},{maxPictureSize:122880,maxBitrate:15e5,tier:"L",level:60},{maxPictureSize:245760,maxBitrate:3e6,tier:"L",level:63},{maxPictureSize:552960,maxBitrate:6e6,tier:"L",level:90},{maxPictureSize:983040,maxBitrate:1e7,tier:"L",level:93},{maxPictureSize:2228224,maxBitrate:12e6,tier:"L",level:120},{maxPictureSize:2228224,maxBitrate:3e7,tier:"H",level:120},{maxPictureSize:2228224,maxBitrate:2e7,tier:"L",level:123},{maxPictureSize:2228224,maxBitrate:5e7,tier:"H",level:123},{maxPictureSize:8912896,maxBitrate:25e6,tier:"L",level:150},{maxPictureSize:8912896,maxBitrate:1e8,tier:"H",level:150},{maxPictureSize:8912896,maxBitrate:4e7,tier:"L",level:153},{maxPictureSize:8912896,maxBitrate:16e7,tier:"H",level:153},{maxPictureSize:8912896,maxBitrate:6e7,tier:"L",level:156},{maxPictureSize:8912896,maxBitrate:24e7,tier:"H",level:156},{maxPictureSize:35651584,maxBitrate:6e7,tier:"L",level:180},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:180},{maxPictureSize:35651584,maxBitrate:12e7,tier:"L",level:183},{maxPictureSize:35651584,maxBitrate:48e7,tier:"H",level:183},{maxPictureSize:35651584,maxBitrate:24e7,tier:"L",level:186},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:186}],ve=[{maxPictureSize:36864,maxBitrate:2e5,level:10},{maxPictureSize:73728,maxBitrate:8e5,level:11},{maxPictureSize:122880,maxBitrate:18e5,level:20},{maxPictureSize:245760,maxBitrate:36e5,level:21},{maxPictureSize:552960,maxBitrate:72e5,level:30},{maxPictureSize:983040,maxBitrate:12e6,level:31},{maxPictureSize:2228224,maxBitrate:18e6,level:40},{maxPictureSize:2228224,maxBitrate:3e7,level:41},{maxPictureSize:8912896,maxBitrate:6e7,level:50},{maxPictureSize:8912896,maxBitrate:12e7,level:51},{maxPictureSize:8912896,maxBitrate:18e7,level:52},{maxPictureSize:35651584,maxBitrate:18e7,level:60},{maxPictureSize:35651584,maxBitrate:24e7,level:61},{maxPictureSize:35651584,maxBitrate:48e7,level:62}],ri=[{maxPictureSize:147456,maxBitrate:15e5,tier:"M",level:0},{maxPictureSize:278784,maxBitrate:3e6,tier:"M",level:1},{maxPictureSize:665856,maxBitrate:6e6,tier:"M",level:4},{maxPictureSize:1065024,maxBitrate:1e7,tier:"M",level:5},{maxPictureSize:2359296,maxBitrate:12e6,tier:"M",level:8},{maxPictureSize:2359296,maxBitrate:3e7,tier:"H",level:8},{maxPictureSize:2359296,maxBitrate:2e7,tier:"M",level:9},{maxPictureSize:2359296,maxBitrate:5e7,tier:"H",level:9},{maxPictureSize:8912896,maxBitrate:3e7,tier:"M",level:12},{maxPictureSize:8912896,maxBitrate:1e8,tier:"H",level:12},{maxPictureSize:8912896,maxBitrate:4e7,tier:"M",level:13},{maxPictureSize:8912896,maxBitrate:16e7,tier:"H",level:13},{maxPictureSize:8912896,maxBitrate:6e7,tier:"M",level:14},{maxPictureSize:8912896,maxBitrate:24e7,tier:"H",level:14},{maxPictureSize:35651584,maxBitrate:6e7,tier:"M",level:15},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:15},{maxPictureSize:35651584,maxBitrate:6e7,tier:"M",level:16},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:16},{maxPictureSize:35651584,maxBitrate:1e8,tier:"M",level:17},{maxPictureSize:35651584,maxBitrate:48e7,tier:"H",level:17},{maxPictureSize:35651584,maxBitrate:16e7,tier:"M",level:18},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:18},{maxPictureSize:35651584,maxBitrate:16e7,tier:"M",level:19},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:19}],ji=".01.01.01.01.00",Xi=".0.110.01.01.01.0",Yt=(n,e,t,r)=>{if(n==="avc"){let a=Math.ceil(e/16)*Math.ceil(t/16),s=ei.find(l=>a<=l.maxMacroblocks&&r<=l.maxBitrate)??M(ei),o=s?s.level:0,d="64".padStart(2,"0"),c="00",u=o.toString(16).padStart(2,"0");return`avc1.${d}${c}${u}`}else if(n==="hevc"){let i="",s="6",o=e*t,d=ti.find(u=>o<=u.maxPictureSize&&r<=u.maxBitrate)??M(ti);return`hev1.${i}1.${s}.${d.tier}${d.level}.B0`}else{if(n==="vp8")return"vp8";if(n==="vp9"){let i="00",a=e*t,s=ve.find(d=>a<=d.maxPictureSize&&r<=d.maxBitrate)??M(ve);return`vp09.${i}.${s.level.toString().padStart(2,"0")}.08${ji}`}else if(n==="av1"){let a=e*t,s=ri.find(c=>a<=c.maxPictureSize&&r<=c.maxBitrate)??M(ri);return`av01.0.${s.level.toString().padStart(2,"0")}${s.tier}.08${Xi}`}}throw new TypeError(`Unhandled codec '${n}'.`)},tr=n=>{let e=n.split("."),i=(1<<7)+1,a=Number(e[1]),s=e[2],o=Number(s.slice(0,-1)),d=(a<<5)+o,c=s.slice(-1)==="H"?1:0,l=Number(e[3])===8?0:1,m=0,p=e[4]?Number(e[4]):0,h=e[5]?Number(e[5][0]):1,b=e[5]?Number(e[5][1]):1,g=e[5]?Number(e[5][2]):0,k=(c<<7)+(l<<6)+(m<<5)+(p<<4)+(h<<3)+(b<<2)+g;return[i,d,k,0]},rr=n=>{let{codec:e,codecDescription:t,colorSpace:r,vp9CodecInfo:i,av1CodecInfo:a}=n;if(e==="avc"){if(!t||t.byteLength<4)throw new TypeError("AVC description must be at least 4 bytes long.");return`avc1.${$a(t.subarray(1,4))}`}else if(e==="hevc"){if(!t)throw new TypeError("HEVC description must be provided.");let s=Y(t),o="hev1.",d=t[1]>>6&3,c=t[1]&31;o+=["","A","B","C"][d]+c,o+=".";let u=Qa(s.getUint32(2));o+=u.toString(16),o+=".";let l=t[1]>>5&1,m=t[12];o+=l===0?"L":"H",o+=m,o+=".";let p=[];for(let h=0;h<6;h++){let b=t[h+13];p.push(b)}for(;p[p.length-1]===0;)p.pop();return o+=p.map(h=>h.toString(16)).join("."),o}else{if(e==="vp8")return"vp8";if(e==="vp9"){if(!i){let g=n.width*n.height,k=M(ve).level;for(let x of ve)if(g<=x.maxPictureSize){k=x.level;break}return`vp09.00.${k.toString().padStart(2,"0")}.08`}let s=i.profile.toString().padStart(2,"0"),o=i.level.toString().padStart(2,"0"),d=i.bitDepth.toString().padStart(2,"0"),c=i.chromaSubsampling.toString().padStart(2,"0"),u=i.colourPrimaries.toString().padStart(2,"0"),l=i.transferCharacteristics.toString().padStart(2,"0"),m=i.matrixCoefficients.toString().padStart(2,"0"),p=i.videoFullRangeFlag.toString().padStart(2,"0"),h=`vp09.${s}.${o}.${d}.${c}`;h+=`.${u}.${l}.${m}.${p}`;let b=".01.01.01.01.00";return h.endsWith(b)&&(h=h.slice(0,-b.length)),h}else if(e==="av1"){if(!a){let x=n.width*n.height,w=M(ve).level;for(let T of ve)if(x<=T.maxPictureSize){w=T.level;break}return`av01.0.${w.toString().padStart(2,"0")}M.08`}let s=a.profile,o=a.level.toString().padStart(2,"0"),d=a.tier?"H":"M",c=a.bitDepth.toString().padStart(2,"0"),u=a.monochrome?"1":"0",l=100*a.chromaSubsamplingX+10*a.chromaSubsamplingY+1*(a.chromaSubsamplingX&&a.chromaSubsamplingY?a.chromaSamplePosition:0),m=r?.primaries?ge[r.primaries]:1,p=r?.transfer?be[r.transfer]:1,h=r?.matrix?ke[r.matrix]:1,b=r?.fullRange?1:0,g=`av01.${s}.${o}${d}.${c}`;g+=`.${u}.${l.toString().padStart(3,"0")}`,g+=`.${m.toString().padStart(2,"0")}`,g+=`.${p.toString().padStart(2,"0")}`,g+=`.${h.toString().padStart(2,"0")}`,g+=`.${b}`;let k=".0.110.01.01.01.0";return g.endsWith(k)&&(g=g.slice(0,-k.length)),g}}throw new TypeError(`Unhandled codec '${e}'.`)},ar=n=>{let e=n[n.length-1];if(e&&(e&224)===192){let P=((e&24)>>3)+1,E=2+((e&7)+1)*P;if(n[n.length-E]!==e)return null;let z=0,N=n.length-E+1;for(let K=0;K<P;K++){if(!n[N+K])return null;z|=n[N+K]<<8*K}n=n.subarray(0,z)}let t=0;if(v(n,t,t+2)!==2)return null;t+=2;let i=v(n,t,t+1);t+=1;let a=v(n,t,t+1);t+=1;let s=(a<<1)+i;s===3&&(t+=1);let o=v(n,t,t+1);if(t+=1,o===1)return null;let d=v(n,t,t+1);if(t+=1,d!==0||(t+=2,v(n,t,t+24)!==4817730))return null;t+=24;let u=8;if(s>=2){let P=v(n,t,t+1);t+=1,u=P?12:10}let l=v(n,t,t+3);t+=3;let m=0,p=0;if(l!==7){let P=v(n,t,t+1);if(t+=1,p=P,s===1||s===3){let I=v(n,t,t+1);t+=1;let E=v(n,t,t+1);t+=1,m=!I&&!E?3:I&&!E?2:1,t+=1}else m=1}else m=3,p=1;let h=v(n,t,t+16);t+=16;let b=v(n,t,t+16);t+=16;let g=h+1,k=b+1,x=g*k,w=M(ve).level;for(let P of ve)if(x<=P.maxPictureSize){w=P.level;break}return{profile:s,level:w,bitDepth:u,chromaSubsampling:m,videoFullRangeFlag:p,colourPrimaries:l===2?1:l===1?6:2,transferCharacteristics:l===2?1:l===1?6:2,matrixCoefficients:l===7?0:l===2?1:l===1?6:2}},ai=n=>{let e=0,t=()=>{let r=0;for(let i=0;i<8;i++){let a=n[e++];if(a===void 0)return 0;if(r|=(a&127)<<i*7,!(a&128))break;if(i===7&&a&128)return null}return r>=2**32-1?null:r};for(;e<n.length;){let r=v(n,e*8,e*8+8);e+=1;let i=r>>3&15,a=r>>2&1,s=r>>1&1;a&&(e+=1);let o;if(s){let d=t();if(d===null)return null;o=d}else o=n.length-e;if(i===1){let d=e*8,c=0,u=v(n,d+c,d+c+3);c+=3;let l=v(n,d+c,d+c+1);c+=1;let m=v(n,d+c,d+c+1);c+=1;let p=0,h=0,b=0;if(m)p=v(n,d+c,d+c+5),c+=5;else{let y=v(n,d+c,d+c+1);if(c+=1,y){c+=32,c+=32;let E=v(n,d+c,d+c+1);if(c+=1,E)return null}let P=v(n,d+c,d+c+1);c+=1,P&&(b=v(n,d+c,d+c+5),c+=5,c+=32,c+=5,c+=5);let I=v(n,d+c,d+c+5);c+=5;for(let E=0;E<=I;E++){c+=12;let z=v(n,d+c,d+c+5);if(c+=5,E===0&&(p=z),z>7){let K=v(n,d+c,d+c+1);c+=1,E===0&&(h=K)}if(P){let K=v(n,d+c,d+c+1);if(c+=1,K){let Pe=b+1;c+=Pe,c+=Pe,c+=1}}let N=v(n,d+c,d+c+1);c+=1,N&&(c+=4)}}let g=v(n,d+c,d+c+1);c+=1;let k=8;if(u===2&&g){let y=v(n,d+c,d+c+1);c+=1,k=y?12:10}else u<=2&&(k=g?10:8);let x=0;u!==1&&(x=v(n,d+c,d+c+1),c+=1);let w=1,T=1,S=0;return x||(u===0?(w=1,T=1):u===1?(w=0,T=0):k===12&&(w=v(n,d+c,d+c+1),c+=1,w&&(T=v(n,d+c,d+c+1),c+=1)),w&&T&&(S=v(n,d+c,d+c+2),c+=2)),{profile:u,level:p,tier:h,bitDepth:k,monochrome:x,chromaSubsamplingX:w,chromaSubsamplingY:T,chromaSamplePosition:S}}e+=o}return null},Zt=(n,e,t)=>{if(n==="aac")return e>=2&&t<=24e3?"mp4a.40.29":t<=24e3?"mp4a.40.5":"mp4a.40.2";if(n==="mp3")return"mp3";if(n==="opus")return"opus";if(n==="vorbis")return"vorbis";if(n==="flac")return"flac";if(D.includes(n))return n;throw new TypeError(`Unhandled codec '${n}'.`)},ir=n=>{let{codec:e,codecDescription:t,aacCodecInfo:r}=n;if(e==="aac"){if(!r)throw new TypeError("AAC codec info must be provided.");return r.isMpeg2?"mp4a.67":`mp4a.40.${Yr(t).objectType}`}else{if(e==="mp3")return"mp3";if(e==="opus")return"opus";if(e==="vorbis")return"vorbis";if(e==="flac")return"flac";if(e&&D.includes(e))return e}throw new TypeError(`Unhandled codec '${e}'.`)},Yr=n=>{if(!n||n.byteLength<2)throw new TypeError("AAC description must be at least 2 bytes long.");let e=0,t=v(n,e,e+5);e+=5,t===31&&(t=32+v(n,e,e+6),e+=6);let r=v(n,e,e+4);e+=4;let i=null;if(r===15)i=v(n,e,e+24),e+=24;else{let o=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];r<o.length&&(i=o[r])}let a=v(n,e,e+4);e+=4;let s=null;return a>=1&&a<=7&&(s={1:1,2:2,3:3,4:4,5:5,6:6,7:8}[a]),{objectType:t,frequencyIndex:r,sampleRate:i,channelConfiguration:a,numberOfChannels:s}},Ee=n=>{let e=Y(n),t=e.getUint8(9),r=e.getUint16(10,!0),i=e.getUint32(12,!0),a=e.getInt16(16,!0),s=e.getUint8(18),o=null;return s&&(o=n.subarray(19,21+t)),{outputChannelCount:t,preSkip:r,inputSampleRate:i,outputGain:a,channelMappingFamily:s,channelMappingTable:o}},He=48e3,Yi=[480,960,1920,2880,480,960,1920,2880,480,960,1920,2880,480,960,480,960,120,240,480,960,120,240,480,960,120,240,480,960,120,240,480,960],ii=n=>{let e=n[0]>>3;return{durationInSamples:Yi[e]}},Zi=/^pcm-([usf])(\d+)+(be)?$/,J=n=>{if(f(D.includes(n)),n==="ulaw")return{dataType:"ulaw",sampleSize:1,littleEndian:!0,silentValue:255};if(n==="alaw")return{dataType:"alaw",sampleSize:1,littleEndian:!0,silentValue:213};let e=Zi.exec(n);f(e);let t;e[1]==="u"?t="unsigned":e[1]==="s"?t="signed":t="float";let r=Number(e[2])/8,i=e[3]!=="be",a=n==="pcm-u8"?2**7:0;return{dataType:t,sampleSize:r,littleEndian:i,silentValue:a}},Jt=n=>n==="avc"?{avc:{format:"avc"}}:n==="hevc"?{hevc:{format:"hevc"}}:{},er=n=>n==="aac"?{aac:{format:"aac"}}:n==="opus"?{opus:{format:"opus"}}:{},X=class{constructor(e){this._factor=e}_toVideoBitrate(e,t,r){let i=t*r,a={avc:1,hevc:.6,vp9:.6,av1:.4,vp8:1.2},c=(u=>2e6*Math.pow(u/2073600,.75))(i)*a[e]*this._factor;return Math.ceil(c/1e3)*1e3}_toAudioBitrate(e){if(D.includes(e)||e==="flac")return-1;let r={aac:128e3,opus:64e3,mp3:16e4,vorbis:64e3}[e];if(!r)throw new Error(`Unhandled codec: ${e}`);let i=r*this._factor;return e==="aac"?i=[96e3,128e3,16e4,192e3].reduce((s,o)=>Math.abs(o-i)<Math.abs(s-i)?o:s):e==="opus"||e==="vorbis"?i=Math.max(6e3,i):e==="mp3"&&(i=[8e3,16e3,24e3,32e3,4e4,48e3,64e3,8e4,96e3,112e3,128e3,16e4,192e3,224e3,256e3,32e4].reduce((s,o)=>Math.abs(o-i)<Math.abs(s-i)?o:s)),Math.round(i/1e3)*1e3}},Ji=new X(.4),en=new X(.6),tn=new X(1),ut=new X(2),rn=new X(4),an=["avc1","avc3","hev1","hvc1","vp8","vp09","av01"],nn=/^(avc1|avc3)\.[0-9a-fA-F]{6}$/,sn=/^(hev1|hvc1)\.(?:[ABC]?\d+)\.[0-9a-fA-F]{1,8}\.[LH]\d+(?:\.[0-9a-fA-F]{1,2}){0,6}$/,on=/^vp09(?:\.\d{2}){3}(?:(?:\.\d{2}){5})?$/,cn=/^av01\.\d\.\d{2}[MH]\.\d{2}(?:\.\d\.\d{3}\.\d{2}\.\d{2}\.\d{2}\.\d)?$/,nr=n=>{if(!n)throw new TypeError("Video chunk metadata must be provided.");if(typeof n!="object")throw new TypeError("Video chunk metadata must be an object.");if(!n.decoderConfig)throw new TypeError("Video chunk metadata must include a decoder configuration.");if(typeof n.decoderConfig!="object")throw new TypeError("Video chunk metadata decoder configuration must be an object.");if(typeof n.decoderConfig.codec!="string")throw new TypeError("Video chunk metadata decoder configuration must specify a codec string.");if(!an.some(e=>n.decoderConfig.codec.startsWith(e)))throw new TypeError("Video chunk metadata decoder configuration codec string must be a valid video codec string as specified in the WebCodecs codec registry.");if(!Number.isInteger(n.decoderConfig.codedWidth)||n.decoderConfig.codedWidth<=0)throw new TypeError("Video chunk metadata decoder configuration must specify a valid codedWidth (positive integer).");if(!Number.isInteger(n.decoderConfig.codedHeight)||n.decoderConfig.codedHeight<=0)throw new TypeError("Video chunk metadata decoder configuration must specify a valid codedHeight (positive integer).");if(n.decoderConfig.description!==void 0&&!Ue(n.decoderConfig.description))throw new TypeError("Video chunk metadata decoder configuration description, when defined, must be an ArrayBuffer or an ArrayBuffer view.");if(n.decoderConfig.colorSpace!==void 0){let{colorSpace:e}=n.decoderConfig;if(typeof e!="object")throw new TypeError("Video chunk metadata decoder configuration colorSpace, when provided, must be an object.");let t=Object.keys(ge);if(e.primaries!=null&&!t.includes(e.primaries))throw new TypeError(`Video chunk metadata decoder configuration colorSpace primaries, when defined, must be one of ${t.join(", ")}.`);let r=Object.keys(be);if(e.transfer!=null&&!r.includes(e.transfer))throw new TypeError(`Video chunk metadata decoder configuration colorSpace transfer, when defined, must be one of ${r.join(", ")}.`);let i=Object.keys(ke);if(e.matrix!=null&&!i.includes(e.matrix))throw new TypeError(`Video chunk metadata decoder configuration colorSpace matrix, when defined, must be one of ${i.join(", ")}.`);if(e.fullRange!=null&&typeof e.fullRange!="boolean")throw new TypeError("Video chunk metadata decoder configuration colorSpace fullRange, when defined, must be a boolean.")}if(n.decoderConfig.codec.startsWith("avc1")||n.decoderConfig.codec.startsWith("avc3")){if(!nn.test(n.decoderConfig.codec))throw new TypeError("Video chunk metadata decoder configuration codec string for AVC must be a valid AVC codec string as specified in Section 3.4 of RFC 6381.");if(!n.decoderConfig.description)throw new TypeError("Video chunk metadata decoder configuration for AVC must include a description, which is expected to be an AVCDecoderConfigurationRecord as specified in ISO 14496-15.")}if(n.decoderConfig.codec.startsWith("hev1")||n.decoderConfig.codec.startsWith("hvc1")){if(!sn.test(n.decoderConfig.codec))throw new TypeError("Video chunk metadata decoder configuration codec string for HEVC must be a valid HEVC codec string as specified in Section E.3 of ISO 14496-15.");if(!n.decoderConfig.description)throw new TypeError("Video chunk metadata decoder configuration for HEVC must include a description, which is expected to be an HEVCDecoderConfigurationRecord as specified in ISO 14496-15.")}if(n.decoderConfig.codec.startsWith("vp8")&&n.decoderConfig.codec!=="vp8")throw new TypeError('Video chunk metadata decoder configuration codec string for VP8 must be "vp8".');if(n.decoderConfig.codec.startsWith("vp09")&&!on.test(n.decoderConfig.codec))throw new TypeError('Video chunk metadata decoder configuration codec string for VP9 must be a valid VP9 codec string as specified in Section "Codecs Parameter String" of https://www.webmproject.org/vp9/mp4/.');if(n.decoderConfig.codec.startsWith("av01")&&!cn.test(n.decoderConfig.codec))throw new TypeError('Video chunk metadata decoder configuration codec string for AV1 must be a valid AV1 codec string as specified in Section "Codecs Parameter String" of https://aomediacodec.github.io/av1-isobmff/.')},dn=["mp4a","mp3","opus","vorbis","flac","ulaw","alaw","pcm"],sr=n=>{if(!n)throw new TypeError("Audio chunk metadata must be provided.");if(typeof n!="object")throw new TypeError("Audio chunk metadata must be an object.");if(!n.decoderConfig)throw new TypeError("Audio chunk metadata must include a decoder configuration.");if(typeof n.decoderConfig!="object")throw new TypeError("Audio chunk metadata decoder configuration must be an object.");if(typeof n.decoderConfig.codec!="string")throw new TypeError("Audio chunk metadata decoder configuration must specify a codec string.");if(!dn.some(e=>n.decoderConfig.codec.startsWith(e)))throw new TypeError("Audio chunk metadata decoder configuration codec string must be a valid audio codec string as specified in the WebCodecs codec registry.");if(!Number.isInteger(n.decoderConfig.sampleRate)||n.decoderConfig.sampleRate<=0)throw new TypeError("Audio chunk metadata decoder configuration must specify a valid sampleRate (positive integer).");if(!Number.isInteger(n.decoderConfig.numberOfChannels)||n.decoderConfig.numberOfChannels<=0)throw new TypeError("Audio chunk metadata decoder configuration must specify a valid numberOfChannels (positive integer).");if(n.decoderConfig.description!==void 0&&!Ue(n.decoderConfig.description))throw new TypeError("Audio chunk metadata decoder configuration description, when defined, must be an ArrayBuffer or an ArrayBuffer view.");if(n.decoderConfig.codec.startsWith("mp4a")){if(!["mp4a.40.2","mp4a.40.02","mp4a.40.5","mp4a.40.05","mp4a.40.29","mp4a.67"].includes(n.decoderConfig.codec))throw new TypeError("Audio chunk metadata decoder configuration codec string for AAC must be a valid AAC codec string as specified in https://www.w3.org/TR/webcodecs-aac-codec-registration/.");if(!n.decoderConfig.description)throw new TypeError("Audio chunk metadata decoder configuration for AAC must include a description, which is expected to be an AudioSpecificConfig as specified in ISO 14496-3.")}if(n.decoderConfig.codec==="mp3"&&n.decoderConfig.codec!=="mp3")throw new TypeError('Audio chunk metadata decoder configuration codec string for MP3 must be "mp3".');if(n.decoderConfig.codec==="opus"){if(n.decoderConfig.codec!=="opus")throw new TypeError('Audio chunk metadata decoder configuration codec string for Opus must be "opus".');if(n.decoderConfig.description&&n.decoderConfig.description.byteLength<18)throw new TypeError("Audio chunk metadata decoder configuration description, when specified, is expected to be an Identification Header as specified in Section 5.1 of RFC 7845.")}if(n.decoderConfig.codec==="vorbis"){if(n.decoderConfig.codec!=="vorbis")throw new TypeError('Audio chunk metadata decoder configuration codec string for Vorbis must be "vorbis".');if(!n.decoderConfig.description)throw new TypeError("Audio chunk metadata decoder configuration for Vorbis must include a description, which is expected to adhere to the format described in https://www.w3.org/TR/webcodecs-vorbis-codec-registration/.")}if(n.decoderConfig.codec==="flac"){if(n.decoderConfig.codec!=="flac")throw new TypeError('Audio chunk metadata decoder configuration codec string for FLAC must be "flac".');if(!n.decoderConfig.description||n.decoderConfig.description.byteLength<42)throw new TypeError("Audio chunk metadata decoder configuration for FLAC must include a description, which is expected to adhere to the format described in https://www.w3.org/TR/webcodecs-flac-codec-registration/.")}if((n.decoderConfig.codec.startsWith("pcm")||n.decoderConfig.codec.startsWith("ulaw")||n.decoderConfig.codec.startsWith("alaw"))&&!D.includes(n.decoderConfig.codec))throw new TypeError(`Audio chunk metadata decoder configuration codec string for PCM must be one of the supported PCM codecs (${D.join(", ")}).`)},or=n=>{if(!n)throw new TypeError("Subtitle metadata must be provided.");if(typeof n!="object")throw new TypeError("Subtitle metadata must be an object.");if(!n.config)throw new TypeError("Subtitle metadata must include a config object.");if(typeof n.config!="object")throw new TypeError("Subtitle metadata config must be an object.");if(typeof n.config.description!="string")throw new TypeError("Subtitle metadata config description must be a string.")},un=n=>{if(H.includes(n))return Zr(n);if(q.includes(n))return Jr(n);if(re.includes(n))return ea(n);throw new TypeError(`Unknown codec '${n}'.`)},Zr=async(n,{width:e=1280,height:t=720,bitrate:r=1e6}={})=>{if(!H.includes(n))return!1;if(!Number.isInteger(e)||e<=0)throw new TypeError("width must be a positive integer.");if(!Number.isInteger(t)||t<=0)throw new TypeError("height must be a positive integer.");if(!Number.isInteger(r)||r<=0)throw new TypeError("bitrate must be a positive integer.");if(We.length>0){let a={codec:Yt(n,e,t,r),width:e,height:t,bitrate:r,...Jt(n)};if(We.some(s=>s.supports(n,a)))return!0}return typeof VideoEncoder>"u"?!1:(await VideoEncoder.isConfigSupported({codec:Yt(n,e,t,r),width:e,height:t,bitrate:r,...Jt(n)})).supported===!0},Jr=async(n,{numberOfChannels:e=2,sampleRate:t=48e3,bitrate:r=128e3}={})=>{if(!q.includes(n))return!1;if(!Number.isInteger(e)||e<=0)throw new TypeError("numberOfChannels must be a positive integer.");if(!Number.isInteger(t)||t<=0)throw new TypeError("sampleRate must be a positive integer.");if(!Number.isInteger(r)||r<=0)throw new TypeError("bitrate must be a positive integer.");if(Le.length>0){let a={codec:Zt(n,e,t),numberOfChannels:e,sampleRate:t,bitrate:r,...er(n)};if(Le.some(s=>s.supports(n,a)))return!0}return D.includes(n)?!0:typeof AudioEncoder>"u"?!1:(await AudioEncoder.isConfigSupported({codec:Zt(n,e,t),numberOfChannels:e,sampleRate:t,bitrate:r,...er(n)})).supported===!0},ea=async n=>!!re.includes(n),ln=async()=>{let[n,e,t]=await Promise.all([cr(),lt(),ni()]);return[...n,...e,...t]},cr=async(n=H,e)=>{let t=await Promise.all(n.map(r=>Zr(r,e)));return n.filter((r,i)=>t[i])},lt=async(n=q,e)=>{let t=await Promise.all(n.map(r=>Jr(r,e)));return n.filter((r,i)=>t[i])},ni=async(n=re)=>{let e=await Promise.all(n.map(ea));return n.filter((t,r)=>e[r])};var mt=/(?:(.+?)\n)?((?:\d{2}:)?\d{2}:\d{2}.\d{3})\s+-->\s+((?:\d{2}:)?\d{2}:\d{2}.\d{3})/g,mn=/^WEBVTT(.|\n)*?\n{2}/,$e=/<(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})>/g,dr=class{constructor(e){this.preambleText=null;this.preambleEmitted=!1;this.options=e}parse(e){e=e.replaceAll(`\r
`,`
`).replaceAll("\r",`
`),mt.lastIndex=0;let t;if(!this.preambleText){if(!mn.test(e))throw new Error("WebVTT preamble incorrect.");t=mt.exec(e);let r=e.slice(0,t?.index??e.length).trimEnd();if(!r)throw new Error("No WebVTT preamble provided.");this.preambleText=r,t&&(e=e.slice(t.index),mt.lastIndex=0)}for(;t=mt.exec(e);){let r=e.slice(0,t.index),i=t[1],a=t.index+t[0].length,s=e.indexOf(`
`,a)+1,o=e.slice(a,s).trim(),d=e.indexOf(`

`,a);d===-1&&(d=e.length);let c=ur(t[2]),l=ur(t[3])-c,m=e.slice(s,d).trim();e=e.slice(d).trimStart(),mt.lastIndex=0;let p={timestamp:c/1e3,duration:l/1e3,text:m,identifier:i,settings:o,notes:r},h={};this.preambleEmitted||(h.config={description:this.preambleText},this.preambleEmitted=!0),this.options.output(p,h)}}},fn=/(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})/,ur=n=>{let e=fn.exec(n);if(!e)throw new Error("Expected match.");return 60*60*1e3*Number(e[1]||"0")+60*1e3*Number(e[2])+1e3*Number(e[3])+Number(e[4])},lr=n=>{let e=Math.floor(n/36e5),t=Math.floor(n%(60*60*1e3)/(60*1e3)),r=Math.floor(n%(60*1e3)/1e3),i=n%1e3;return e.toString().padStart(2,"0")+":"+t.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")+"."+i.toString().padStart(3,"0")};var ft=class{constructor(e){this.writer=e;this.helper=new Uint8Array(8);this.helperView=new DataView(this.helper.buffer);this.offsets=new WeakMap}writeU32(e){this.helperView.setUint32(0,e,!1),this.writer.write(this.helper.subarray(0,4))}writeU64(e){this.helperView.setUint32(0,Math.floor(e/2**32),!1),this.helperView.setUint32(4,e,!1),this.writer.write(this.helper.subarray(0,8))}writeAscii(e){for(let t=0;t<e.length;t++)this.helperView.setUint8(t%8,e.charCodeAt(t)),t%8===7&&this.writer.write(this.helper);e.length%8!==0&&this.writer.write(this.helper.subarray(0,e.length%8))}writeBox(e){if(this.offsets.set(e,this.writer.getPos()),e.contents&&!e.children)this.writeBoxHeader(e,e.size??e.contents.byteLength+8),this.writer.write(e.contents);else{let t=this.writer.getPos();if(this.writeBoxHeader(e,0),e.contents&&this.writer.write(e.contents),e.children)for(let a of e.children)a&&this.writeBox(a);let r=this.writer.getPos(),i=e.size??r-t;this.writer.seek(t),this.writeBoxHeader(e,i),this.writer.seek(r)}}writeBoxHeader(e,t){this.writeU32(e.largeSize?1:t),this.writeAscii(e.type),e.largeSize&&this.writeU64(t)}measureBoxHeader(e){return 8+(e.largeSize?8:0)}patchBox(e){let t=this.offsets.get(e);f(t!==void 0);let r=this.writer.getPos();this.writer.seek(t),this.writeBox(e),this.writer.seek(r)}measureBox(e){if(e.contents&&!e.children)return this.measureBoxHeader(e)+e.contents.byteLength;{let t=this.measureBoxHeader(e);if(e.contents&&(t+=e.contents.byteLength),e.children)for(let r of e.children)r&&(t+=this.measureBox(r));return t}}},O=new Uint8Array(8),le=new DataView(O.buffer),B=n=>[(n%256+256)%256],_=n=>(le.setUint16(0,n,!1),[O[0],O[1]]),oi=n=>(le.setInt16(0,n,!1),[O[0],O[1]]),ci=n=>(le.setUint32(0,n,!1),[O[1],O[2],O[3]]),C=n=>(le.setUint32(0,n,!1),[O[0],O[1],O[2],O[3]]),_e=n=>(le.setInt32(0,n,!1),[O[0],O[1],O[2],O[3]]),Re=n=>(le.setUint32(0,Math.floor(n/2**32),!1),le.setUint32(4,n,!1),[O[0],O[1],O[2],O[3],O[4],O[5],O[6],O[7]]),di=n=>(le.setInt16(0,2**8*n,!1),[O[0],O[1]]),Te=n=>(le.setInt32(0,2**16*n,!1),[O[0],O[1],O[2],O[3]]),ta=n=>(le.setInt32(0,2**30*n,!1),[O[0],O[1],O[2],O[3]]),ra=(n,e)=>{let t=[],r=n;do{let i=r&127;r>>=7,t.length>0&&(i|=128),t.push(i),e!==void 0&&e--}while(r>0||e);return t.reverse()},Z=(n,e=!1)=>{let t=Array(n.length).fill(null).map((r,i)=>n.charCodeAt(i));return e&&t.push(0),t},ia=n=>{let e=null;for(let t of n)(!e||t.timestamp>e.timestamp)&&(e=t);return e},ui=n=>{let e=n*(Math.PI/180),t=Math.round(Math.cos(e)),r=Math.round(Math.sin(e));return[t,r,0,-r,t,0,0,0,1]},li=ui(0),mi=n=>[Te(n[0]),Te(n[1]),ta(n[2]),Te(n[3]),Te(n[4]),ta(n[5]),Te(n[6]),Te(n[7]),ta(n[8])],A=(n,e,t)=>({type:n,contents:e&&new Uint8Array(e.flat(10)),children:t}),F=(n,e,t,r,i)=>A(n,[B(e),ci(t),r??[]],i),fi=n=>n.isMov?A("ftyp",[Z("qt  "),C(512),Z("qt  ")]):n.fragmented?A("ftyp",[Z("iso5"),C(512),Z("iso5"),Z("iso6"),Z("mp41")]):A("ftyp",[Z("isom"),C(512),Z("isom"),n.holdsAvc?Z("avc1"):[],Z("mp41")]),fr=n=>({type:"mdat",largeSize:n}),pi=n=>({type:"free",size:n}),pt=(n,e,t=!1)=>A("moov",void 0,[pn(e,n),...n.map(r=>hn(r,e)),t?Yn(n):null]),pn=(n,e)=>{let t=$(Math.max(0,...e.filter(s=>s.samples.length>0).map(s=>{let o=ia(s.samples);return o.timestamp+o.duration})),mr),r=Math.max(0,...e.map(s=>s.track.id))+1,i=!Ae(n)||!Ae(t),a=i?Re:C;return F("mvhd",+i,0,[a(n),a(n),C(mr),a(t),Te(1),di(1),Array(10).fill(0),mi(li),Array(24).fill(0),C(r)])},hn=(n,e)=>A("trak",void 0,[gn(n,e),bn(n,e)]),gn=(n,e)=>{let t=ia(n.samples),r=$(t?t.timestamp+t.duration:0,mr),i=!Ae(e)||!Ae(r),a=i?Re:C,s;if(n.type==="video"){let o=n.track.metadata.rotation;s=ui(o??0)}else s=li;return F("tkhd",+i,3,[a(e),a(e),C(n.track.id),C(0),a(r),Array(8).fill(0),_(0),_(n.track.id),di(n.type==="audio"?1:0),_(0),mi(s),Te(n.type==="video"?n.info.width:0),Te(n.type==="video"?n.info.height:0)])},bn=(n,e)=>A("mdia",void 0,[kn(n,e),Sn(n),yn(n)]),kn=(n,e)=>{let t=ia(n.samples),r=$(t?t.timestamp+t.duration:0,n.timescale),i=!Ae(e)||!Ae(r),a=i?Re:C,s=0;for(let o of n.track.metadata.languageCode??j)s<<=5,s+=o.charCodeAt(0)-96;return F("mdhd",+i,0,[a(e),a(e),C(n.timescale),a(r),_(s),_(0)])},wn={video:"vide",audio:"soun",subtitle:"text"},Tn={video:"VideoHandler",audio:"SoundHandler",subtitle:"TextHandler"},Sn=n=>F("hdlr",0,0,[Z("mhlr"),Z(wn[n.type]),C(0),C(0),C(0),Z(Tn[n.type],!0)]),yn=n=>A("minf",void 0,[In[n.type](),vn(),An(n)]),xn=()=>F("vmhd",0,1,[_(0),_(0),_(0),_(0)]),Cn=()=>F("smhd",0,0,[_(0),_(0)]),Pn=()=>F("nmhd",0,0),In={video:xn,audio:Cn,subtitle:Pn},vn=()=>A("dinf",void 0,[En()]),En=()=>F("dref",0,0,[C(1)],[_n()]),_n=()=>F("url ",0,1),An=n=>{let e=n.compositionTimeOffsetTable.length>1||n.compositionTimeOffsetTable.some(t=>t.sampleCompositionTimeOffset!==0);return A("stbl",void 0,[Rn(n),$n(n),e?jn(n):null,e?Xn(n):null,qn(n),Gn(n),Kn(n),Qn(n)])},Rn=n=>{let e;if(n.type==="video")e=On(ss[n.track.source._codec],n);else if(n.type==="audio"){let t=Ti[n.track.source._codec];f(t),e=zn(t,n)}else n.type==="subtitle"&&(e=Ln(ds[n.track.source._codec],n));return f(e),F("stsd",0,0,[C(1)],[e])},On=(n,e)=>A(n,[Array(6).fill(0),_(1),_(0),_(0),Array(12).fill(0),_(e.info.width),_(e.info.height),C(4718592),C(4718592),C(0),_(1),Array(32).fill(0),_(24),oi(65535)],[os[e.track.source._codec](e),Qt(e.info.decoderConfig.colorSpace)?Fn(e):null]),Fn=n=>A("colr",[Z("nclx"),_(ge[n.info.decoderConfig.colorSpace.primaries]),_(be[n.info.decoderConfig.colorSpace.transfer]),_(ke[n.info.decoderConfig.colorSpace.matrix]),B((n.info.decoderConfig.colorSpace.fullRange?1:0)<<7)]),Mn=n=>n.info.decoderConfig&&A("avcC",[...Q(n.info.decoderConfig.description)]),Dn=n=>n.info.decoderConfig&&A("hvcC",[...Q(n.info.decoderConfig.description)]),si=n=>{if(!n.info.decoderConfig)return null;let e=n.info.decoderConfig,t=e.codec.split("."),r=Number(t[1]),i=Number(t[2]),a=Number(t[3]),s=t[4]?Number(t[4]):1,o=t[8]?Number(t[8]):Number(e.colorSpace?.fullRange??0),d=(a<<4)+(s<<1)+o,c=t[5]?Number(t[5]):e.colorSpace?.primaries?ge[e.colorSpace.primaries]:2,u=t[6]?Number(t[6]):e.colorSpace?.transfer?be[e.colorSpace.transfer]:2,l=t[7]?Number(t[7]):e.colorSpace?.matrix?ke[e.colorSpace.matrix]:2;return F("vpcC",1,0,[B(r),B(i),B(d),B(c),B(u),B(l),_(0)])},Vn=n=>A("av1C",tr(n.info.decoderConfig.codec)),zn=(n,e)=>{let t=0,r,i=16;if(D.includes(e.track.source._codec)){let a=e.track.source._codec,{sampleSize:s}=J(a);i=8*s,i>16&&(t=1)}return t===0?r=[Array(6).fill(0),_(1),_(t),_(0),C(0),_(e.info.numberOfChannels),_(i),_(0),_(0),_(e.info.sampleRate<2**16?e.info.sampleRate:0),_(0)]:r=[Array(6).fill(0),_(1),_(t),_(0),C(0),_(e.info.numberOfChannels),_(Math.min(i,16)),_(0),_(0),_(e.info.sampleRate<2**16?e.info.sampleRate:0),_(0),C(1),C(i/8),C(e.info.numberOfChannels*i/8),C(2)],A(n,r,[cs[e.track.source._codec]?.(e)??null])},aa=n=>{let e;switch(n.track.source._codec){case"aac":e=64;break;case"mp3":e=107;break;case"vorbis":e=221;break;default:throw new Error(`Unhandled audio codec: ${n.track.source._codec}`)}let t=[...B(e),...B(21),...ci(0),...C(0),...C(0)];if(n.info.decoderConfig.description){let r=Q(n.info.decoderConfig.description);t=[...t,...B(5),...ra(r.byteLength),...r]}return t=[..._(1),...B(0),...B(4),...ra(t.length),...t,...B(6),...B(1),...B(2)],t=[...B(3),...ra(t.length),...t],F("esds",0,0,t)},Qe=n=>A("wave",void 0,[Un(n),Bn(n),A("\0\0\0\0")]),Un=n=>A("frma",[Z(Ti[n.track.source._codec])]),Bn=n=>{let{littleEndian:e}=J(n.track.source._codec);return A("enda",[_(+e)])},Nn=n=>{let e=n.info.numberOfChannels,t=3840,r=n.info.sampleRate,i=0,a=0,s=new Uint8Array(0),o=n.info.decoderConfig?.description;if(o){f(o.byteLength>=18);let d=Q(o),c=Ee(d);e=c.outputChannelCount,t=c.preSkip,r=c.inputSampleRate,i=c.outputGain,a=c.channelMappingFamily,c.channelMappingTable&&(s=c.channelMappingTable)}return A("dOps",[B(0),B(e),_(t),C(r),oi(i),B(a),...s])},Wn=n=>{let e=n.info.decoderConfig?.description;f(e);let t=Q(e);return F("dfLa",0,0,[...t.subarray(4)])},Ln=(n,e)=>A(n,[Array(6).fill(0),_(1)],[us[e.track.source._codec](e)]),Hn=n=>A("vttC",[...se.encode(n.info.config.description)]);var $n=n=>F("stts",0,0,[C(n.timeToSampleTable.length),n.timeToSampleTable.map(e=>[C(e.sampleCount),C(e.sampleDelta)])]),Qn=n=>{if(n.samples.every(t=>t.type==="key"))return null;let e=[...n.samples.entries()].filter(([,t])=>t.type==="key");return F("stss",0,0,[C(e.length),e.map(([t])=>C(t+1))])},qn=n=>F("stsc",0,0,[C(n.compactlyCodedChunkTable.length),n.compactlyCodedChunkTable.map(e=>[C(e.firstChunk),C(e.samplesPerChunk),C(1)])]),Gn=n=>{if(n.requiresPcmTransformation){f(n.type==="audio");let{sampleSize:e}=J(n.track.source._codec);return F("stsz",0,0,[C(e*n.info.numberOfChannels),C(n.samples.reduce((t,r)=>t+$(r.duration,n.timescale),0))])}return F("stsz",0,0,[C(0),C(n.samples.length),n.samples.map(e=>C(e.size))])},Kn=n=>n.finalizedChunks.length>0&&M(n.finalizedChunks).offset>=2**32?F("co64",0,0,[C(n.finalizedChunks.length),n.finalizedChunks.map(e=>Re(e.offset))]):F("stco",0,0,[C(n.finalizedChunks.length),n.finalizedChunks.map(e=>C(e.offset))]),jn=n=>F("ctts",1,0,[C(n.compositionTimeOffsetTable.length),n.compositionTimeOffsetTable.map(e=>[C(e.sampleCount),_e(e.sampleCompositionTimeOffset)])]),Xn=n=>{let e=1/0,t=-1/0,r=1/0,i=-1/0;f(n.compositionTimeOffsetTable.length>0),f(n.samples.length>0);for(let s=0;s<n.compositionTimeOffsetTable.length;s++){let o=n.compositionTimeOffsetTable[s];e=Math.min(e,o.sampleCompositionTimeOffset),t=Math.max(t,o.sampleCompositionTimeOffset)}for(let s=0;s<n.samples.length;s++){let o=n.samples[s];r=Math.min(r,$(o.timestamp,n.timescale)),i=Math.max(i,$(o.timestamp+o.duration,n.timescale))}let a=Math.max(-e,0);return i>=2**31?null:F("cslg",0,0,[_e(a),_e(e),_e(t),_e(r),_e(i)])},Yn=n=>A("mvex",void 0,n.map(Zn)),Zn=n=>F("trex",0,0,[C(n.track.id),C(1),C(0),C(0),C(0)]),na=(n,e)=>A("moof",void 0,[Jn(n),...e.map(es)]),Jn=n=>F("mfhd",0,0,[C(n)]),hi=n=>{let e=0,t=0,r=0,i=0,a=n.type==="delta";return t|=+a,a?e|=1:e|=2,e<<24|t<<16|r<<8|i},es=n=>A("traf",void 0,[ts(n),rs(n),as(n)]),ts=n=>{f(n.currentChunk);let e=0;e|=8,e|=16,e|=32,e|=131072;let t=n.currentChunk.samples[1]??n.currentChunk.samples[0],r={duration:t.timescaleUnitsToNextSample,size:t.size,flags:hi(t)};return F("tfhd",0,e,[C(n.track.id),C(r.duration),C(r.size),C(r.flags)])},rs=n=>(f(n.currentChunk),F("tfdt",1,0,[Re($(n.currentChunk.startTimestamp,n.timescale))])),as=n=>{f(n.currentChunk);let e=n.currentChunk.samples.map(b=>b.timescaleUnitsToNextSample),t=n.currentChunk.samples.map(b=>b.size),r=n.currentChunk.samples.map(hi),i=n.currentChunk.samples.map(b=>$(b.timestamp-b.decodeTimestamp,n.timescale)),a=new Set(e),s=new Set(t),o=new Set(r),d=new Set(i),c=o.size===2&&r[0]!==r[1],u=a.size>1,l=s.size>1,m=!c&&o.size>1,p=d.size>1||[...d].some(b=>b!==0),h=0;return h|=1,h|=4*+c,h|=256*+u,h|=512*+l,h|=1024*+m,h|=2048*+p,F("trun",1,h,[C(n.currentChunk.samples.length),C(n.currentChunk.offset-n.currentChunk.moofOffset||0),c?C(r[0]):[],n.currentChunk.samples.map((b,g)=>[u?C(e[g]):[],l?C(t[g]):[],m?C(r[g]):[],p?_e(i[g]):[]])])},gi=n=>A("mfra",void 0,[...n.map(is),ns()]),is=(n,e)=>F("tfra",1,0,[C(n.track.id),C(63),C(n.finalizedChunks.length),n.finalizedChunks.map(r=>[Re($(r.samples[0].timestamp,n.timescale)),Re(r.moofOffset),C(e+1),C(1),C(1)])]),ns=()=>F("mfro",0,0,[C(0)]),bi=()=>A("vtte"),ki=(n,e,t,r,i)=>A("vttc",void 0,[i!==null?A("vsid",[_e(i)]):null,t!==null?A("iden",[...se.encode(t)]):null,e!==null?A("ctim",[...se.encode(lr(e))]):null,r!==null?A("sttg",[...se.encode(r)]):null,A("payl",[...se.encode(n)])]),wi=n=>A("vtta",[...se.encode(n)]),ss={avc:"avc1",hevc:"hvc1",vp8:"vp08",vp9:"vp09",av1:"av01"},os={avc:Mn,hevc:Dn,vp8:si,vp9:si,av1:Vn},Ti={aac:"mp4a",mp3:"mp4a",opus:"Opus",vorbis:"mp4a",flac:"fLaC",ulaw:"ulaw",alaw:"alaw","pcm-u8":"raw ","pcm-s8":"sowt","pcm-s16":"sowt","pcm-s16be":"twos","pcm-s24":"in24","pcm-s24be":"in24","pcm-s32":"in32","pcm-s32be":"in32","pcm-f32":"fl32","pcm-f32be":"fl32"},cs={aac:aa,mp3:aa,opus:Nn,vorbis:aa,flac:Wn,"pcm-s24":Qe,"pcm-s24be":Qe,"pcm-s32":Qe,"pcm-s32be":Qe,"pcm-f32":Qe,"pcm-f32be":Qe},ds={webvtt:"wvtt"},us={webvtt:Hn};var ae=class{constructor(e){this.mutex=new de;this.trackTimestampInfo=new WeakMap;this.output=e}onTrackClose(e){}validateAndNormalizeTimestamp(e,t,r){let i=this.trackTimestampInfo.get(e);if(!i){if(!r)throw new Error("First frame must be a key frame.");i={timestampOffset:t,maxTimestamp:e.source._offsetTimestamps?0:t,maxTimestampBeforeLastKeyFrame:e.source._offsetTimestamps?0:t},this.trackTimestampInfo.set(e,i)}if(e.source._offsetTimestamps&&(t-=i.timestampOffset),t<0)throw new Error(`Timestamps must be non-negative (got ${t}s).`);if(r&&(i.maxTimestampBeforeLastKeyFrame=i.maxTimestamp),t<i.maxTimestampBeforeLastKeyFrame)throw new Error(`Timestamps cannot be smaller than the highest timestamp of the previous run (a run begins with a key frame and ends right before the next key frame). Got ${t}s, but highest timestamp is ${i.maxTimestampBeforeLastKeyFrame}s.`);return i.maxTimestamp=Math.max(i.maxTimestamp,t),t}};var ht=class{constructor(){this.ensureMonotonicity=!1}start(){}},sa=2**16,oa=2**32,qe=class extends ht{constructor(t){super();this.pos=0;this.maxPos=0;if(this.target=t,this.supportsResize="resize"in new ArrayBuffer(0),this.supportsResize)try{this.buffer=new ArrayBuffer(sa,{maxByteLength:oa})}catch{this.buffer=new ArrayBuffer(sa),this.supportsResize=!1}else this.buffer=new ArrayBuffer(sa);this.bytes=new Uint8Array(this.buffer)}ensureSize(t){let r=this.buffer.byteLength;for(;r<t;)r*=2;if(r!==this.buffer.byteLength){if(r>oa)throw new Error(`ArrayBuffer exceeded maximum size of ${oa} bytes. Please consider using another target.`);if(this.supportsResize)this.buffer.resize(r);else{let i=new ArrayBuffer(r),a=new Uint8Array(i);a.set(this.bytes,0),this.buffer=i,this.bytes=a}}}write(t){this.ensureSize(this.pos+t.byteLength),this.bytes.set(t,this.pos),this.pos+=t.byteLength,this.maxPos=Math.max(this.maxPos,this.pos)}seek(t){this.pos=t}getPos(){return this.pos}async flush(){}async finalize(){this.ensureSize(this.pos),this.target.buffer=this.buffer.slice(0,Math.max(this.maxPos,this.pos))}async close(){}getSlice(t,r){return this.bytes.slice(t,r)}},pr=class extends ht{constructor(t){super();this.pos=0;this.sections=[];this.lastFlushEnd=0;this.writer=null;this.target=t}start(){this.writer=this.target._writable.getWriter()}write(t){this.sections.push({data:t.slice(),start:this.pos}),this.pos+=t.byteLength}seek(t){this.pos=t}getPos(){return this.pos}async flush(){if(f(this.writer),this.sections.length===0)return;let t=[],r=[...this.sections].sort((i,a)=>i.start-a.start);t.push({start:r[0].start,size:r[0].data.byteLength});for(let i=1;i<r.length;i++){let a=t[t.length-1],s=r[i];s.start<=a.start+a.size?a.size=Math.max(a.size,s.start+s.data.byteLength-a.start):t.push({start:s.start,size:s.data.byteLength})}for(let i of t){i.data=new Uint8Array(i.size);for(let a of this.sections)i.start<=a.start&&a.start<i.start+i.size&&i.data.set(a.data,a.start-i.start);if(this.ensureMonotonicity&&i.start!==this.lastFlushEnd)throw new Error("Internal error: Monotonicity violation.");this.writer.desiredSize!==null&&this.writer.desiredSize<=0&&await this.writer.ready,this.writer.write({type:"write",data:i.data,position:i.start}),this.lastFlushEnd=i.start+i.data.byteLength}this.sections.length=0}finalize(){return f(this.writer),this.writer.close()}async close(){return this.writer?.close()}},ls=2**24,ms=2,hr=class extends ht{constructor(t){super();this.pos=0;this.chunks=[];this.lastFlushEnd=0;this.writer=null;this.flushedChunkQueue=[];if(this.target=t,this.chunkSize=t._options?.chunkSize??ls,!Number.isInteger(this.chunkSize)||this.chunkSize<2**10)throw new Error("Invalid StreamTarget options: chunkSize must be an integer not smaller than 1024.")}start(){this.writer=this.target._writable.getWriter()}write(t){this.writeDataIntoChunks(t,this.pos),this.queueChunksForFlush(),this.pos+=t.byteLength}seek(t){this.pos=t}getPos(){return this.pos}writeDataIntoChunks(t,r){let i=this.chunks.findIndex(c=>c.start<=r&&r<c.start+this.chunkSize);i===-1&&(i=this.createChunk(r));let a=this.chunks[i],s=r-a.start,o=t.subarray(0,Math.min(this.chunkSize-s,t.byteLength));a.data.set(o,s);let d={start:s,end:s+o.byteLength};if(this.insertSectionIntoChunk(a,d),a.written[0].start===0&&a.written[0].end===this.chunkSize&&(a.shouldFlush=!0),this.chunks.length>ms){for(let c=0;c<this.chunks.length-1;c++)this.chunks[c].shouldFlush=!0;this.queueChunksForFlush()}o.byteLength<t.byteLength&&this.writeDataIntoChunks(t.subarray(o.byteLength),r+o.byteLength)}insertSectionIntoChunk(t,r){let i=0,a=t.written.length-1,s=-1;for(;i<=a;){let o=Math.floor(i+(a-i+1)/2);t.written[o].start<=r.start?(i=o+1,s=o):a=o-1}for(t.written.splice(s+1,0,r),(s===-1||t.written[s].end<r.start)&&s++;s<t.written.length-1&&t.written[s].end>=t.written[s+1].start;)t.written[s].end=Math.max(t.written[s].end,t.written[s+1].end),t.written.splice(s+1,1)}createChunk(t){let i={start:Math.floor(t/this.chunkSize)*this.chunkSize,data:new Uint8Array(this.chunkSize),written:[],shouldFlush:!1};return this.chunks.push(i),this.chunks.sort((a,s)=>a.start-s.start),this.chunks.indexOf(i)}queueChunksForFlush(t=!1){f(this.writer);for(let r=0;r<this.chunks.length;r++){let i=this.chunks[r];if(!(!i.shouldFlush&&!t)){for(let a of i.written){if(this.ensureMonotonicity&&i.start+a.start!==this.lastFlushEnd)throw new Error("Internal error: Monotonicity violation.");this.flushedChunkQueue.push({type:"write",data:i.data.subarray(a.start,a.end),position:i.start+a.start}),this.lastFlushEnd=i.start+a.end}this.chunks.splice(r--,1)}}}async flush(){if(f(this.writer),this.flushedChunkQueue.length!==0){for(let t of this.flushedChunkQueue)this.writer.desiredSize!==null&&this.writer.desiredSize<=0&&await this.writer.ready,this.writer.write(t);this.flushedChunkQueue.length=0}}async finalize(){return f(this.writer),this.queueChunksForFlush(!0),await this.flush(),this.writer.close()}async close(){return this.writer?.close()}};var Oe=class{constructor(){this._output=null}},gt=class extends Oe{constructor(){super(...arguments);this.buffer=null}_createWriter(){return new qe(this)}},ca=class extends Oe{constructor(e,t={}){if(super(),!(e instanceof WritableStream))throw new TypeError("StreamTarget requires a WritableStream instance.");if(t!=null&&typeof t!="object")throw new TypeError("StreamTarget options, when provided, must be an object.");if(t.chunked!==void 0&&typeof t.chunked!="boolean")throw new TypeError("options.chunked, when provided, must be a boolean.");if(t.chunkSize!==void 0&&(!Number.isInteger(t.chunkSize)||t.chunkSize<=0))throw new TypeError("options.chunkSize, when provided, must be a positive integer.");this._writable=e,this._options=t}_createWriter(){return this._options.chunked?new hr(this):new pr(this)}};var mr=1e3,fs=2082844800,$=(n,e,t=!0)=>{let r=n*e;return t?Math.round(r):r},gr=class extends ae{constructor(t,r){super(t);this.auxTarget=new gt;this.auxWriter=this.auxTarget._createWriter();this.auxBoxWriter=new ft(this.auxWriter);this.ftypSize=null;this.mdat=null;this.trackDatas=[];this.creationTime=Math.floor(Date.now()/1e3)+fs;this.finalizedChunks=[];this.nextFragmentNumber=1;this.maxWrittenTimestamp=-1/0;this.writer=t._writer,this.boxWriter=new ft(this.writer),this.isMov=r instanceof Ge;let i=this.writer instanceof qe?"in-memory":!1;this.fastStart=r._options.fastStart??i,this.isFragmented=this.fastStart==="fragmented",(this.fastStart==="in-memory"||this.isFragmented)&&(this.writer.ensureMonotonicity=!0)}async start(){let t=await this.mutex.acquire(),r=this.output._tracks.some(i=>i.type==="video"&&i.source._codec==="avc");this.boxWriter.writeBox(fi({isMov:this.isMov,holdsAvc:r,fragmented:this.isFragmented})),this.ftypSize=this.writer.getPos(),this.fastStart==="in-memory"?this.mdat=fr(!1):this.isFragmented||(this.mdat=fr(!0),this.boxWriter.writeBox(this.mdat)),await this.writer.flush(),t()}getVideoTrackData(t,r){let i=this.trackDatas.find(s=>s.track===t);if(i)return i;nr(r),f(r),f(r.decoderConfig),f(r.decoderConfig.codedWidth!==void 0),f(r.decoderConfig.codedHeight!==void 0);let a={track:t,type:"video",info:{width:r.decoderConfig.codedWidth,height:r.decoderConfig.codedHeight,decoderConfig:r.decoderConfig},timescale:t.metadata.frameRate??57600,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[],requiresPcmTransformation:!1};return this.trackDatas.push(a),this.trackDatas.sort((s,o)=>s.track.id-o.track.id),a}getAudioTrackData(t,r){let i=this.trackDatas.find(s=>s.track===t);if(i)return i;sr(r),f(r),f(r.decoderConfig);let a={track:t,type:"audio",info:{numberOfChannels:r.decoderConfig.numberOfChannels,sampleRate:r.decoderConfig.sampleRate,decoderConfig:r.decoderConfig},timescale:r.decoderConfig.sampleRate,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[],requiresPcmTransformation:!this.isFragmented&&D.includes(t.source._codec)};return this.trackDatas.push(a),this.trackDatas.sort((s,o)=>s.track.id-o.track.id),a}getSubtitleTrackData(t,r){let i=this.trackDatas.find(s=>s.track===t);if(i)return i;or(r),f(r),f(r.config);let a={track:t,type:"subtitle",info:{config:r.config},timescale:1e3,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[],requiresPcmTransformation:!1,lastCueEndTimestamp:0,cueQueue:[],nextSourceId:0,cueToSourceId:new WeakMap};return this.trackDatas.push(a),this.trackDatas.sort((s,o)=>s.track.id-o.track.id),a}async addEncodedVideoPacket(t,r,i){let a=await this.mutex.acquire();try{let s=this.getVideoTrackData(t,i),o=this.validateAndNormalizeTimestamp(s.track,r.timestamp,r.type==="key"),d=this.createSampleForTrack(s,r.data,o,r.duration,r.type);await this.registerSample(s,d)}finally{a()}}async addEncodedAudioPacket(t,r,i){let a=await this.mutex.acquire();try{let s=this.getAudioTrackData(t,i),o=this.validateAndNormalizeTimestamp(s.track,r.timestamp,r.type==="key"),d=this.createSampleForTrack(s,r.data,o,r.duration,r.type);s.requiresPcmTransformation&&await this.maybePadWithSilence(s,o),await this.registerSample(s,d)}finally{a()}}async maybePadWithSilence(t,r){let i=M(t.samples),a=i?i.timestamp+i.duration:0,s=r-a,o=$(s,t.timescale);if(o>0){let{sampleSize:d,silentValue:c}=J(t.info.decoderConfig.codec),u=o*t.info.numberOfChannels,l=new Uint8Array(d*u).fill(c),m=this.createSampleForTrack(t,new Uint8Array(l.buffer),a,s,"key");await this.registerSample(t,m)}}async addSubtitleCue(t,r,i){let a=await this.mutex.acquire();try{let s=this.getSubtitleTrackData(t,i);this.validateAndNormalizeTimestamp(s.track,r.timestamp,!0),t.source._codec==="webvtt"&&(s.cueQueue.push(r),await this.processWebVTTCues(s,r.timestamp))}finally{a()}}async processWebVTTCues(t,r){for(;t.cueQueue.length>0;){let i=new Set([]);for(let u of t.cueQueue)f(u.timestamp<=r),f(t.lastCueEndTimestamp<=u.timestamp+u.duration),i.add(Math.max(u.timestamp,t.lastCueEndTimestamp)),i.add(u.timestamp+u.duration);let a=[...i].sort((u,l)=>u-l),s=a[0],o=a[1]??s;if(r<o)break;if(t.lastCueEndTimestamp<s){this.auxWriter.seek(0);let u=bi();this.auxBoxWriter.writeBox(u);let l=this.auxWriter.getSlice(0,this.auxWriter.getPos()),m=this.createSampleForTrack(t,l,t.lastCueEndTimestamp,s-t.lastCueEndTimestamp,"key");await this.registerSample(t,m),t.lastCueEndTimestamp=s}this.auxWriter.seek(0);for(let u=0;u<t.cueQueue.length;u++){let l=t.cueQueue[u];if(l.timestamp>=o)break;$e.lastIndex=0;let m=$e.test(l.text),p=l.timestamp+l.duration,h=t.cueToSourceId.get(l);if(h===void 0&&o<p&&(h=t.nextSourceId++,t.cueToSourceId.set(l,h)),l.notes){let g=wi(l.notes);this.auxBoxWriter.writeBox(g)}let b=ki(l.text,m?s:null,l.identifier??null,l.settings??null,h??null);this.auxBoxWriter.writeBox(b),p===o&&t.cueQueue.splice(u--,1)}let d=this.auxWriter.getSlice(0,this.auxWriter.getPos()),c=this.createSampleForTrack(t,d,s,o-s,"key");await this.registerSample(t,c),t.lastCueEndTimestamp=o}}createSampleForTrack(t,r,i,a,s){return{timestamp:i,decodeTimestamp:i,duration:a,data:r,size:r.byteLength,type:s,timescaleUnitsToNextSample:$(a,t.timescale)}}processTimestamps(t){if(t.timestampProcessingQueue.length===0)return;if(t.requiresPcmTransformation){let i=0;for(let a=0;a<t.timestampProcessingQueue.length;a++){let s=t.timestampProcessingQueue[a],o=$(s.duration,t.timescale);i+=o}if(t.timeToSampleTable.length===0)t.timeToSampleTable.push({sampleCount:i,sampleDelta:1});else{let a=M(t.timeToSampleTable);a.sampleCount+=i}t.timestampProcessingQueue.length=0;return}let r=t.timestampProcessingQueue.map(i=>i.timestamp).sort((i,a)=>i-a);for(let i=0;i<t.timestampProcessingQueue.length;i++){let a=t.timestampProcessingQueue[i];a.decodeTimestamp=r[i],!this.isFragmented&&t.lastTimescaleUnits===null&&(a.decodeTimestamp=0);let s=$(a.timestamp-a.decodeTimestamp,t.timescale),o=$(a.duration,t.timescale);if(t.lastTimescaleUnits!==null){f(t.lastSample);let d=$(a.decodeTimestamp,t.timescale,!1),c=Math.round(d-t.lastTimescaleUnits);if(f(c>=0),t.lastTimescaleUnits+=c,t.lastSample.timescaleUnitsToNextSample=c,!this.isFragmented){let u=M(t.timeToSampleTable);if(f(u),u.sampleCount===1){u.sampleDelta=c;let m=t.timeToSampleTable[t.timeToSampleTable.length-2];m&&m.sampleDelta===c&&(m.sampleCount++,t.timeToSampleTable.pop(),u=m)}else u.sampleDelta!==c&&(u.sampleCount--,t.timeToSampleTable.push(u={sampleCount:1,sampleDelta:c}));u.sampleDelta===o?u.sampleCount++:t.timeToSampleTable.push({sampleCount:1,sampleDelta:o});let l=M(t.compositionTimeOffsetTable);f(l),l.sampleCompositionTimeOffset===s?l.sampleCount++:t.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:s})}}else t.lastTimescaleUnits=$(a.decodeTimestamp,t.timescale,!1),this.isFragmented||(t.timeToSampleTable.push({sampleCount:1,sampleDelta:o}),t.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:s}));t.lastSample=a}t.timestampProcessingQueue.length=0}async registerSample(t,r){this.isFragmented?(t.sampleQueue.push(r),await this.interleaveSamples()):await this.addSampleToTrack(t,r)}async addSampleToTrack(t,r){r.type==="key"&&this.processTimestamps(t),this.isFragmented||t.samples.push(r);let i=!1;if(!t.currentChunk)i=!0;else{let a=r.timestamp-t.currentChunk.startTimestamp;if(this.isFragmented){let s=this.trackDatas.every(o=>{if(t===o)return r.type==="key";let d=o.sampleQueue[0];return d?d.type==="key":o.track.source._closed});a>=1&&s&&r.timestamp>this.maxWrittenTimestamp&&(i=!0,await this.finalizeFragment())}else i=a>=.5}i&&(t.currentChunk&&await this.finalizeCurrentChunk(t),t.currentChunk={startTimestamp:r.timestamp,samples:[],offset:null,moofOffset:null}),f(t.currentChunk),t.currentChunk.samples.push(r),t.timestampProcessingQueue.push(r),this.isFragmented&&(this.maxWrittenTimestamp=Math.max(this.maxWrittenTimestamp,r.timestamp))}async finalizeCurrentChunk(t){if(f(!this.isFragmented),!t.currentChunk)return;t.finalizedChunks.push(t.currentChunk),this.finalizedChunks.push(t.currentChunk);let r=t.currentChunk.samples.length;if(t.requiresPcmTransformation&&(r=t.currentChunk.samples.reduce((i,a)=>i+$(a.duration,t.timescale),0)),(t.compactlyCodedChunkTable.length===0||M(t.compactlyCodedChunkTable).samplesPerChunk!==r)&&t.compactlyCodedChunkTable.push({firstChunk:t.finalizedChunks.length,samplesPerChunk:r}),this.fastStart==="in-memory"){t.currentChunk.offset=0;return}t.currentChunk.offset=this.writer.getPos();for(let i of t.currentChunk.samples)f(i.data),this.writer.write(i.data),i.data=null;await this.writer.flush()}async interleaveSamples(t=!1){if(f(this.isFragmented),!t){for(let r of this.output._tracks)if(!r.source._closed&&!this.trackDatas.some(i=>i.track===r))return}e:for(;;){let r=null,i=1/0;for(let s of this.trackDatas){if(!t&&s.sampleQueue.length===0&&!s.track.source._closed)break e;s.sampleQueue.length>0&&s.sampleQueue[0].timestamp<i&&(r=s,i=s.sampleQueue[0].timestamp)}if(!r)break;let a=r.sampleQueue.shift();await this.addSampleToTrack(r,a)}}async finalizeFragment(t=!0){f(this.isFragmented);let r=this.nextFragmentNumber++;if(r===1){let c=pt(this.trackDatas,this.creationTime,!0);this.boxWriter.writeBox(c)}let i=this.trackDatas.filter(c=>c.currentChunk),a=this.writer.getPos(),s=na(r,i);this.boxWriter.writeBox(s);{let c=fr(!1),u=0;for(let m of i)for(let p of m.currentChunk.samples)u+=p.size;let l=this.boxWriter.measureBox(c)+u;l>=2**32&&(c.largeSize=!0,l=this.boxWriter.measureBox(c)+u),c.size=l,this.boxWriter.writeBox(c)}for(let c of i){c.currentChunk.offset=this.writer.getPos(),c.currentChunk.moofOffset=a;for(let u of c.currentChunk.samples)this.writer.write(u.data),u.data=null}let o=this.writer.getPos();this.writer.seek(this.boxWriter.offsets.get(s));let d=na(r,i);this.boxWriter.writeBox(d),this.writer.seek(o);for(let c of i)c.finalizedChunks.push(c.currentChunk),this.finalizedChunks.push(c.currentChunk),c.currentChunk=null;t&&await this.writer.flush()}async onTrackClose(t){let r=await this.mutex.acquire();if(t.type==="subtitle"&&t.source._codec==="webvtt"){let i=this.trackDatas.find(a=>a.track===t);i&&await this.processWebVTTCues(i,1/0)}this.isFragmented&&await this.interleaveSamples(),r()}async finalize(){let t=await this.mutex.acquire();for(let r of this.trackDatas)r.type==="subtitle"&&r.track.source._codec==="webvtt"&&await this.processWebVTTCues(r,1/0);if(this.isFragmented)await this.interleaveSamples(!0),await this.finalizeFragment(!1);else for(let r of this.trackDatas)this.processTimestamps(r),await this.finalizeCurrentChunk(r);if(this.fastStart==="in-memory"){f(this.mdat);let r;for(let a=0;a<2;a++){let s=pt(this.trackDatas,this.creationTime),o=this.boxWriter.measureBox(s);r=this.boxWriter.measureBox(this.mdat);let d=this.writer.getPos()+o+r;for(let c of this.finalizedChunks){c.offset=d;for(let{data:u}of c.samples)f(u),d+=u.byteLength,r+=u.byteLength}if(d<2**32)break;r>=2**32&&(this.mdat.largeSize=!0)}let i=pt(this.trackDatas,this.creationTime);this.boxWriter.writeBox(i),this.mdat.size=r,this.boxWriter.writeBox(this.mdat);for(let a of this.finalizedChunks)for(let s of a.samples)f(s.data),this.writer.write(s.data),s.data=null}else if(this.isFragmented){let r=this.writer.getPos(),i=gi(this.trackDatas);this.boxWriter.writeBox(i);let a=this.writer.getPos()-r;this.writer.seek(this.writer.getPos()-4),this.boxWriter.writeU32(a)}else{f(this.mdat),f(this.ftypSize!==null);let r=this.boxWriter.offsets.get(this.mdat);f(r!==void 0);let i=this.writer.getPos()-r;this.mdat.size=i,this.mdat.largeSize=i>=2**32,this.boxWriter.patchBox(this.mdat);let a=pt(this.trackDatas,this.creationTime);if(typeof this.fastStart=="object"){this.writer.seek(this.ftypSize),this.boxWriter.writeBox(a);let s=r-this.writer.getPos();this.boxWriter.writeBox(pi(s))}else this.boxWriter.writeBox(a)}t()}};var Ke=class{constructor(e){this.value=e}},je=class{constructor(e){this.value=e}},bt=class{constructor(e){this.value=e}};var Si=n=>n<256?1:n<65536?2:n<1<<24?3:n<2**32?4:n<2**40?5:6,yi=n=>n>=-64&&n<64?1:n>=-8192&&n<8192?2:n>=-(1<<20)&&n<1<<20?3:n>=-(1<<27)&&n<1<<27?4:n>=-(2**34)&&n<2**34?5:6,ps=n=>{if(n<127)return 1;if(n<16383)return 2;if(n<(1<<21)-1)return 3;if(n<(1<<28)-1)return 4;if(n<2**35-1)return 5;if(n<2**42-1)return 6;throw new Error("EBML varint size not supported "+n)},br=class{constructor(e){this.writer=e;this.helper=new Uint8Array(8);this.helperView=new DataView(this.helper.buffer);this.offsets=new WeakMap;this.dataOffsets=new WeakMap}writeByte(e){this.helperView.setUint8(0,e),this.writer.write(this.helper.subarray(0,1))}writeFloat32(e){this.helperView.setFloat32(0,e,!1),this.writer.write(this.helper.subarray(0,4))}writeFloat64(e){this.helperView.setFloat64(0,e,!1),this.writer.write(this.helper)}writeUnsignedInt(e,t=Si(e)){let r=0;switch(t){case 6:this.helperView.setUint8(r++,e/2**40|0);case 5:this.helperView.setUint8(r++,e/2**32|0);case 4:this.helperView.setUint8(r++,e>>24);case 3:this.helperView.setUint8(r++,e>>16);case 2:this.helperView.setUint8(r++,e>>8);case 1:this.helperView.setUint8(r++,e);break;default:throw new Error("Bad unsigned int size "+t)}this.writer.write(this.helper.subarray(0,r))}writeSignedInt(e,t=yi(e)){e<0&&(e+=2**(t*8)),this.writeUnsignedInt(e,t)}writeVarInt(e,t=ps(e)){let r=0;switch(t){case 1:this.helperView.setUint8(r++,128|e);break;case 2:this.helperView.setUint8(r++,64|e>>8),this.helperView.setUint8(r++,e);break;case 3:this.helperView.setUint8(r++,32|e>>16),this.helperView.setUint8(r++,e>>8),this.helperView.setUint8(r++,e);break;case 4:this.helperView.setUint8(r++,16|e>>24),this.helperView.setUint8(r++,e>>16),this.helperView.setUint8(r++,e>>8),this.helperView.setUint8(r++,e);break;case 5:this.helperView.setUint8(r++,8|e/2**32&7),this.helperView.setUint8(r++,e>>24),this.helperView.setUint8(r++,e>>16),this.helperView.setUint8(r++,e>>8),this.helperView.setUint8(r++,e);break;case 6:this.helperView.setUint8(r++,4|e/2**40&3),this.helperView.setUint8(r++,e/2**32|0),this.helperView.setUint8(r++,e>>24),this.helperView.setUint8(r++,e>>16),this.helperView.setUint8(r++,e>>8),this.helperView.setUint8(r++,e);break;default:throw new Error("Bad EBML varint size "+t)}this.writer.write(this.helper.subarray(0,r))}writeString(e){this.writer.write(new Uint8Array(e.split("").map(t=>t.charCodeAt(0))))}writeEBML(e){if(e!==null){if(e instanceof Uint8Array)this.writer.write(e);else if(Array.isArray(e))for(let t of e)this.writeEBML(t);else if(this.offsets.set(e,this.writer.getPos()),this.writeUnsignedInt(e.id),Array.isArray(e.data)){let t=this.writer.getPos(),r=e.size===-1?1:e.size??4;e.size===-1?this.writeByte(255):this.writer.seek(this.writer.getPos()+r);let i=this.writer.getPos();if(this.dataOffsets.set(e,i),this.writeEBML(e.data),e.size!==-1){let a=this.writer.getPos()-i,s=this.writer.getPos();this.writer.seek(t),this.writeVarInt(a,r),this.writer.seek(s)}}else if(typeof e.data=="number"){let t=e.size??Si(e.data);this.writeVarInt(t),this.writeUnsignedInt(e.data,t)}else if(typeof e.data=="string")this.writeVarInt(e.data.length),this.writeString(e.data);else if(e.data instanceof Uint8Array)this.writeVarInt(e.data.byteLength,e.size),this.writer.write(e.data);else if(e.data instanceof Ke)this.writeVarInt(4),this.writeFloat32(e.data.value);else if(e.data instanceof je)this.writeVarInt(8),this.writeFloat64(e.data.value);else if(e.data instanceof bt){let t=e.size??yi(e.data.value);this.writeVarInt(t),this.writeSignedInt(e.data.value,t)}}}},xi=8,da=2,kt=4+xi,Fe=class{constructor(e){this.reader=e;this.pos=0}readBytes(e){let{view:t,offset:r}=this.reader.getViewAndOffset(this.pos,this.pos+e);return this.pos+=e,new Uint8Array(t.buffer,r,e)}readU8(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+1);return this.pos++,e.getUint8(t)}readS16(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+2);return this.pos+=2,e.getInt16(t,!1)}readVarIntSize(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+1),r=e.getUint8(t),i=1,a=128;for(;(r&a)===0&&i<8;)i++,a>>=1;return i}readVarInt(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+1),r=e.getUint8(t),i=1,a=128;for(;(r&a)===0&&i<xi;)i++,a>>=1;let{view:s,offset:o}=this.reader.getViewAndOffset(this.pos,this.pos+i),d=r&a-1;for(let c=1;c<i;c++)d=d<<8|s.getUint8(o+c);return this.pos+=i,d}readUnsignedInt(e){if(e<1||e>8)throw new Error("Bad unsigned int size "+e);let{view:t,offset:r}=this.reader.getViewAndOffset(this.pos,this.pos+e),i=0;for(let a=0;a<e;a++)i=i<<8|t.getUint8(r+a);return this.pos+=e,i}readSignedInt(e){let t=this.readUnsignedInt(e);return t&1<<e*8-1&&(t-=2**(e*8)),t}readFloat(e){if(e===0)return 0;if(e!==4&&e!==8)throw new Error("Bad float size "+e);let{view:t,offset:r}=this.reader.getViewAndOffset(this.pos,this.pos+e),i=e===4?t.getFloat32(r,!1):t.getFloat64(r,!1);return this.pos+=e,i}readString(e){let{view:t,offset:r}=this.reader.getViewAndOffset(this.pos,this.pos+e);return this.pos+=e,String.fromCharCode(...new Uint8Array(t.buffer,r,e))}readElementId(){let e=this.readVarIntSize();return this.readUnsignedInt(e)}readElementSize(){let e=this.readU8();return e===255?e=-1:(this.pos--,e=this.readVarInt()),e}readElementHeader(){let e=this.readElementId(),t=this.readElementSize();return{id:e,size:t}}},ee={avc:"V_MPEG4/ISO/AVC",hevc:"V_MPEGH/ISO/HEVC",vp8:"V_VP8",vp9:"V_VP9",av1:"V_AV1",aac:"A_AAC",mp3:"A_MPEG/L3",opus:"A_OPUS",vorbis:"A_VORBIS",flac:"A_FLAC","pcm-u8":"A_PCM/INT/LIT","pcm-s16":"A_PCM/INT/LIT","pcm-s16be":"A_PCM/INT/BIG","pcm-s24":"A_PCM/INT/LIT","pcm-s24be":"A_PCM/INT/BIG","pcm-s32":"A_PCM/INT/LIT","pcm-s32be":"A_PCM/INT/BIG","pcm-f32":"A_PCM/FLOAT/IEEE",webvtt:"S_TEXT/WEBVTT"};var ua=2**15,Ci="https://github.com/Vanilagy/webm-muxer",Pi=6,Ii=5,hs={video:1,audio:2,subtitle:17},kr=class extends ae{constructor(t,r){super(t);this.trackDatas=[];this.segment=null;this.segmentInfo=null;this.seekHead=null;this.tracksElement=null;this.segmentDuration=null;this.cues=null;this.currentCluster=null;this.currentClusterStartMsTimestamp=null;this.currentClusterMaxMsTimestamp=null;this.trackDatasInCurrentCluster=new Map;this.duration=0;this.writer=t._writer,this.format=r,this.ebmlWriter=new br(this.writer),this.format._options.streamable&&(this.writer.ensureMonotonicity=!0)}async start(){let t=await this.mutex.acquire();this.writeEBMLHeader(),this.format._options.streamable||this.createSeekHead(),this.createSegmentInfo(),this.createCues(),await this.writer.flush(),t()}writeEBMLHeader(){let t={id:440786851,data:[{id:17030,data:1},{id:17143,data:1},{id:17138,data:4},{id:17139,data:8},{id:17026,data:this.format instanceof wt?"webm":"matroska"},{id:17031,data:2},{id:17029,data:2}]};this.ebmlWriter.writeEBML(t)}createSeekHead(){let t=new Uint8Array([28,83,187,107]),r=new Uint8Array([21,73,169,102]),i=new Uint8Array([22,84,174,107]),a={id:290298740,data:[{id:19899,data:[{id:21419,data:t},{id:21420,size:5,data:0}]},{id:19899,data:[{id:21419,data:r},{id:21420,size:5,data:0}]},{id:19899,data:[{id:21419,data:i},{id:21420,size:5,data:0}]}]};this.seekHead=a}createSegmentInfo(){let t={id:17545,data:new je(0)};this.segmentDuration=t;let r={id:357149030,data:[{id:2807729,data:1e6},{id:19840,data:Ci},{id:22337,data:Ci},this.format._options.streamable?null:t]};this.segmentInfo=r}createTracks(){let t={id:374648427,data:[]};this.tracksElement=t;for(let r of this.trackDatas){let i=ee[r.track.source._codec];f(i);let a=0;if(r.type==="audio"&&r.track.source._codec==="opus"){a=1e6*80;let s=r.info.decoderConfig.description;if(s){let o=Q(s),d=Ee(o);a=Math.round(1e9*(d.preSkip/He))}}t.data.push({id:174,data:[{id:215,data:r.track.id},{id:29637,data:r.track.id},{id:131,data:hs[r.type]},{id:156,data:0},{id:2274716,data:r.track.metadata.languageCode??j},{id:134,data:i},{id:22186,data:0},{id:22203,data:a},r.type==="video"?this.videoSpecificTrackInfo(r):null,r.type==="audio"?this.audioSpecificTrackInfo(r):null,r.type==="subtitle"?this.subtitleSpecificTrackInfo(r):null]})}}videoSpecificTrackInfo(t){let{frameRate:r,rotation:i}=t.track.metadata,a=[t.info.decoderConfig.description?{id:25506,data:Q(t.info.decoderConfig.description)}:null,r?{id:2352003,data:1e9/r}:null],s=i?Ie(-i):0,o=t.info.decoderConfig.colorSpace,d={id:224,data:[{id:176,data:t.info.width},{id:186,data:t.info.height},Qt(o)?{id:21936,data:[{id:21937,data:ke[o.matrix]},{id:21946,data:be[o.transfer]},{id:21947,data:ge[o.primaries]},{id:21945,data:o.fullRange?2:1}]}:null,s?{id:30320,data:[{id:30321,data:0},{id:30325,data:new Ke((s+180)%360-180)}]}:null]};return a.push(d),a}audioSpecificTrackInfo(t){let r=D.includes(t.track.source._codec)?J(t.track.source._codec):null;return[t.info.decoderConfig.description?{id:25506,data:Q(t.info.decoderConfig.description)}:null,{id:225,data:[{id:181,data:new Ke(t.info.sampleRate)},{id:159,data:t.info.numberOfChannels},r?{id:25188,data:8*r.sampleSize}:null]}]}subtitleSpecificTrackInfo(t){return[{id:25506,data:se.encode(t.info.config.description)}]}createSegment(){let t={id:408125543,size:this.format._options.streamable?-1:Pi,data:[this.format._options.streamable?null:this.seekHead,this.segmentInfo,this.tracksElement]};this.segment=t,this.ebmlWriter.writeEBML(t)}createCues(){this.cues={id:475249515,data:[]}}get segmentDataOffset(){return f(this.segment),this.ebmlWriter.dataOffsets.get(this.segment)}getVideoTrackData(t,r){let i=this.trackDatas.find(s=>s.track===t);if(i)return i;nr(r),f(r),f(r.decoderConfig),f(r.decoderConfig.codedWidth!==void 0),f(r.decoderConfig.codedHeight!==void 0);let a={track:t,type:"video",info:{width:r.decoderConfig.codedWidth,height:r.decoderConfig.codedHeight,decoderConfig:r.decoderConfig},chunkQueue:[],lastWrittenMsTimestamp:null};return t.source._codec==="av1"&&(a.info.decoderConfig={...a.info.decoderConfig,description:new Uint8Array(tr(a.info.decoderConfig.codec))}),this.trackDatas.push(a),this.trackDatas.sort((s,o)=>s.track.id-o.track.id),a}getAudioTrackData(t,r){let i=this.trackDatas.find(s=>s.track===t);if(i)return i;sr(r),f(r),f(r.decoderConfig);let a={track:t,type:"audio",info:{numberOfChannels:r.decoderConfig.numberOfChannels,sampleRate:r.decoderConfig.sampleRate,decoderConfig:r.decoderConfig},chunkQueue:[],lastWrittenMsTimestamp:null};return this.trackDatas.push(a),this.trackDatas.sort((s,o)=>s.track.id-o.track.id),a}getSubtitleTrackData(t,r){let i=this.trackDatas.find(s=>s.track===t);if(i)return i;or(r),f(r),f(r.config);let a={track:t,type:"subtitle",info:{config:r.config},chunkQueue:[],lastWrittenMsTimestamp:null};return this.trackDatas.push(a),this.trackDatas.sort((s,o)=>s.track.id-o.track.id),a}async addEncodedVideoPacket(t,r,i){let a=await this.mutex.acquire();try{let s=this.getVideoTrackData(t,i),o=r.type==="key",d=this.validateAndNormalizeTimestamp(s.track,r.timestamp,o),c=this.createInternalChunk(r.data,d,r.duration,r.type);t.source._codec==="vp9"&&this.fixVP9ColorSpace(s,c),s.chunkQueue.push(c),await this.interleaveChunks()}finally{a()}}async addEncodedAudioPacket(t,r,i){let a=await this.mutex.acquire();try{let s=this.getAudioTrackData(t,i),o=r.type==="key",d=this.validateAndNormalizeTimestamp(s.track,r.timestamp,o),c=this.createInternalChunk(r.data,d,r.duration,r.type);s.chunkQueue.push(c),await this.interleaveChunks()}finally{a()}}async addSubtitleCue(t,r,i){let a=await this.mutex.acquire();try{let s=this.getSubtitleTrackData(t,i),o=this.validateAndNormalizeTimestamp(s.track,r.timestamp,!0),d=r.text,c=Math.round(o*1e3);$e.lastIndex=0,d=d.replace($e,p=>{let b=ur(p.slice(1,-1))-c;return`<${lr(b)}>`});let u=se.encode(d),l=`${r.settings??""}
${r.identifier??""}
${r.notes??""}`,m=this.createInternalChunk(u,o,r.duration,"key",l.trim()?se.encode(l):null);s.chunkQueue.push(m),await this.interleaveChunks()}finally{a()}}async interleaveChunks(t=!1){if(!t){for(let r of this.output._tracks)if(!r.source._closed&&!this.trackDatas.some(i=>i.track===r))return}e:for(;;){let r=null,i=1/0;for(let s of this.trackDatas){if(!t&&s.chunkQueue.length===0&&!s.track.source._closed)break e;s.chunkQueue.length>0&&s.chunkQueue[0].timestamp<i&&(r=s,i=s.chunkQueue[0].timestamp)}if(!r)break;let a=r.chunkQueue.shift();this.writeBlock(r,a)}t||await this.writer.flush()}fixVP9ColorSpace(t,r){if(r.type!=="key"||!t.info.decoderConfig.colorSpace||!t.info.decoderConfig.colorSpace.matrix)return;let i=0;if(v(r.data,0,2)!==2)return;i+=2;let a=(v(r.data,i+1,i+2)<<1)+v(r.data,i+0,i+1);i+=2,a===3&&i++;let s=v(r.data,i+0,i+1);if(i++,s)return;let o=v(r.data,i+0,i+1);if(i++,o!==0)return;i+=2;let d=v(r.data,i+0,i+24);if(i+=24,d!==4817730)return;a>=2&&i++;let c={rgb:7,bt709:2,bt470bg:1,smpte170m:3}[t.info.decoderConfig.colorSpace.matrix];Ha(r.data,i+0,i+3,c)}createInternalChunk(t,r,i,a,s=null){return{data:t,type:a,timestamp:r,duration:i,additions:s}}writeBlock(t,r){this.segment||(this.createTracks(),this.createSegment());let i=Math.round(1e3*r.timestamp),a=this.trackDatas.every(l=>{if(t===l)return r.type==="key";let m=l.chunkQueue[0];return m?m.type==="key":l.track.source._closed});(!this.currentCluster||a&&i>this.currentClusterMaxMsTimestamp&&i-this.currentClusterStartMsTimestamp>=1e3)&&this.createNewCluster(i);let s=i-this.currentClusterStartMsTimestamp;if(s<-(2**15))return;if(s>=ua)throw new Error(`Current Matroska cluster exceeded its maximum allowed length of ${ua} milliseconds. In order to produce a correct WebM file, you must pass in a key frame at least every ${ua} milliseconds.`);let d=new Uint8Array(4),c=new DataView(d.buffer);c.setUint8(0,128|t.track.id),c.setInt16(1,s,!1);let u=Math.round(1e3*r.duration);if(u===0&&!r.additions){c.setUint8(3,+(r.type==="key")<<7);let l={id:163,data:[d,r.data]};this.ebmlWriter.writeEBML(l)}else{let l={id:160,data:[{id:161,data:[d,r.data]},r.type==="delta"?{id:251,data:new bt(t.lastWrittenMsTimestamp-i)}:null,r.additions?{id:30113,data:[{id:166,data:[{id:165,data:r.additions},{id:238,data:1}]}]}:null,u>0?{id:155,data:u}:null]};this.ebmlWriter.writeEBML(l)}this.duration=Math.max(this.duration,i+u),t.lastWrittenMsTimestamp=i,this.trackDatasInCurrentCluster.has(t)||this.trackDatasInCurrentCluster.set(t,{firstMsTimestamp:i}),this.currentClusterMaxMsTimestamp=Math.max(this.currentClusterMaxMsTimestamp,i)}createNewCluster(t){this.currentCluster&&!this.format._options.streamable&&this.finalizeCurrentCluster(),this.currentCluster={id:524531317,size:this.format._options.streamable?-1:Ii,data:[{id:231,data:t}]},this.ebmlWriter.writeEBML(this.currentCluster),this.currentClusterStartMsTimestamp=t,this.currentClusterMaxMsTimestamp=t,this.trackDatasInCurrentCluster.clear()}finalizeCurrentCluster(){f(this.currentCluster);let t=this.writer.getPos()-this.ebmlWriter.dataOffsets.get(this.currentCluster),r=this.writer.getPos();this.writer.seek(this.ebmlWriter.offsets.get(this.currentCluster)+4),this.ebmlWriter.writeVarInt(t,Ii),this.writer.seek(r);let i=this.ebmlWriter.offsets.get(this.currentCluster)-this.segmentDataOffset,a=new Map;for(let[o,{firstMsTimestamp:d}]of this.trackDatasInCurrentCluster)a.has(d)||a.set(d,[]),a.get(d).push(o);let s=[...a.entries()].sort((o,d)=>o[0]-d[0]);for(let[o,d]of s)f(this.cues),this.cues.data.push({id:187,data:[{id:179,data:o},...d.map(c=>({id:183,data:[{id:247,data:c.track.id},{id:241,data:i}]}))]})}async onTrackClose(){let t=await this.mutex.acquire();await this.interleaveChunks(),t()}async finalize(){let t=await this.mutex.acquire();if(this.segment||(this.createTracks(),this.createSegment()),await this.interleaveChunks(!0),!this.format._options.streamable&&this.currentCluster&&this.finalizeCurrentCluster(),f(this.cues),this.ebmlWriter.writeEBML(this.cues),!this.format._options.streamable){let r=this.writer.getPos(),i=this.writer.getPos()-this.segmentDataOffset;this.writer.seek(this.ebmlWriter.offsets.get(this.segment)+4),this.ebmlWriter.writeVarInt(i,Pi),this.segmentDuration.data=new je(this.duration),this.writer.seek(this.ebmlWriter.offsets.get(this.segmentDuration)),this.ebmlWriter.writeEBML(this.segmentDuration),this.seekHead.data[0].data[1].data=this.ebmlWriter.offsets.get(this.cues)-this.segmentDataOffset,this.seekHead.data[1].data[1].data=this.ebmlWriter.offsets.get(this.segmentInfo)-this.segmentDataOffset,this.seekHead.data[2].data[1].data=this.ebmlWriter.offsets.get(this.tracksElement)-this.segmentDataOffset,this.writer.seek(this.ebmlWriter.offsets.get(this.seekHead)),this.ebmlWriter.writeEBML(this.seekHead),this.writer.seek(r)}t()}};var la={1:[-1,32,40,48,56,64,80,96,112,128,160,192,224,256,320,-1],2:[-1,32,48,56,64,80,96,112,128,160,192,224,256,320,384,-1],3:[-1,32,64,96,128,160,192,224,256,288,320,352,384,416,448,-1]},ma={1:[-1,32,48,56,64,80,96,112,128,144,160,176,192,224,256,-1],2:[-1,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1],3:[-1,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1]},fa={0:[11025,12e3,8e3,-1],2:[22050,24e3,16e3,-1],3:[44100,48e3,32e3,-1]},Xe=1483304551,wr=1231971951,Tr=(n,e,t,r)=>Math.floor(n===3?(12*e/t+r)*4:144*e/t+r),Ye=(n,e)=>n===3?e===3?21:36:e===3?13:21,Sr=(n,e)=>{let t=e.pos,r=n>>>24,i=n>>>16&255,a=n>>>8&255,s=n&255;if(r!==255&&i!==255&&a!==255&&s!==255)return e.pos+=4,null;if(e.pos+=1,(i&224)!==224)return null;let o=i>>3&3,d=i>>1&3,c=a>>4&15,u=a>>2&3,l=a>>1&1,m=s>>6&3,p=s>>4&3,h=s>>3&1,b=s>>2&1,g=s&3,k=o===3?la[d]?.[c]:ma[d]?.[c];if(!k||k===-1)return null;let x=k*1e3,w=fa[o]?.[u];if(!w||w===-1)return null;let T=Tr(d,x,w,l);if(e.fileSize!==null&&e.fileSize-t<T)return null;let S;return o===3?S=d===3?384:1152:d===3?S=384:d===2?S=1152:S=576,{startPos:t,totalSize:T,mpegVersionId:o,layer:d,bitrate:x,frequencyIndex:u,sampleRate:w,channel:m,modeExtension:p,copyright:h,original:b,emphasis:g,audioSamplesInFrame:S}};var yr=class{constructor(e){this.writer=e;this.helper=new Uint8Array(8);this.helperView=new DataView(this.helper.buffer)}writeU32(e){this.helperView.setUint32(0,e,!1),this.writer.write(this.helper.subarray(0,4))}writeXingFrame(e){let t=this.writer.getPos(),r=255,i=224|e.mpegVersionId<<3|e.layer<<1,s=(e.mpegVersionId===3?la:ma)?.[e.layer];if(!s)throw new Error("Invalid MPEG version and layer combination.");let o=fa[e.mpegVersionId]?.[e.frequencyIndex];if(!o||o===-1)throw new Error("Invalid MPEG version and frequency index combination.");let d=0,c=155,u=s.findIndex(g=>Tr(e.layer,1e3*g,o,d)>=c);if(u===-1)throw new Error("No suitable bitrate found.");let l=u<<4|e.frequencyIndex<<2|d<<1,m=e.channel<<6|e.modeExtension<<4|e.copyright<<3|e.original<<2|e.emphasis;this.helper[0]=r,this.helper[1]=i,this.helper[2]=l,this.helper[3]=m,this.writer.write(this.helper.subarray(0,4));let p=Ye(e.mpegVersionId,e.channel);this.writer.seek(t+p),this.writeU32(Xe);let h=0;e.frameCount!==null&&(h|=1),e.fileSize!==null&&(h|=2),e.toc!==null&&(h|=4),this.writeU32(h),this.writeU32(e.frameCount??0),this.writeU32(e.fileSize??0),this.writer.write(e.toc??new Uint8Array(100));let b=Tr(e.layer,1e3*s[u],o,d);this.writer.seek(t+b)}};var xr=class extends ae{constructor(t){super(t);this.xingFrameData=null;this.frameCount=0;this.framePositions=[];this.writer=t._writer,this.mp3Writer=new yr(t._writer)}async start(){}async addEncodedVideoPacket(){throw new Error("MP3 does not support video.")}async addEncodedAudioPacket(t,r){let i=await this.mutex.acquire();try{if(!this.xingFrameData){let a=Y(r.data);if(a.byteLength<4)throw new Error("Invalid MP3 header in sample.");let s=a.getUint32(0,!1),o=Sr(s,{pos:0,fileSize:null});if(!o)throw new Error("Invalid MP3 header in sample.");let d=Ye(o.mpegVersionId,o.channel);if(a.byteLength>=d+4){let c=a.getUint32(d,!1);if(c===Xe||c===wr)return}this.xingFrameData={mpegVersionId:o.mpegVersionId,layer:o.layer,frequencyIndex:o.frequencyIndex,channel:o.channel,modeExtension:o.modeExtension,copyright:o.copyright,original:o.original,emphasis:o.emphasis,frameCount:null,fileSize:null,toc:null},this.mp3Writer.writeXingFrame(this.xingFrameData),this.frameCount++}this.validateAndNormalizeTimestamp(t,r.timestamp,r.type==="key"),this.framePositions.push(this.writer.getPos()),this.writer.write(r.data),this.frameCount++,await this.writer.flush()}finally{i()}}async addSubtitleCue(){throw new Error("MP3 does not support subtitles.")}async finalize(){if(!this.xingFrameData)return;let t=await this.mutex.acquire(),r=this.writer.getPos();this.writer.seek(0);let i=new Uint8Array(100);for(let a=0;a<100;a++){let s=Math.floor(this.framePositions.length*(a/100));f(s!==-1&&s<this.framePositions.length);let o=this.framePositions[s];i[a]=256*(o/r)}this.xingFrameData.frameCount=this.frameCount,this.xingFrameData.fileSize=r,this.xingFrameData.toc=i,this.mp3Writer.writeXingFrame(this.xingFrameData),this.writer.seek(r),t()}};var Tt=1399285583,gs=79764919,Ei=new Uint32Array(256);for(let n=0;n<256;n++){let e=n<<24;for(let t=0;t<8;t++)e=e&2147483648?e<<1^gs:e<<1;Ei[n]=e>>>0&4294967295}var Cr=n=>{let e=Y(n),t=e.getUint32(22,!0);e.setUint32(22,0,!0);let r=0;for(let i=0;i<n.length;i++){let a=n[i];r=(r<<8^Ei[r>>>24^a])>>>0}return e.setUint32(22,t,!0),r},Pr=(n,e,t)=>{let r=0,i=null;if(n.length>0)if(e.codec==="vorbis"){f(e.vorbisInfo);let a=e.vorbisInfo.modeBlockflags.length,o=(1<<Ja(a-1))-1<<1,d=(n[0]&o)>>1;if(d>=e.vorbisInfo.modeBlockflags.length)throw new Error("Invalid mode number.");let c=t,u=e.vorbisInfo.modeBlockflags[d];if(i=e.vorbisInfo.blocksizes[u],u===1){let l=(o|1)+1,m=n[0]&l?1:0;c=e.vorbisInfo.blocksizes[m]}r=c!==null?c+i>>2:0}else e.codec==="opus"&&(r=ii(n).durationInSamples);return{durationInSamples:r,vorbisBlockSize:i}},Ir=n=>{class e{constructor(p){this.bytes=p,this.pos=0}read(p){let h=v(this.bytes,this.pos,this.pos+p);return this.pos+=p,h}skip(p){this.pos+=p}getBitsLeft(){return this.bytes.length*8-this.pos}getBitCount(){return this.pos}clone(){let p=new e(this.bytes);return p.pos=this.pos,p}}if(n.length<7)throw new Error("Setup header is too short.");if(n[0]!==5)throw new Error("Wrong packet type in Setup header.");if(String.fromCharCode(...n.slice(1,7))!=="vorbis")throw new Error("Invalid packet signature in Setup header.");let r=n.length,i=new Uint8Array(r);for(let m=0;m<r;m++)i[m]=n[r-1-m];let a=new e(i),s=0;for(;a.getBitsLeft()>97;)if(a.read(1)===1){s=a.getBitCount();break}if(s===0)throw new Error("Invalid Setup header: framing bit not found.");let o=0,d=!1,c=0;for(;a.getBitsLeft()>=97;){let m=a.pos,p=a.read(8),h=a.read(16),b=a.read(16);if(p>63||h!==0||b!==0){a.pos=m;break}if(a.skip(1),o++,o>64)break;a.clone().read(6)+1===o&&(d=!0,c=o)}if(!d)throw new Error("Invalid Setup header: mode header not found.");if(c>63)throw new Error(`Unsupported mode count: ${c}.`);let u=c;a.pos=0,a.skip(s);let l=Array(u).fill(0);for(let m=u-1;m>=0;m--)a.skip(40),l[m]=a.read(1);return{modeBlockflags:l}};var Je=27,Me=282,vr=Me+255*255,Ze=class{constructor(e){this.reader=e;this.pos=0}readBytes(e){let{view:t,offset:r}=this.reader.getViewAndOffset(this.pos,this.pos+e);return this.pos+=e,new Uint8Array(t.buffer,r,e)}readU8(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+1);return this.pos+=1,e.getUint8(t)}readU32(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+4);return this.pos+=4,e.getUint32(t,!0)}readI32(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+4);return this.pos+=4,e.getInt32(t,!0)}readI64(){let e=this.readU32();return this.readI32()*4294967296+e}readAscii(e){let{view:t,offset:r}=this.reader.getViewAndOffset(this.pos,this.pos+e);this.pos+=e;let i="";for(let a=0;a<e;a++)i+=String.fromCharCode(t.getUint8(r+a));return i}readPageHeader(){let e=this.pos;if(this.readU32()!==Tt)return null;this.pos+=1;let r=this.readU8(),i=this.readI64(),a=this.readU32(),s=this.readU32(),o=this.readU32(),d=this.readU8(),c=new Uint8Array(d);for(let p=0;p<d;p++)c[p]=this.readU8();let u=27+d,l=c.reduce((p,h)=>p+h,0),m=u+l;return{headerStartPos:e,totalSize:m,dataStartPos:e+u,dataSize:l,headerType:r,granulePosition:i,serialNumber:a,sequenceNumber:s,checksum:o,lacingValues:c}}findNextPageHeader(e){for(;this.pos<e-3;){let t=this.readU32(),r=t&255,i=t>>>8&255,a=t>>>16&255,s=t>>>24&255,o=79;if(!(r!==o&&i!==o&&a!==o&&s!==o)){if(this.pos-=4,t===Tt)return!0;this.pos+=1}}return!1}};var bs=8192,Er=class extends ae{constructor(t){super(t);this.trackDatas=[];this.bosPagesWritten=!1;this.pageBytes=new Uint8Array(vr);this.pageView=new DataView(this.pageBytes.buffer);this.writer=t._writer}async start(){}addEncodedVideoPacket(){throw new Error("Video tracks are not supported.")}getTrackData(t,r){let i=this.trackDatas.find(o=>o.track===t);if(i)return i;let a;do a=Math.floor(2**32*Math.random());while(this.trackDatas.some(o=>o.serialNumber===a));f(t.source._codec==="vorbis"||t.source._codec==="opus"),f(r),f(r.decoderConfig),f(r.decoderConfig.sampleRate);let s={track:t,serialNumber:a,internalSampleRate:t.source._codec==="opus"?He:r.decoderConfig.sampleRate,codecInfo:{codec:t.source._codec,vorbisInfo:null,opusInfo:null},vorbisLastBlocksize:null,packetQueue:[],currentTimestampInSamples:0,pagesWritten:0,currentGranulePosition:0,currentLacingValues:[],currentPageData:[],currentPageSize:27,currentPageStartsWithFreshPacket:!0};return this.queueHeaderPackets(s,r),this.trackDatas.push(s),s}queueHeaderPackets(t,r){if(f(r.decoderConfig),t.track.source._codec==="vorbis"){f(r.decoderConfig.description);let i=Q(r.decoderConfig.description);if(i[0]!==2)throw new TypeError("First byte of Vorbis decoder description must be 2.");let a=1,s=()=>{let b=0;for(;;){let g=i[a++];if(g===void 0)throw new TypeError("Vorbis decoder description is too short.");if(b+=g,g<255)return b}},o=s(),d=s();if(i.length-a<=0)throw new TypeError("Vorbis decoder description is too short.");let u=i.subarray(a,a+=o),l=i.subarray(a,a+=d),m=i.subarray(a);t.packetQueue.push({data:u,endGranulePosition:0,timestamp:0,forcePageFlush:!0},{data:l,endGranulePosition:0,timestamp:0,forcePageFlush:!1},{data:m,endGranulePosition:0,timestamp:0,forcePageFlush:!0});let h=Y(u).getUint8(28);t.codecInfo.vorbisInfo={blocksizes:[1<<(h&15),1<<(h>>4)],modeBlockflags:Ir(m).modeBlockflags}}else if(t.track.source._codec==="opus"){if(!r.decoderConfig.description)throw new TypeError("For Ogg, Opus decoder description is required.");let i=Q(r.decoderConfig.description),a=new Uint8Array(16),s=new DataView(a.buffer);s.setUint32(0,1332770163,!1),s.setUint32(4,1415669619,!1),s.setUint32(8,0,!0),s.setUint32(12,0,!0),t.packetQueue.push({data:i,endGranulePosition:0,timestamp:0,forcePageFlush:!0},{data:a,endGranulePosition:0,timestamp:0,forcePageFlush:!0}),t.codecInfo.opusInfo={preSkip:Ee(i).preSkip}}}async addEncodedAudioPacket(t,r,i){let a=await this.mutex.acquire();try{let s=this.getTrackData(t,i);this.validateAndNormalizeTimestamp(s.track,r.timestamp,r.type==="key");let o=s.currentTimestampInSamples,{durationInSamples:d,vorbisBlockSize:c}=Pr(r.data,s.codecInfo,s.vorbisLastBlocksize);s.currentTimestampInSamples+=d,s.vorbisLastBlocksize=c,s.packetQueue.push({data:r.data,endGranulePosition:s.currentTimestampInSamples,timestamp:o/s.internalSampleRate,forcePageFlush:!1}),await this.interleavePages()}finally{a()}}addSubtitleCue(){throw new Error("Subtitle tracks are not supported.")}async interleavePages(t=!1){if(!this.bosPagesWritten){for(let r of this.output._tracks)if(!r.source._closed&&!this.trackDatas.some(i=>i.track===r))return;for(let r of this.trackDatas)for(;r.packetQueue.length>0;){let i=r.packetQueue.shift();if(this.writePacket(r,i,!1),i.forcePageFlush)break}this.bosPagesWritten=!0}e:for(;;){let r=null,i=1/0;for(let o of this.trackDatas){if(!t&&o.packetQueue.length<=1&&!o.track.source._closed)break e;o.packetQueue.length>0&&o.packetQueue[0].timestamp<i&&(r=o,i=o.packetQueue[0].timestamp)}if(!r)break;let a=r.packetQueue.shift(),s=r.packetQueue.length===0;this.writePacket(r,a,s)}t||await this.writer.flush()}writePacket(t,r,i){let a=r.data.length,s=0,o=0;for(;;){t.currentLacingValues.length===0&&s>0&&(t.currentPageStartsWithFreshPacket=!1);let c=Math.min(255,a);t.currentLacingValues.push(c),t.currentPageSize++,o+=c;let u=a<255;if(t.currentLacingValues.length===255){let l=r.data.subarray(s,o);if(s=o,t.currentPageData.push(l),t.currentPageSize+=l.length,this.writePage(t,i&&u),u)return}if(u)break;a-=255}let d=r.data.subarray(s);t.currentPageData.push(d),t.currentPageSize+=d.length,t.currentGranulePosition=r.endGranulePosition,(t.currentPageSize>=bs||r.forcePageFlush)&&this.writePage(t,i)}writePage(t,r){this.pageView.setUint32(0,Tt,!0),this.pageView.setUint8(4,0);let i=0;t.currentPageStartsWithFreshPacket||(i|=1),t.pagesWritten===0&&(i|=2),r&&(i|=4),this.pageView.setUint8(5,i);let a=t.currentLacingValues.every(c=>c===255)?-1:t.currentGranulePosition;Ya(this.pageView,6,a,!0),this.pageView.setUint32(14,t.serialNumber,!0),this.pageView.setUint32(18,t.pagesWritten,!0),this.pageView.setUint32(22,0,!0),this.pageView.setUint8(26,t.currentLacingValues.length),this.pageBytes.set(t.currentLacingValues,27);let s=27+t.currentLacingValues.length;for(let c of t.currentPageData)this.pageBytes.set(c,s),s+=c.length;let o=this.pageBytes.subarray(0,s),d=Cr(o);this.pageView.setUint32(22,d,!0),t.pagesWritten++,t.currentLacingValues.length=0,t.currentPageData.length=0,t.currentPageSize=27,t.currentPageStartsWithFreshPacket=!0,this.writer.write(o)}async onTrackClose(){let t=await this.mutex.acquire();await this.interleavePages(),t()}async finalize(){let t=await this.mutex.acquire();await this.interleavePages(!0);for(let r of this.trackDatas)r.currentLacingValues.length>0&&this.writePage(r,!0);t()}};var ie=class{constructor(e){this.input=e}};var te=new Uint8Array(0),V=class n{constructor(e,t,r,i,a=-1,s=e.byteLength){this.data=e;this.type=t;this.timestamp=r;this.duration=i;this.sequenceNumber=a;this.byteLength=s;if(!(e instanceof Uint8Array))throw new TypeError("data must be a Uint8Array.");if(t!=="key"&&t!=="delta")throw new TypeError('type must be either "key" or "delta".');if(!Number.isFinite(r))throw new TypeError("timestamp must be a number.");if(!Number.isFinite(i)||i<0)throw new TypeError("duration must be a non-negative number.");if(!Number.isFinite(a))throw new TypeError("sequenceNumber must be a number.");if(!Number.isInteger(s)||s<0)throw new TypeError("byteLength must be a non-negative integer.")}get isMetadataOnly(){return this.data===te}get microsecondTimestamp(){return Math.trunc(ue*this.timestamp)}get microsecondDuration(){return Math.trunc(ue*this.duration)}toEncodedVideoChunk(){if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to a video chunk.");if(typeof EncodedVideoChunk>"u")throw new Error("Your browser does not support EncodedVideoChunk.");return new EncodedVideoChunk({data:this.data,type:this.type,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}toEncodedAudioChunk(){if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to an audio chunk.");if(typeof EncodedAudioChunk>"u")throw new Error("Your browser does not support EncodedAudioChunk.");return new EncodedAudioChunk({data:this.data,type:this.type,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}static fromEncodedChunk(e){if(!(e instanceof EncodedVideoChunk||e instanceof EncodedAudioChunk))throw new TypeError("chunk must be an EncodedVideoChunk or EncodedAudioChunk.");let t=new Uint8Array(e.byteLength);return e.copyTo(t),new n(t,e.type,e.timestamp/1e6,(e.duration??0)/1e6)}clone(e){if(e!==void 0&&(typeof e!="object"||e===null))throw new TypeError("options, when provided, must be an object.");if(e?.timestamp!==void 0&&!Number.isFinite(e.timestamp))throw new TypeError("options.timestamp, when provided, must be a number.");if(e?.duration!==void 0&&!Number.isFinite(e.duration))throw new TypeError("options.duration, when provided, must be a number.");return new n(this.data,this.type,e?.timestamp??this.timestamp,e?.duration??this.duration,this.sequenceNumber,this.byteLength)}};var _i=n=>{let r=n,i=4096,a=0,s=12,o=0;for(r<0&&(r=-r,a=128),r+=33,r>8191&&(r=8191);(r&i)!==i&&s>=5;i>>=1,s--);return o=r>>s-4&15,~(a|s-5<<4|o)&255},Ai=n=>{let t=0,r=0,i=~n;i&128&&(i&=-129,t=-1),r=((i&240)>>4)+5;let a=(1<<r|(i&15)<<r-4|1<<r-5)-33;return t===0?a:-a},Ri=n=>{let t=2048,r=0,i=11,a=0,s=n;for(s<0&&(s=-s,r=128),s>4095&&(s=4095);(s&t)!==t&&i>=5;t>>=1,i--);return a=s>>(i===4?1:i-4)&15,(r|i-4<<4|a)^85},Oi=n=>{let e=0,t=0,r=n^85;r&128&&(r&=-129,e=-1),t=((r&240)>>4)+4;let i=0;return t!==4?i=1<<t|(r&15)<<t-4|1<<t-5:i=r<<1|1,e===0?i:-i};var oe=class n{constructor(e,t){this._closed=!1;if(e instanceof ArrayBuffer||ArrayBuffer.isView(e)){if(!t||typeof t!="object")throw new TypeError("init must be an object.");if(!("format"in t)||typeof t.format!="string")throw new TypeError("init.format must be a string.");if(!Number.isInteger(t.codedWidth)||t.codedWidth<=0)throw new TypeError("init.codedWidth must be a positive integer.");if(!Number.isInteger(t.codedHeight)||t.codedHeight<=0)throw new TypeError("init.codedHeight must be a positive integer.");if(t.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(!Number.isFinite(t.timestamp))throw new TypeError("init.timestamp must be a number.");if(t.duration!==void 0&&(!Number.isFinite(t.duration)||t.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");this._data=Q(e).slice(),this.format=t.format,this.codedWidth=t.codedWidth,this.codedHeight=t.codedHeight,this.rotation=t.rotation??0,this.timestamp=t.timestamp,this.duration=t.duration??0,this.colorSpace=new VideoColorSpace(t.colorSpace)}else if(typeof VideoFrame<"u"&&e instanceof VideoFrame){if(t?.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(t?.timestamp!==void 0&&!Number.isFinite(t?.timestamp))throw new TypeError("init.timestamp, when provided, must be a number.");if(t?.duration!==void 0&&(!Number.isFinite(t.duration)||t.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");this._data=e,this.format=e.format,this.codedWidth=e.codedWidth,this.codedHeight=e.codedHeight,this.rotation=t?.rotation??0,this.timestamp=t?.timestamp??e.timestamp/1e6,this.duration=t?.duration??(e.duration??0)/1e6,this.colorSpace=e.colorSpace}else if(typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement||typeof SVGImageElement<"u"&&e instanceof SVGImageElement||typeof ImageBitmap<"u"&&e instanceof ImageBitmap||typeof HTMLVideoElement<"u"&&e instanceof HTMLVideoElement||typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&e instanceof OffscreenCanvas){if(!t||typeof t!="object")throw new TypeError("init must be an object.");if(t.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(!Number.isFinite(t.timestamp))throw new TypeError("init.timestamp must be a number.");if(t.duration!==void 0&&(!Number.isFinite(t.duration)||t.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");if(typeof VideoFrame<"u")return new n(new VideoFrame(e,{timestamp:Math.trunc(t.timestamp*ue),duration:Math.trunc((t.duration??0)*ue)}),t);let r=0,i=0;if("naturalWidth"in e?(r=e.naturalWidth,i=e.naturalHeight):"videoWidth"in e?(r=e.videoWidth,i=e.videoHeight):"width"in e&&(r=Number(e.width),i=Number(e.height)),!r||!i)throw new TypeError("Could not determine dimensions.");let a=new OffscreenCanvas(r,i),s=a.getContext("2d",{alpha:!1,willReadFrequently:!0});f(s),s.drawImage(e,0,0),this._data=a,this.format="RGBX",this.codedWidth=r,this.codedHeight=i,this.rotation=t.rotation??0,this.timestamp=t.timestamp,this.duration=t.duration??0,this.colorSpace=new VideoColorSpace({matrix:"rgb",primaries:"bt709",transfer:"iec61966-2-1",fullRange:!0})}else throw new TypeError("Invalid data type: Must be a BufferSource or CanvasImageSource.")}get displayWidth(){return this.rotation%180===0?this.codedWidth:this.codedHeight}get displayHeight(){return this.rotation%180===0?this.codedHeight:this.codedWidth}get microsecondTimestamp(){return Math.trunc(ue*this.timestamp)}get microsecondDuration(){return Math.trunc(ue*this.duration)}clone(){if(this._closed)throw new Error("VideoSample is closed.");return f(this._data!==null),St(this._data)?new n(this._data.clone()):this._data instanceof Uint8Array?new n(this._data.slice(),{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.timestamp,duration:this.duration,colorSpace:this.colorSpace}):new n(this._data,{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.timestamp,duration:this.duration,colorSpace:this.colorSpace})}close(){this._closed||(St(this._data)?this._data.close():this._data=null,this._closed=!0)}allocationSize(){if(this._closed)throw new Error("VideoSample is closed.");return f(this._data!==null),St(this._data)?this._data.allocationSize():this._data instanceof Uint8Array?this._data.byteLength:this.codedWidth*this.codedHeight*4}async copyTo(e){if(!Ue(e))throw new TypeError("destination must be an ArrayBuffer or an ArrayBuffer view.");if(this._closed)throw new Error("VideoSample is closed.");if(f(this._data!==null),St(this._data))await this._data.copyTo(e);else if(this._data instanceof Uint8Array)Q(e).set(this._data);else{let r=this._data.getContext("2d",{alpha:!1});f(r);let i=r.getImageData(0,0,this.codedWidth,this.codedHeight);Q(e).set(i.data)}}toVideoFrame(){if(this._closed)throw new Error("VideoSample is closed.");return f(this._data!==null),St(this._data)?new VideoFrame(this._data,{timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0}):this._data instanceof Uint8Array?new VideoFrame(this._data,{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration,colorSpace:this.colorSpace}):new VideoFrame(this._data,{timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}draw(e,t,r,i=this.displayWidth,a=this.displayHeight){if(!(typeof CanvasRenderingContext2D<"u"&&e instanceof CanvasRenderingContext2D||typeof OffscreenCanvasRenderingContext2D<"u"&&e instanceof OffscreenCanvasRenderingContext2D))throw new TypeError("context must be a CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D.");if(!Number.isFinite(t))throw new TypeError("dx must be a number.");if(!Number.isFinite(r))throw new TypeError("dy must be a number.");if(!Number.isFinite(i)||i<0)throw new TypeError("dWidth must be a non-negative number.");if(!Number.isFinite(a)||a<0)throw new TypeError("dHeight must be a non-negative number.");if(this._closed)throw new Error("VideoSample is closed.");let s=this.toCanvasImageSource();e.save();let o=t+i/2,d=r+a/2;e.translate(o,d),e.rotate(this.rotation*Math.PI/180);let c=this.rotation%180===0?1:i/a;e.scale(1/c,c),e.drawImage(s,-i/2,-a/2,i,a),e.restore()}toCanvasImageSource(){if(this._closed)throw new Error("VideoSample is closed.");return f(this._data!==null),this._data instanceof Uint8Array?this.toVideoFrame():this._data}setRotation(e){if(![0,90,180,270].includes(e))throw new TypeError("newRotation must be 0, 90, 180, or 270.");this.rotation=e}setTimestamp(e){if(!Number.isFinite(e))throw new TypeError("newTimestamp must be a number.");this.timestamp=e}setDuration(e){if(!Number.isFinite(e)||e<0)throw new TypeError("newDuration must be a non-negative number.");this.duration=e}},St=n=>typeof VideoFrame<"u"&&n instanceof VideoFrame,pa=new Set(["f32","f32-planar","s16","s16-planar","s32","s32-planar","u8","u8-planar"]),me=class n{constructor(e){this._closed=!1;if(xt(e)){if(e.format===null)throw new TypeError("AudioData with null format is not supported.");this._data=e,this.format=e.format,this.sampleRate=e.sampleRate,this.numberOfFrames=e.numberOfFrames,this.numberOfChannels=e.numberOfChannels,this.timestamp=e.timestamp/1e6,this.duration=e.numberOfFrames/e.sampleRate}else{if(!e||typeof e!="object")throw new TypeError("Invalid AudioDataInit: must be an object.");if(!pa.has(e.format))throw new TypeError("Invalid AudioDataInit: invalid format.");if(!Number.isFinite(e.sampleRate)||e.sampleRate<=0)throw new TypeError("Invalid AudioDataInit: sampleRate must be > 0.");if(!Number.isInteger(e.numberOfChannels)||e.numberOfChannels===0)throw new TypeError("Invalid AudioDataInit: numberOfChannels must be an integer > 0.");if(!Number.isFinite(e?.timestamp))throw new TypeError("init.timestamp must be a number.");let t=e.data.byteLength/(yt(e.format)*e.numberOfChannels);if(!Number.isInteger(t))throw new TypeError("Invalid AudioDataInit: data size is not a multiple of frame size.");this.format=e.format,this.sampleRate=e.sampleRate,this.numberOfFrames=t,this.numberOfChannels=e.numberOfChannels,this.timestamp=e.timestamp,this.duration=t/e.sampleRate;let r;if(e.data instanceof ArrayBuffer)r=new Uint8Array(e.data);else if(ArrayBuffer.isView(e.data))r=new Uint8Array(e.data.buffer,e.data.byteOffset,e.data.byteLength);else throw new TypeError("Invalid AudioDataInit: data is not a BufferSource.");let i=this.numberOfFrames*this.numberOfChannels*yt(this.format);if(r.byteLength<i)throw new TypeError("Invalid AudioDataInit: insufficient data size.");this._data=r}}get microsecondTimestamp(){return Math.trunc(ue*this.timestamp)}get microsecondDuration(){return Math.trunc(ue*this.duration)}allocationSize(e){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(!Number.isInteger(e.planeIndex)||e.planeIndex<0)throw new TypeError("planeIndex must be a non-negative integer.");if(e.format!==void 0&&!pa.has(e.format))throw new TypeError("Invalid format.");if(e.frameOffset!==void 0&&(!Number.isInteger(e.frameOffset)||e.frameOffset<0))throw new TypeError("frameOffset must be a non-negative integer.");if(e.frameCount!==void 0&&(!Number.isInteger(e.frameCount)||e.frameCount<0))throw new TypeError("frameCount must be a non-negative integer.");if(this._closed)throw new Error("AudioSample is closed.");let t=e.format??this.format,r=e.frameOffset??0;if(r>=this.numberOfFrames)throw new RangeError("frameOffset out of range");let i=e.frameCount!==void 0?e.frameCount:this.numberOfFrames-r;if(i>this.numberOfFrames-r)throw new RangeError("frameCount out of range");let a=yt(t),s=_r(t);if(s&&e.planeIndex>=this.numberOfChannels)throw new RangeError("planeIndex out of range");if(!s&&e.planeIndex!==0)throw new RangeError("planeIndex out of range");return(s?i:i*this.numberOfChannels)*a}copyTo(e,t){if(!Ue(e))throw new TypeError("destination must be an ArrayBuffer or an ArrayBuffer view.");if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(!Number.isInteger(t.planeIndex)||t.planeIndex<0)throw new TypeError("planeIndex must be a non-negative integer.");if(t.format!==void 0&&!pa.has(t.format))throw new TypeError("Invalid format.");if(t.frameOffset!==void 0&&(!Number.isInteger(t.frameOffset)||t.frameOffset<0))throw new TypeError("frameOffset must be a non-negative integer.");if(t.frameCount!==void 0&&(!Number.isInteger(t.frameCount)||t.frameCount<0))throw new TypeError("frameCount must be a non-negative integer.");if(this._closed)throw new Error("AudioSample is closed.");let{planeIndex:r,format:i,frameCount:a,frameOffset:s}=t,o=i??this.format;if(!o)throw new Error("Destination format not determined");let d=this.numberOfFrames,c=this.numberOfChannels,u=s??0;if(u>=d)throw new RangeError("frameOffset out of range");let l=a!==void 0?a:d-u;if(l>d-u)throw new RangeError("frameCount out of range");let m=yt(o),p=_r(o);if(p&&r>=c)throw new RangeError("planeIndex out of range");if(!p&&r!==0)throw new RangeError("planeIndex out of range");let b=(p?l:l*c)*m;if(e.byteLength<b)throw new RangeError("Destination buffer is too small");let g=Y(e),k=ws(o);if(xt(this._data))if(p)if(o==="f32-planar")this._data.copyTo(e,{planeIndex:r,frameOffset:u,frameCount:l,format:"f32-planar"});else{let x=new ArrayBuffer(l*4),w=new Float32Array(x);this._data.copyTo(w,{planeIndex:r,frameOffset:u,frameCount:l,format:"f32-planar"});let T=new DataView(x);for(let S=0;S<l;S++){let y=S*m,P=T.getFloat32(S*4,!0);k(g,y,P)}}else{let x=c,w=new Float32Array(l);for(let T=0;T<x;T++){this._data.copyTo(w,{planeIndex:T,frameOffset:u,frameCount:l,format:"f32-planar"});for(let S=0;S<l;S++){let P=(S*x+T)*m;k(g,P,w[S])}}}else{let x=this._data,w=new DataView(x.buffer,x.byteOffset,x.byteLength),T=this.format,S=ks(T),y=yt(T),P=_r(T);for(let I=0;I<l;I++)if(p){let E=I*m,z;P?z=(r*d+(I+u))*y:z=((I+u)*c+r)*y;let N=S(w,z);k(g,E,N)}else for(let E=0;E<c;E++){let N=(I*c+E)*m,K;P?K=(E*d+(I+u))*y:K=((I+u)*c+E)*y;let Pe=S(w,K);k(g,N,Pe)}}}clone(){if(this._closed)throw new Error("AudioSample is closed.");return xt(this._data)?new n(this._data.clone()):new n({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.timestamp,data:this._data})}close(){this._closed||(xt(this._data)?this._data.close():this._data=new Uint8Array(0),this._closed=!0)}toAudioData(){if(this._closed)throw new Error("AudioSample is closed.");if(xt(this._data)){if(this._data.timestamp===this.microsecondTimestamp)return this._data.clone();if(_r(this.format)){let e=this.allocationSize({planeIndex:0,format:this.format}),t=new ArrayBuffer(e*this.numberOfChannels);for(let r=0;r<this.numberOfChannels;r++)this.copyTo(new Uint8Array(t,r*e,e),{planeIndex:r,format:this.format});return new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:t})}else{let e=new ArrayBuffer(this.allocationSize({planeIndex:0,format:this.format}));return this.copyTo(new DataView(e),{planeIndex:0,format:this.format}),new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:e})}}else return new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:this._data})}toAudioBuffer(){if(this._closed)throw new Error("AudioSample is closed.");let e=new AudioBuffer({numberOfChannels:this.numberOfChannels,length:this.numberOfFrames,sampleRate:this.sampleRate}),t=new Float32Array(this.allocationSize({planeIndex:0,format:"f32-planar"})/4);for(let r=0;r<this.numberOfChannels;r++)this.copyTo(t,{planeIndex:r,format:"f32-planar"}),e.copyToChannel(t,r);return e}setTimestamp(e){if(!Number.isFinite(e))throw new TypeError("newTimestamp must be a number.");this.timestamp=e}},yt=n=>{switch(n){case"u8":case"u8-planar":return 1;case"s16":case"s16-planar":return 2;case"s32":case"s32-planar":return 4;case"f32":case"f32-planar":return 4;default:throw new Error("Unknown AudioSampleFormat")}},_r=n=>{switch(n){case"u8-planar":case"s16-planar":case"s32-planar":case"f32-planar":return!0;default:return!1}},ks=n=>{switch(n){case"u8":case"u8-planar":return(e,t)=>(e.getUint8(t)-128)/128;case"s16":case"s16-planar":return(e,t)=>e.getInt16(t,!0)/32768;case"s32":case"s32-planar":return(e,t)=>e.getInt32(t,!0)/2147483648;case"f32":case"f32-planar":return(e,t)=>e.getFloat32(t,!0)}},ws=n=>{switch(n){case"u8":case"u8-planar":return(e,t,r)=>e.setUint8(t,L((r+1)*127.5,0,255));case"s16":case"s16-planar":return(e,t,r)=>e.setInt16(t,L(Math.round(r*32767),-32768,32767),!0);case"s32":case"s32-planar":return(e,t,r)=>e.setInt32(t,L(Math.round(r*2147483647),-2147483648,2147483647),!0);case"f32":case"f32-planar":return(e,t,r)=>e.setFloat32(t,r,!0)}},xt=n=>typeof AudioData<"u"&&n instanceof AudioData;var Ct=n=>{if(!n||typeof n!="object")throw new TypeError("options must be an object.");if(n.metadataOnly!==void 0&&typeof n.metadataOnly!="boolean")throw new TypeError("options.metadataOnly, when defined, must be a boolean.")},Se=n=>{if(typeof n!="number"||Number.isNaN(n))throw new TypeError("timestamp must be a number.")},fe=class{constructor(e){if(!(e instanceof De))throw new TypeError("track must be an InputTrack.");this._track=e}getFirstPacket(e={}){return Ct(e),this._track._backing.getFirstPacket(e)}getPacket(e,t={}){return Se(e),Ct(t),this._track._backing.getPacket(e,t)}getNextPacket(e,t={}){if(!(e instanceof V))throw new TypeError("packet must be an EncodedPacket.");return Ct(t),this._track._backing.getNextPacket(e,t)}getKeyPacket(e,t={}){return Se(e),Ct(t),this._track._backing.getKeyPacket(e,t)}getNextKeyPacket(e,t={}){if(!(e instanceof V))throw new TypeError("packet must be an EncodedPacket.");return Ct(t),this._track._backing.getNextKeyPacket(e,t)}packets(e,t=1/0,r){let i=[],{promise:a,resolve:s}=W(),{promise:o,resolve:d}=W(),c=!1,u=!1,l=null,m=[],p=()=>Math.max(2,m.length);return(async()=>{let h=e??await this.getFirstPacket(r);for(;h&&!u&&!(h.timestamp>=t);){if(i.length>p()){({promise:o,resolve:d}=W()),await o;continue}i.push(h),s(),{promise:a,resolve:s}=W(),h=await this.getNextPacket(h,r)}c=!0,s()})().catch(h=>{l||(l=h,s())}),{async next(){for(;;){if(u)return{value:void 0,done:!0};if(l)throw l;if(i.length>0){let h=i.shift(),b=performance.now();for(m.push(b);m.length>0&&b-m[0]>=1e3;)m.shift();return d(),{value:h,done:!1}}else{if(c)return{value:void 0,done:!0};await a}}},async return(){return u=!0,d(),s(),{value:void 0,done:!0}},async throw(h){throw h},[Symbol.asyncIterator](){return this}}}},Pt=class{constructor(e,t){this.onSample=e;this.onError=t}},It=class{mediaSamplesInRange(e=0,t=1/0){Se(e),Se(t);let r=8,i=[],a=!1,s=null,{promise:o,resolve:d}=W(),{promise:c,resolve:u}=W(),l=!1,m=!1,p=!1,h=null;return(async()=>{let b=new Error,g=await this._createDecoder(y=>{if(u(),y.timestamp>=t&&(m=!0),m){y.close();return}s&&(y.timestamp>e?(i.push(s),a=!0):s.close()),y.timestamp>=e&&(i.push(y),a=!0),s=a?null:y,i.length>0&&(d(),{promise:o,resolve:d}=W())},y=>{h||(y.stack=b.stack,h=y,d())}),k=this._createPacketSink(),x=await k.getKeyPacket(e)??await k.getFirstPacket();if(!x)return;let w=x,T=1/0;if(t<1/0){let y=await k.getPacket(t),P=y?y.type==="key"&&y.timestamp===t?y:await k.getNextKeyPacket(y):null;P&&(T=P.timestamp)}let S=k.packets(x,T);for(await S.next();w&&!m;){if(i.length+g.getDecodeQueueSize()>r){({promise:c,resolve:u}=W()),await c;continue}g.decode(w);let y=await S.next();if(y.done)break;w=y.value}await S.return(),p||await g.flush(),g.close(),!a&&s&&i.push(s),l=!0,d()})().catch(b=>{h||(h=b,d())}),{async next(){for(;;){if(p)return{value:void 0,done:!0};if(h)throw h;if(i.length>0){let b=i.shift();return u(),{value:b,done:!1}}else if(!l)await o;else return{value:void 0,done:!0}}},async return(){p=!0,m=!0,u(),d(),s?.close();for(let b of i)b.close();return{value:void 0,done:!0}},async throw(b){throw b},[Symbol.asyncIterator](){return this}}}mediaSamplesAtTimestamps(e){Ka(e);let t=Ga(e),r=[],i=8,a=[],{promise:s,resolve:o}=W(),{promise:d,resolve:c}=W(),u=!1,l=!1,m=null,p=null,h=b=>{a.push(b),o(),{promise:s,resolve:o}=W()};return(async()=>{let b=new Error,g=await this._createDecoder(T=>{if(c(),l){T.close();return}let S=!1;for(;r.length>0&&T.timestamp-r[0]>-1e-10;)h(T.clone()),r.shift(),S=!0;S?(p?.close(),p=T):T.close()},T=>{m||(T.stack=b.stack,m=T,o())}),k=this._createPacketSink(),x=null,w=null;for await(let T of t){for(Se(T);a.length+g.getDecodeQueueSize()>i&&!l;)({promise:d,resolve:c}=W()),await d;if(l)break;let S=await k.getPacket(T);if(!S){h(null);continue}let y=await k.getKeyPacket(T);if(!y){h(null);continue}for(w&&S.sequenceNumber<w.sequenceNumber&&(await g.flush(),r.length=0),x&&y.sequenceNumber===x.sequenceNumber&&S.timestamp>=w.timestamp?(f(w),S.sequenceNumber===w.sequenceNumber&&r.length===0?p&&h(p.clone()):r.push(S.timestamp)):(x=y,w=y,g.decode(y),r.push(S.timestamp));w.sequenceNumber<S.sequenceNumber;){let P=await k.getNextPacket(w);f(P),w=P,g.decode(P)}}l||(await g.flush(),p?.close()),g.close(),u=!0,o()})().catch(b=>{m||(m=b,o())}),{async next(){for(;;){if(l)return{value:void 0,done:!0};if(m)throw m;if(a.length>0){let b=a.shift();return f(b!==void 0),c(),{value:b,done:!1}}else if(!u)await s;else return{value:void 0,done:!0}}},async return(){l=!0,c(),o();for(let b of a)b?.close();return p?.close(),{value:void 0,done:!0}},async throw(b){throw b},[Symbol.asyncIterator](){return this}}}},ha=class extends Pt{constructor(t,r,i,a,s,o){super(t,r);this.rotation=s;this.timeResolution=o;this.decoder=null;this.customDecoder=null;this.lastCustomDecoderPromise=Promise.resolve();this.customDecoderQueueSize=0;this.sampleQueue=[];let d=u=>{if(this.sampleQueue.length>0&&u.timestamp>=M(this.sampleQueue).timestamp){for(let m of this.sampleQueue)this.finalizeAndEmitSample(m);this.sampleQueue.length=0}let l=R(this.sampleQueue,u.timestamp,m=>m.timestamp);this.sampleQueue.splice(l+1,0,u)},c=ct.find(u=>u.supports(i,a));c?(this.customDecoder=new c,this.customDecoder.codec=i,this.customDecoder.config=a,this.customDecoder.onSample=d,this.customDecoder.init()):(this.decoder=new VideoDecoder({output:u=>d(new oe(u)),error:r}),this.decoder.configure(a))}finalizeAndEmitSample(t){t.setTimestamp(Math.round(t.timestamp*this.timeResolution)/this.timeResolution),t.setDuration(Math.round(t.duration*this.timeResolution)/this.timeResolution),this.onSample(t)}getDecodeQueueSize(){return this.customDecoder?this.customDecoderQueueSize:(f(this.decoder),this.decoder.decodeQueueSize)}decode(t){this.customDecoder?(this.customDecoderQueueSize++,this.lastCustomDecoderPromise=this.lastCustomDecoderPromise.then(()=>this.customDecoder.decode(t)),this.lastCustomDecoderPromise.then(()=>this.customDecoderQueueSize--)):(f(this.decoder),this.decoder.decode(t.toEncodedVideoChunk()))}async flush(){this.customDecoder?await this.lastCustomDecoderPromise.then(()=>this.customDecoder.flush()):(f(this.decoder),await this.decoder.flush());for(let t of this.sampleQueue)this.finalizeAndEmitSample(t);this.sampleQueue.length=0}close(){this.customDecoder?this.lastCustomDecoderPromise.then(()=>this.customDecoder.close()):(f(this.decoder),this.decoder.close());for(let t of this.sampleQueue)t.close();this.sampleQueue.length=0}},et=class extends It{constructor(e){if(!(e instanceof ce))throw new TypeError("videoTrack must be an InputVideoTrack.");super(),this._videoTrack=e}async _createDecoder(e,t){if(!await this._videoTrack.canDecode())throw new Error("This video track cannot be decoded by this browser. Make sure to check decodability before using a track.");let r=this._videoTrack.codec,i=this._videoTrack.rotation,a=await this._videoTrack.getDecoderConfig(),s=this._videoTrack.timeResolution;return f(r&&a),new ha(e,t,r,a,i,s)}_createPacketSink(){return new fe(this._videoTrack)}async getSample(e){Se(e);for await(let t of this.mediaSamplesAtTimestamps([e]))return t;throw new Error("Internal error: Iterator returned nothing.")}samples(e=0,t=1/0){return this.mediaSamplesInRange(e,t)}samplesAtTimestamps(e){return this.mediaSamplesAtTimestamps(e)}},vt=class{constructor(e,t={}){this._nextCanvasIndex=0;if(!(e instanceof ce))throw new TypeError("videoTrack must be an InputVideoTrack.");if(t&&typeof t!="object")throw new TypeError("options must be an object.");if(t.width!==void 0&&(!Number.isInteger(t.width)||t.width<=0))throw new TypeError("options.width, when defined, must be a positive integer.");if(t.height!==void 0&&(!Number.isInteger(t.height)||t.height<=0))throw new TypeError("options.height, when defined, must be a positive integer.");if(t.fit!==void 0&&!["fill","contain","cover"].includes(t.fit))throw new TypeError('options.fit, when provided, must be one of "fill", "contain", or "cover".');if(t.width!==void 0&&t.height!==void 0&&t.fit===void 0)throw new TypeError("When both options.width and options.height are provided, options.fit must also be provided.");if(t.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError("options.rotation, when provided, must be 0, 90, 180 or 270.");if(t.poolSize!==void 0&&(typeof t.poolSize!="number"||!Number.isInteger(t.poolSize)||t.poolSize<0))throw new TypeError("poolSize must be a non-negative integer.");let r=t.rotation??e.rotation,[i,a]=r%180===0?[e.codedWidth,e.codedHeight]:[e.codedHeight,e.codedWidth],s=i/a;t.width!==void 0&&t.height===void 0?(i=t.width,a=Math.round(i/s)):t.width===void 0&&t.height!==void 0?(a=t.height,i=Math.round(a*s)):t.width!==void 0&&t.height!==void 0&&(i=t.width,a=t.height),this._videoTrack=e,this._width=i,this._height=a,this._rotation=r,this._fit=t.fit??"fill",this._videoSampleSink=new et(e),this._canvasPool=Array.from({length:t.poolSize??0},()=>null)}_videoSampleToWrappedCanvas(e){let t=this._canvasPool[this._nextCanvasIndex];t||(typeof OffscreenCanvas<"u"?t=new OffscreenCanvas(this._width,this._height):(t=document.createElement("canvas"),t.width=this._width,t.height=this._height),this._canvasPool.length>0&&(this._canvasPool[this._nextCanvasIndex]=t)),this._canvasPool.length>0&&(this._nextCanvasIndex=(this._nextCanvasIndex+1)%this._canvasPool.length);let r=t.getContext("2d",{alpha:!1});f(r),r.resetTransform();let i,a,s,o;if(this._fit==="fill")i=0,a=0,s=this._width,o=this._height;else{let[u,l]=this._rotation%180===0?[e.codedWidth,e.codedHeight]:[e.codedHeight,e.codedWidth],m=this._fit==="contain"?Math.min(this._width/u,this._height/l):Math.max(this._width/u,this._height/l);s=u*m,o=l*m,i=(this._width-s)/2,a=(this._height-o)/2}let d=this._rotation%180===0?1:s/o;r.translate(this._width/2,this._height/2),r.rotate(this._rotation*Math.PI/180),r.scale(1/d,d),r.translate(-this._width/2,-this._height/2),r.drawImage(e.toCanvasImageSource(),i,a,s,o);let c={canvas:t,timestamp:e.timestamp,duration:e.duration};return e.close(),c}async getCanvas(e){Se(e);let t=await this._videoSampleSink.getSample(e);return t&&this._videoSampleToWrappedCanvas(t)}canvases(e=0,t=1/0){return ot(this._videoSampleSink.samples(e,t),r=>this._videoSampleToWrappedCanvas(r))}canvasesAtTimestamps(e){return ot(this._videoSampleSink.samplesAtTimestamps(e),t=>t&&this._videoSampleToWrappedCanvas(t))}},ga=class extends Pt{constructor(t,r,i,a){super(t,r);this.decoder=null;this.customDecoder=null;this.lastCustomDecoderPromise=Promise.resolve();this.customDecoderQueueSize=0;let s=d=>{let c=a.sampleRate;d.setTimestamp(Math.round(d.timestamp*c)/c),t(d)},o=dt.find(d=>d.supports(i,a));o?(this.customDecoder=new o,this.customDecoder.codec=i,this.customDecoder.config=a,this.customDecoder.onSample=s,this.customDecoder.init()):(this.decoder=new AudioDecoder({output:d=>s(new me(d)),error:r}),this.decoder.configure(a))}getDecodeQueueSize(){return this.customDecoder?this.customDecoderQueueSize:(f(this.decoder),this.decoder.decodeQueueSize)}decode(t){this.customDecoder?(this.customDecoderQueueSize++,this.lastCustomDecoderPromise=this.lastCustomDecoderPromise.then(()=>this.customDecoder.decode(t)),this.lastCustomDecoderPromise.then(()=>this.customDecoderQueueSize--)):(f(this.decoder),this.decoder.decode(t.toEncodedAudioChunk()))}flush(){return this.customDecoder?this.lastCustomDecoderPromise.then(()=>this.customDecoder.flush()):(f(this.decoder),this.decoder.flush())}close(){this.customDecoder?this.lastCustomDecoderPromise.then(()=>this.customDecoder.close()):(f(this.decoder),this.decoder.close())}},ba=class extends Pt{constructor(t,r,i){super(t,r);this.decoderConfig=i;this.currentTimestamp=null;f(D.includes(i.codec)),this.codec=i.codec;let{dataType:a,sampleSize:s,littleEndian:o}=J(this.codec);switch(this.inputSampleSize=s,s){case 1:a==="unsigned"?this.readInputValue=(d,c)=>d.getUint8(c)-2**7:a==="signed"?this.readInputValue=(d,c)=>d.getInt8(c):a==="ulaw"?this.readInputValue=(d,c)=>Ai(d.getUint8(c)):a==="alaw"?this.readInputValue=(d,c)=>Oi(d.getUint8(c)):f(!1);break;case 2:a==="unsigned"?this.readInputValue=(d,c)=>d.getUint16(c,o)-2**15:a==="signed"?this.readInputValue=(d,c)=>d.getInt16(c,o):f(!1);break;case 3:a==="unsigned"?this.readInputValue=(d,c)=>jr(d,c,o)-2**23:a==="signed"?this.readInputValue=(d,c)=>ja(d,c,o):f(!1);break;case 4:a==="unsigned"?this.readInputValue=(d,c)=>d.getUint32(c,o)-2**31:a==="signed"?this.readInputValue=(d,c)=>d.getInt32(c,o):a==="float"?this.readInputValue=(d,c)=>d.getFloat32(c,o):f(!1);break}switch(s){case 1:a==="ulaw"||a==="alaw"?(this.outputSampleSize=2,this.outputFormat="s16",this.writeOutputValue=(d,c,u)=>d.setInt16(c,u,!0)):(this.outputSampleSize=1,this.outputFormat="u8",this.writeOutputValue=(d,c,u)=>d.setUint8(c,u+2**7));break;case 2:this.outputSampleSize=2,this.outputFormat="s16",this.writeOutputValue=(d,c,u)=>d.setInt16(c,u,!0);break;case 3:this.outputSampleSize=4,this.outputFormat="s32",this.writeOutputValue=(d,c,u)=>d.setInt32(c,u<<8,!0);break;case 4:this.outputSampleSize=4,a==="float"?(this.outputFormat="f32",this.writeOutputValue=(d,c,u)=>d.setFloat32(c,u,!0)):(this.outputFormat="s32",this.writeOutputValue=(d,c,u)=>d.setInt32(c,u,!0));break}}getDecodeQueueSize(){return 0}decode(t){let r=Y(t.data),i=t.byteLength/this.decoderConfig.numberOfChannels/this.inputSampleSize,a=i*this.decoderConfig.numberOfChannels*this.outputSampleSize,s=new ArrayBuffer(a),o=new DataView(s);for(let l=0;l<i*this.decoderConfig.numberOfChannels;l++){let m=l*this.inputSampleSize,p=l*this.outputSampleSize,h=this.readInputValue(r,m);this.writeOutputValue(o,p,h)}let d=i/this.decoderConfig.sampleRate;(this.currentTimestamp===null||Math.abs(t.timestamp-this.currentTimestamp)>=d)&&(this.currentTimestamp=t.timestamp);let c=this.currentTimestamp;this.currentTimestamp+=d;let u=new me({format:this.outputFormat,data:s,numberOfChannels:this.decoderConfig.numberOfChannels,sampleRate:this.decoderConfig.sampleRate,numberOfFrames:i,timestamp:c});this.onSample(u)}async flush(){}close(){}},tt=class extends It{constructor(e){if(!(e instanceof G))throw new TypeError("audioTrack must be an InputAudioTrack.");super(),this._audioTrack=e}async _createDecoder(e,t){if(!await this._audioTrack.canDecode())throw new Error("This audio track cannot be decoded by this browser. Make sure to check decodability before using a track.");let r=this._audioTrack.codec,i=await this._audioTrack.getDecoderConfig();return f(r&&i),D.includes(i.codec)?new ba(e,t,i):new ga(e,t,r,i)}_createPacketSink(){return new fe(this._audioTrack)}async getSample(e){Se(e);for await(let t of this.mediaSamplesAtTimestamps([e]))return t;throw new Error("Internal error: Iterator returned nothing.")}samples(e=0,t=1/0){return this.mediaSamplesInRange(e,t)}samplesAtTimestamps(e){return this.mediaSamplesAtTimestamps(e)}},Et=class{constructor(e){if(!(e instanceof G))throw new TypeError("audioTrack must be an InputAudioTrack.");this._audioSampleSink=new tt(e)}_audioSampleToWrappedArrayBuffer(e){return{buffer:e.toAudioBuffer(),timestamp:e.timestamp,duration:e.duration}}async getBuffer(e){Se(e);let t=await this._audioSampleSink.getSample(e);return t&&this._audioSampleToWrappedArrayBuffer(t)}buffers(e=0,t=1/0){return ot(this._audioSampleSink.samples(e,t),r=>this._audioSampleToWrappedArrayBuffer(r))}buffersAtTimestamps(e){return ot(this._audioSampleSink.samplesAtTimestamps(e),t=>t&&this._audioSampleToWrappedArrayBuffer(t))}};var De=class{constructor(e){this._backing=e}isVideoTrack(){return this instanceof ce}isAudioTrack(){return this instanceof G}get id(){return this._backing.getId()}get languageCode(){return this._backing.getLanguageCode()}get timeResolution(){return this._backing.getTimeResolution()}getFirstTimestamp(){return this._backing.getFirstTimestamp()}computeDuration(){return this._backing.computeDuration()}async computePacketStats(){let e=new fe(this),t=1/0,r=-1/0,i=0,a=0;for await(let s of e.packets(void 0,void 0,{metadataOnly:!0}))t=Math.min(t,s.timestamp),r=Math.max(r,s.timestamp+s.duration),i++,a+=s.byteLength;return{packetCount:i,averagePacketRate:i?Number((i/(r-t)).toPrecision(16)):0,averageBitrate:i?Number((8*a/(r-t)).toPrecision(16)):0}}},ce=class extends De{constructor(e){super(e),this._backing=e}get type(){return"video"}get codec(){return this._backing.getCodec()}get codedWidth(){return this._backing.getCodedWidth()}get codedHeight(){return this._backing.getCodedHeight()}get rotation(){return this._backing.getRotation()}get displayWidth(){return this._backing.getRotation()%180===0?this._backing.getCodedWidth():this._backing.getCodedHeight()}get displayHeight(){return this._backing.getRotation()%180===0?this._backing.getCodedHeight():this._backing.getCodedWidth()}getColorSpace(){return this._backing.getColorSpace()}async hasHighDynamicRange(){let e=await this._backing.getColorSpace();return e.primaries==="bt2020"||e.primaries==="smpte432"||e.transfer==="pg"||e.transfer==="hlg"||e.matrix==="bt2020-ncl"}getDecoderConfig(){return this._backing.getDecoderConfig()}async getCodecParameterString(){return(await this._backing.getDecoderConfig())?.codec??null}async canDecode(){try{let e=await this._backing.getDecoderConfig();if(!e)return!1;let t=this._backing.getCodec();return f(t!==null),ct.some(i=>i.supports(t,e))?!0:typeof VideoDecoder>"u"?!1:(await VideoDecoder.isConfigSupported(e)).supported===!0}catch(e){return console.error("Error during decodability check:",e),!1}}},G=class extends De{constructor(e){super(e),this._backing=e}get type(){return"audio"}get codec(){return this._backing.getCodec()}get numberOfChannels(){return this._backing.getNumberOfChannels()}get sampleRate(){return this._backing.getSampleRate()}getDecoderConfig(){return this._backing.getDecoderConfig()}async getCodecParameterString(){return(await this._backing.getDecoderConfig())?.codec??null}async canDecode(){try{let e=await this._backing.getDecoderConfig();if(!e)return!1;let t=this._backing.getCodec();return f(t!==null),dt.some(r=>r.supports(t,e))||e.codec.startsWith("pcm-")?!0:typeof AudioDecoder>"u"?!1:(await AudioDecoder.isConfigSupported(e)).supported===!0}catch(e){return console.error("Error during decodability check:",e),!1}}};var ne=class{constructor(e,t=1/0){this.source=e;this.maxStorableBytes=t;this.loadedSegments=[];this.loadingSegments=[];this.sourceSizePromise=null;this.nextAge=0;this.totalStoredBytes=0}async loadRange(e,t){if(t=Math.min(t,await this.source._getSize()),e>=t)return;let r=this.loadingSegments.find(d=>d.start<=e&&d.end>=t);if(r){await r.promise;return}let i=R(this.loadedSegments,e,d=>d.start);if(i!==-1)for(let d=i;d<this.loadedSegments.length;d++){let c=this.loadedSegments[d];if(c.start>e)break;if(c.end>=t)return}this.source.onread?.({start:e,end:t});let a=this.source._read(e,t),s={start:e,end:t,promise:a};this.loadingSegments.push(s);let o=await a;qa(this.loadingSegments,s),this.insertIntoLoadedSegments(e,o)}insertIntoLoadedSegments(e,t){let r={start:e,end:e+t.byteLength,bytes:t,view:new DataView(t.buffer),age:this.nextAge++},i=R(this.loadedSegments,e,a=>a.start);(i===-1||this.loadedSegments[i].start<r.start)&&i++,this.loadedSegments.splice(i,0,r),this.totalStoredBytes+=t.byteLength;for(let a=i+1;a<this.loadedSegments.length;a++){let s=this.loadedSegments[a];if(s.start>=r.end)break;r.start<=s.start&&s.end<=r.end&&(this.loadedSegments.splice(a,1),a--)}for(;this.totalStoredBytes>this.maxStorableBytes&&this.loadedSegments.length>1;){let a=null,s=-1;for(let o=0;o<this.loadedSegments.length;o++){let d=this.loadedSegments[o];(!a||d.age<a.age)&&(a=d,s=o)}f(a),this.totalStoredBytes-=a.bytes.byteLength,this.loadedSegments.splice(s,1)}}getViewAndOffset(e,t){let r=R(this.loadedSegments,e,a=>a.start),i=null;if(r!==-1)for(let a=r;a<this.loadedSegments.length;a++){let s=this.loadedSegments[a];if(s.start>e)break;if(t<=s.end){i=s;break}}if(!i)throw new Error(`No segment loaded for range [${e}, ${t}).`);return i.age=this.nextAge++,{view:i.view,offset:i.bytes.byteOffset+e-i.start}}forgetRange(e,t){if(t<=e)return;let r=R(this.loadedSegments,e,a=>a.start);if(r===-1)return;let i=this.loadedSegments[r];i.start!==e||i.end!==t||(this.loadedSegments.splice(r,1),this.totalStoredBytes-=i.bytes.byteLength)}};var Ve=class{constructor(e){this.reader=e;this.pos=0;this.littleEndian=!0}readBytes(e){let{view:t,offset:r}=this.reader.getViewAndOffset(this.pos,this.pos+e);return this.pos+=e,new Uint8Array(t.buffer,r,e)}readU16(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+2);return this.pos+=2,e.getUint16(t,this.littleEndian)}readU32(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+4);return this.pos+=4,e.getUint32(t,this.littleEndian)}readAscii(e){let{view:t,offset:r}=this.reader.getViewAndOffset(this.pos,this.pos+e);this.pos+=e;let i="";for(let a=0;a<e;a++)i+=String.fromCharCode(t.getUint8(r+a));return i}};var Ar=class extends ie{constructor(t){super(t);this.metadataPromise=null;this.dataStart=-1;this.dataSize=-1;this.audioInfo=null;this.tracks=[];this.metadataReader=new Ve(t._mainReader),this.chunkReader=new Ve(new ne(t._source,64*2**20))}async readMetadata(){return this.metadataPromise??=(async()=>{let t=this.metadataReader.readAscii(4);this.metadataReader.littleEndian=t==="RIFF";let r=this.metadataReader.readU32()+8;if(this.metadataReader.readAscii(4)!=="WAVE")throw new Error("Invalid WAVE file - wrong format");for(this.metadataReader.pos=12;this.metadataReader.pos<r;){await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+8);let s=this.metadataReader.readAscii(4),o=this.metadataReader.readU32(),d=this.metadataReader.pos;s==="fmt "?await this.parseFmtChunk(o):s==="data"&&(this.dataStart=this.metadataReader.pos,this.dataSize=o),this.metadataReader.pos=d+o+(o&1)}if(!this.audioInfo)throw new Error('Invalid WAVE file - missing "fmt " chunk');if(this.dataStart===-1)throw new Error('Invalid WAVE file - missing "data" chunk');let a=this.audioInfo.blockSizeInBytes;this.dataSize=Math.floor(this.dataSize/a)*a,this.tracks.push(new G(new ka(this)))})()}async parseFmtChunk(t){await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+t);let r=this.metadataReader.readU16(),i=this.metadataReader.readU16(),a=this.metadataReader.readU32();this.metadataReader.pos+=4;let s=this.metadataReader.readU16(),o;if(t===14?o=8:o=this.metadataReader.readU16(),t>=18&&r!==357){let d=this.metadataReader.readU16(),c=t-18;if(Math.min(c,d)>=22&&r===65534){this.metadataReader.pos+=6;let l=this.metadataReader.readBytes(16);r=l[0]|l[1]<<8}}(r===7||r===6)&&(o=8),this.audioInfo={format:r,numberOfChannels:i,sampleRate:a,sampleSizeInBytes:Math.ceil(o/8),blockSizeInBytes:s}}getCodec(){if(f(this.audioInfo),this.audioInfo.format===7)return"ulaw";if(this.audioInfo.format===6)return"alaw";if(this.audioInfo.format===1){if(this.audioInfo.sampleSizeInBytes===1)return"pcm-u8";if(this.audioInfo.sampleSizeInBytes===2)return"pcm-s16";if(this.audioInfo.sampleSizeInBytes===3)return"pcm-s24";if(this.audioInfo.sampleSizeInBytes===4)return"pcm-s32"}return this.audioInfo.format===3&&this.audioInfo.sampleSizeInBytes===4?"pcm-f32":null}async getMimeType(){return"audio/wav"}async computeDuration(){return await this.readMetadata(),f(this.audioInfo),this.dataSize/this.audioInfo.blockSizeInBytes/this.audioInfo.sampleRate}async getTracks(){return await this.readMetadata(),this.tracks}},rt=2048,ka=class{constructor(e){this.demuxer=e}getId(){return 1}getCodec(){return this.demuxer.getCodec()}async getDecoderConfig(){let e=this.demuxer.getCodec();return e?(f(this.demuxer.audioInfo),{codec:e,numberOfChannels:this.demuxer.audioInfo.numberOfChannels,sampleRate:this.demuxer.audioInfo.sampleRate}):null}computeDuration(){return this.demuxer.computeDuration()}getNumberOfChannels(){return f(this.demuxer.audioInfo),this.demuxer.audioInfo.numberOfChannels}getSampleRate(){return f(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getTimeResolution(){return f(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getLanguageCode(){return j}async getFirstTimestamp(){return 0}async getPacketAtIndex(e,t){f(this.demuxer.audioInfo);let r=e*rt*this.demuxer.audioInfo.blockSizeInBytes;if(r>=this.demuxer.dataSize)return null;let i=Math.min(rt*this.demuxer.audioInfo.blockSizeInBytes,this.demuxer.dataSize-r),a;if(t.metadataOnly)a=te;else{let d=rt*this.demuxer.audioInfo.blockSizeInBytes,c=Math.ceil(2**19/d)*d,u=Math.floor(r/c)*c,l=u+c;await this.demuxer.chunkReader.reader.loadRange(this.demuxer.dataStart+u,this.demuxer.dataStart+l),this.demuxer.chunkReader.pos=this.demuxer.dataStart+r,a=this.demuxer.chunkReader.readBytes(i)}let s=e*rt/this.demuxer.audioInfo.sampleRate,o=i/this.demuxer.audioInfo.blockSizeInBytes/this.demuxer.audioInfo.sampleRate;return new V(a,"key",s,o,e)}getFirstPacket(e){return this.getPacketAtIndex(0,e)}getPacket(e,t){f(this.demuxer.audioInfo);let r=Math.floor(e*this.demuxer.audioInfo.sampleRate/rt);return this.getPacketAtIndex(r,t)}getNextPacket(e,t){f(this.demuxer.audioInfo);let r=Math.round(e.timestamp*this.demuxer.audioInfo.sampleRate/rt);return this.getPacketAtIndex(r+1,t)}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}};var Rr=class{constructor(e){this.writer=e;this.helper=new Uint8Array(8);this.helperView=new DataView(this.helper.buffer)}writeU32(e){this.helperView.setUint32(0,e,!0),this.writer.write(this.helper.subarray(0,4))}writeU16(e){this.helperView.setUint16(0,e,!0),this.writer.write(this.helper.subarray(0,2))}writeAscii(e){this.writer.write(new TextEncoder().encode(e))}};var Or=class extends ae{constructor(t){super(t);this.headerWritten=!1;this.dataSize=0;this.writer=t._writer,this.riffWriter=new Rr(t._writer)}async start(){}async addEncodedVideoPacket(){throw new Error("WAVE does not support video.")}async addEncodedAudioPacket(t,r,i){let a=await this.mutex.acquire();try{if(!this.headerWritten){if(!i?.decoderConfig)throw new Error("Decoder config is required for first audio sample.");this.writeHeader(t,i.decoderConfig),this.headerWritten=!0}this.validateAndNormalizeTimestamp(t,r.timestamp,r.type==="key"),this.writer.write(r.data),this.dataSize+=r.data.byteLength,await this.writer.flush()}finally{a()}}async addSubtitleCue(){throw new Error("WAVE does not support subtitles.")}writeHeader(t,r){let i,a=t.source._codec,s=J(a);s.dataType==="ulaw"?i=7:s.dataType==="alaw"?i=6:s.dataType==="float"?i=3:i=1;let o=r.numberOfChannels,d=r.sampleRate,c=s.sampleSize*o;this.riffWriter.writeAscii("RIFF"),this.riffWriter.writeU32(0),this.riffWriter.writeAscii("WAVE"),this.riffWriter.writeAscii("fmt "),this.riffWriter.writeU32(16),this.riffWriter.writeU16(i),this.riffWriter.writeU16(o),this.riffWriter.writeU32(d),this.riffWriter.writeU32(d*c),this.riffWriter.writeU16(c),this.riffWriter.writeU16(8*s.sampleSize),this.riffWriter.writeAscii("data"),this.riffWriter.writeU32(0)}async finalize(){let t=await this.mutex.acquire(),r=this.writer.getPos();this.writer.seek(4),this.riffWriter.writeU32(this.dataSize+36),this.writer.seek(40),this.riffWriter.writeU32(this.dataSize),this.writer.seek(r),t()}};var pe=class{getSupportedVideoCodecs(){return this.getSupportedCodecs().filter(e=>H.includes(e))}getSupportedAudioCodecs(){return this.getSupportedCodecs().filter(e=>q.includes(e))}getSupportedSubtitleCodecs(){return this.getSupportedCodecs().filter(e=>re.includes(e))}_codecUnsupportedHint(e){return""}},_t=class extends pe{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.fastStart!==void 0&&![!1,"in-memory","fragmented"].includes(e.fastStart))throw new TypeError('options.fastStart, when provided, must be false, "in-memory", or "fragmented".');super(),this._options=e}getSupportedTrackCounts(){return{video:{min:0,max:1/0},audio:{min:0,max:1/0},subtitle:{min:0,max:1/0},total:{min:1,max:2**32-1}}}get supportsVideoRotationMetadata(){return!0}_createMuxer(e){return new gr(e,this)}},Fr=class extends _t{get _name(){return"MP4"}get fileExtension(){return".mp4"}getSupportedCodecs(){return[...H,...we,...re]}_codecUnsupportedHint(e){return new Ge().getSupportedCodecs().includes(e)?" Switching to MOV will grant support for this codec.":""}},Ge=class extends _t{get _name(){return"MOV"}get fileExtension(){return".mov"}getSupportedCodecs(){return[...H,...q]}_codecUnsupportedHint(e){return new Fr().getSupportedCodecs().includes(e)?" Switching to MP4 will grant support for this codec.":""}},At=class extends pe{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.streamable!==void 0&&typeof e.streamable!="boolean")throw new TypeError("options.streamable, when provided, must be a boolean.");super(),this._options=e}_createMuxer(e){return new kr(e,this)}get _name(){return"Matroska"}getSupportedTrackCounts(){return{video:{min:0,max:1/0},audio:{min:0,max:1/0},subtitle:{min:0,max:1/0},total:{min:1,max:127}}}get fileExtension(){return".mkv"}getSupportedCodecs(){return[...H,...we,...D.filter(e=>!["pcm-s8","pcm-f32be","ulaw","alaw"].includes(e)),...re]}get supportsVideoRotationMetadata(){return!1}},wt=class extends At{getSupportedCodecs(){return[...H.filter(e=>["vp8","vp9","av1"].includes(e)),...q.filter(e=>["opus","vorbis"].includes(e)),...re]}get _name(){return"WebM"}get fileExtension(){return".webm"}_codecUnsupportedHint(e){return new At().getSupportedCodecs().includes(e)?" Switching to MKV will grant support for this codec.":""}},wa=class extends pe{_createMuxer(e){return new xr(e)}get _name(){return"MP3"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:1,max:1},subtitle:{min:0,max:0},total:{min:1,max:1}}}get fileExtension(){return".mp3"}getSupportedCodecs(){return["mp3"]}get supportsVideoRotationMetadata(){return!1}},Ta=class extends pe{_createMuxer(e){return new Or(e)}get _name(){return"WAVE"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:1,max:1},subtitle:{min:0,max:0},total:{min:1,max:1}}}get fileExtension(){return".wav"}getSupportedCodecs(){return[...D.filter(e=>["pcm-s16","pcm-s24","pcm-s32","pcm-f32","pcm-u8","ulaw","alaw"].includes(e))]}get supportsVideoRotationMetadata(){return!1}},Sa=class extends pe{_createMuxer(e){return new Er(e)}get _name(){return"Ogg"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:0,max:1/0},subtitle:{min:0,max:0},total:{min:1,max:2**32}}}get fileExtension(){return".ogg"}getSupportedCodecs(){return[...q.filter(e=>["vorbis","opus"].includes(e))]}get supportsVideoRotationMetadata(){return!1}};var at=class{constructor(){this._connectedTrack=null;this._closingPromise=null;this._closed=!1;this._offsetTimestamps=!1}_ensureValidAdd(){if(!this._connectedTrack)throw new Error("Source is not connected to an output track.");if(this._connectedTrack.output.state==="canceled")throw new Error("Output has been canceled.");if(this._connectedTrack.output.state==="finalizing"||this._connectedTrack.output.state==="finalized")throw new Error("Output has been finalized.");if(this._connectedTrack.output.state==="pending")throw new Error("Output has not started.");if(this._closed)throw new Error("Source is closed.")}_start(){}async _flush(){}close(){if(this._closingPromise)throw new Error("Source already closed.");let e=this._connectedTrack;if(!e)throw new Error("Cannot call close without connecting the source to an output track.");if(e.output.state==="pending")throw new Error("Cannot call close before output has been started.");return this._closingPromise=(async()=>{await this._flush(),this._closed=!0,!(e.output.state==="finalizing"||e.output.state==="finalized")&&e.output._muxer.onTrackClose(e)})()}async _flushOrWaitForClose(){return this._closingPromise?this._closingPromise:this._flush()}},ye=class extends at{constructor(t){super();this._connectedTrack=null;if(!H.includes(t))throw new TypeError(`Invalid video codec '${t}'. Must be one of: ${H.join(", ")}.`);this._codec=t}},Rt=class extends ye{constructor(e){super(e)}add(e,t){if(!(e instanceof V))throw new TypeError("packet must be an EncodedPacket.");if(e.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be added.");return this._ensureValidAdd(),this._connectedTrack.output._muxer.addEncodedVideoPacket(this._connectedTrack,e,t)}},Ia=n=>{if(!n||typeof n!="object")throw new TypeError("Encoding config must be an object.");if(!H.includes(n.codec))throw new TypeError(`Invalid video codec '${n.codec}'. Must be one of: ${H.join(", ")}.`);if(!(n.bitrate instanceof X)&&(!Number.isInteger(n.bitrate)||n.bitrate<=0))throw new TypeError("config.bitrate must be a positive integer or a quality.");if(n.latencyMode!==void 0&&!["quality","realtime"].includes(n.latencyMode))throw new TypeError("config.latencyMode, when provided, must be 'quality' or 'realtime'.");if(n.keyFrameInterval!==void 0&&(!Number.isFinite(n.keyFrameInterval)||n.keyFrameInterval<0))throw new TypeError("config.keyFrameInterval, when provided, must be a non-negative number.");if(n.onEncodedPacket!==void 0&&typeof n.onEncodedPacket!="function")throw new TypeError("config.onEncodedChunk, when provided, must be a function.");if(n.onEncodingError!==void 0&&typeof n.onEncodingError!="function")throw new TypeError("config.onEncodingError, when provided, must be a function.")},Ot=class{constructor(e,t){this.source=e;this.encodingConfig=t;this.ensureEncoderPromise=null;this.encoderInitialized=!1;this.encoder=null;this.muxer=null;this.lastMultipleOfKeyFrameInterval=-1;this.lastWidth=null;this.lastHeight=null;this.customEncoder=null;this.lastCustomEncoderPromise=Promise.resolve();this.customEncoderQueueSize=0}async add(e,t,r){if(this.source._ensureValidAdd(),this.lastWidth!==null&&this.lastHeight!==null){if(e.codedWidth!==this.lastWidth||e.codedHeight!==this.lastHeight)throw new Error(`Video sample size must remain constant. Expected ${this.lastWidth}x${this.lastHeight}, got ${e.codedWidth}x${e.codedHeight}.`)}else this.lastWidth=e.codedWidth,this.lastHeight=e.codedHeight;this.encoderInitialized||(this.ensureEncoderPromise?await this.ensureEncoderPromise:await this.ensureEncoder(e)),f(this.encoderInitialized);let i=this.encodingConfig.keyFrameInterval??5,a=Math.floor(e.timestamp/i),s={...r,keyFrame:r?.keyFrame||i===0||a!==this.lastMultipleOfKeyFrameInterval};if(this.lastMultipleOfKeyFrameInterval=a,this.customEncoder)this.customEncoderQueueSize++,this.lastCustomEncoderPromise=this.lastCustomEncoderPromise.then(()=>this.customEncoder.encode(e,s)),this.lastCustomEncoderPromise.then(()=>{this.customEncoderQueueSize--,t&&e.close()}),this.customEncoderQueueSize>=4&&await this.lastCustomEncoderPromise;else{f(this.encoder);let o=e.toVideoFrame();this.encoder.encode(o,s),o.close(),t&&e.close(),this.encoder.encodeQueueSize>=4&&await new Promise(d=>this.encoder.addEventListener("dequeue",d,{once:!0}))}await this.muxer.mutex.currentPromise}async ensureEncoder(e){if(this.encoder)return;let{promise:t,resolve:r}=W();this.ensureEncoderPromise=t;let i=e.codedWidth,a=e.codedHeight,s=this.encodingConfig.bitrate instanceof X?this.encodingConfig.bitrate._toVideoBitrate(this.encodingConfig.codec,i,a):this.encodingConfig.bitrate,o={codec:Yt(this.encodingConfig.codec,i,a,s),width:i,height:a,bitrate:s,framerate:this.source._connectedTrack?.metadata.frameRate,latencyMode:this.encodingConfig.latencyMode,...Jt(this.encodingConfig.codec)},d=We.find(c=>c.supports(this.encodingConfig.codec,o));if(d)this.customEncoder=new d,this.customEncoder.codec=this.encodingConfig.codec,this.customEncoder.config=o,this.customEncoder.onPacket=(c,u)=>{this.encodingConfig.onEncodedPacket?.(c,u),this.muxer.addEncodedVideoPacket(this.source._connectedTrack,c,u)},this.customEncoder.init();else{if(typeof VideoEncoder>"u")throw new Error("VideoEncoder is not supported by this browser.");if(!(await VideoEncoder.isConfigSupported(o)).supported)throw new Error("This specific encoder configuration is not supported by this browser. Consider using another codec or changing your video parameters.");this.encoder=new VideoEncoder({output:(u,l)=>{let m=V.fromEncodedChunk(u);this.encodingConfig.onEncodedPacket?.(m,l),this.muxer.addEncodedVideoPacket(this.source._connectedTrack,m,l)},error:this.encodingConfig.onEncodingError??(u=>console.error("VideoEncoder error:",u))}),this.encoder.configure(o)}f(this.source._connectedTrack),this.muxer=this.source._connectedTrack.output._muxer,this.encoderInitialized=!0,r()}async flush(){this.customEncoder?await this.lastCustomEncoderPromise.then(()=>this.customEncoder.flush()):this.encoder&&(await this.encoder.flush(),this.encoder.close())}getQueueSize(){return this.customEncoder?this.customEncoderQueueSize:(f(this.encoder),this.encoder.encodeQueueSize)}},it=class extends ye{constructor(e){Ia(e),super(e.codec),this._encoder=new Ot(this,e)}add(e,t){if(!(e instanceof oe))throw new TypeError("videoSample must be a VideoSample.");return this._encoder.add(e,!1,t)}_flush(){return this._encoder.flush()}},ya=class extends ye{constructor(e,t){if(!(typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement)&&!(typeof OffscreenCanvas<"u"&&e instanceof OffscreenCanvas))throw new TypeError("canvas must be an HTMLCanvasElement or OffscreenCanvas.");Ia(t),super(t.codec),this._encoder=new Ot(this,t),this._canvas=e}add(e,t=0,r){if(!Number.isFinite(e)||e<0)throw new TypeError("timestamp must be a non-negative number.");if(!Number.isFinite(t)||t<0)throw new TypeError("duration must be a non-negative number.");let i=new oe(this._canvas,{timestamp:e,duration:t});return this._encoder.add(i,!0,r)}_flush(){return this._encoder.flush()}},xa=class extends ye{constructor(t,r){if(!(t instanceof MediaStreamTrack)||t.kind!=="video")throw new TypeError("track must be a video MediaStreamTrack.");Ia(r),r={...r,latencyMode:"realtime"};super(r.codec);this._abortController=null;this._offsetTimestamps=!0;this._encoder=new Ot(this,r),this._track=t}_start(){this._abortController=new AbortController;let t=new MediaStreamTrackProcessor({track:this._track}),r=new WritableStream({write:i=>{if(this._encoder.getQueueSize()>=4){i.close();return}this._encoder.add(new oe(i),!0)}});t.readable.pipeTo(r,{signal:this._abortController.signal}).catch(i=>{i instanceof DOMException&&i.name==="AbortError"||console.error("Pipe error:",i)})}async _flush(){this._abortController&&(this._abortController.abort(),this._abortController=null),await this._encoder.flush()}},xe=class extends at{constructor(t){super();this._connectedTrack=null;if(!q.includes(t))throw new TypeError(`Invalid audio codec '${t}'. Must be one of: ${q.join(", ")}.`);this._codec=t}},Ft=class extends xe{constructor(e){super(e)}add(e,t){if(!(e instanceof V))throw new TypeError("packet must be an EncodedPacket.");if(e.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be added.");return this._ensureValidAdd(),this._connectedTrack.output._muxer.addEncodedAudioPacket(this._connectedTrack,e,t)}},va=n=>{if(!n||typeof n!="object")throw new TypeError("Encoding config must be an object.");if(!q.includes(n.codec))throw new TypeError(`Invalid audio codec '${n.codec}'. Must be one of: ${q.join(", ")}.`);if(n.bitrate===void 0&&(!D.includes(n.codec)||n.codec==="flac"))throw new TypeError("config.bitrate must be provided for compressed audio codecs.");if(n.bitrate!==void 0&&!(n.bitrate instanceof X)&&(!Number.isInteger(n.bitrate)||n.bitrate<=0))throw new TypeError("config.bitrate, when provided, must be a positive integer or a quality.");if(n.onEncodingError!==void 0&&typeof n.onEncodingError!="function")throw new TypeError("config.onEncodingError, when provided, must be a function.")},Mt=class{constructor(e,t){this.source=e;this.encodingConfig=t;this.ensureEncoderPromise=null;this.encoderInitialized=!1;this.encoder=null;this.muxer=null;this.lastNumberOfChannels=null;this.lastSampleRate=null;this.isPcmEncoder=!1;this.outputSampleSize=null;this.writeOutputValue=null;this.customEncoder=null;this.lastCustomEncoderPromise=Promise.resolve();this.customEncoderQueueSize=0}async add(e,t){if(this.source._ensureValidAdd(),this.lastNumberOfChannels!==null&&this.lastSampleRate!==null){if(e.numberOfChannels!==this.lastNumberOfChannels||e.sampleRate!==this.lastSampleRate)throw new Error(`Audio parameters must remain constant. Expected ${this.lastNumberOfChannels} channels at ${this.lastSampleRate} Hz, got ${e.numberOfChannels} channels at ${e.sampleRate} Hz.`)}else this.lastNumberOfChannels=e.numberOfChannels,this.lastSampleRate=e.sampleRate;if(this.encoderInitialized||(this.ensureEncoderPromise?await this.ensureEncoderPromise:await this.ensureEncoder(e)),f(this.encoderInitialized),this.customEncoder)this.customEncoderQueueSize++,this.lastCustomEncoderPromise=this.lastCustomEncoderPromise.then(()=>this.customEncoder.encode(e)),this.lastCustomEncoderPromise.then(()=>{this.customEncoderQueueSize--,t&&e.close()}),this.customEncoderQueueSize>=4&&await this.lastCustomEncoderPromise,await this.muxer.mutex.currentPromise;else if(this.isPcmEncoder)await this.doPcmEncoding(e,t);else{f(this.encoder);let r=e.toAudioData();this.encoder.encode(r),r.close(),t&&e.close(),this.encoder.encodeQueueSize>=4&&await new Promise(i=>this.encoder.addEventListener("dequeue",i,{once:!0})),await this.muxer.mutex.currentPromise}}async doPcmEncoding(e,t){f(this.outputSampleSize),f(this.writeOutputValue);let{numberOfChannels:r,numberOfFrames:i,sampleRate:a,timestamp:s}=e,o=2048,d=[];for(let m=0;m<i;m+=o){let p=Math.min(o,e.numberOfFrames-m),h=p*r*this.outputSampleSize,b=new ArrayBuffer(h),g=new DataView(b);d.push({frameCount:p,view:g})}let c=e.allocationSize({planeIndex:0,format:"f32-planar"}),u=new Float32Array(c/Float32Array.BYTES_PER_ELEMENT);for(let m=0;m<r;m++){e.copyTo(u,{planeIndex:m,format:"f32-planar"});for(let p=0;p<d.length;p++){let{frameCount:h,view:b}=d[p];for(let g=0;g<h;g++)this.writeOutputValue(b,(g*r+m)*this.outputSampleSize,u[p*o+g])}}t&&e.close();let l={decoderConfig:{codec:this.encodingConfig.codec,numberOfChannels:r,sampleRate:a}};for(let m=0;m<d.length;m++){let{frameCount:p,view:h}=d[m],b=h.buffer,g=m*o,k=new V(new Uint8Array(b),"key",s+g/a,p/a);this.encodingConfig.onEncodedPacket?.(k,l),await this.muxer.addEncodedAudioPacket(this.source._connectedTrack,k,l)}}async ensureEncoder(e){if(this.encoderInitialized)return;let{promise:t,resolve:r}=W();this.ensureEncoderPromise=t;let{numberOfChannels:i,sampleRate:a}=e,s=this.encodingConfig.bitrate instanceof X?this.encodingConfig.bitrate._toAudioBitrate(this.encodingConfig.codec):this.encodingConfig.bitrate,o={codec:Zt(this.encodingConfig.codec,i,a),numberOfChannels:i,sampleRate:a,bitrate:s,...er(this.encodingConfig.codec)},d=Le.find(c=>c.supports(this.encodingConfig.codec,o));if(d)this.customEncoder=new d,this.customEncoder.codec=this.encodingConfig.codec,this.customEncoder.config=o,this.customEncoder.onPacket=(c,u)=>{this.encodingConfig.onEncodedPacket?.(c,u),this.muxer.addEncodedAudioPacket(this.source._connectedTrack,c,u)},this.customEncoder.init();else if(D.includes(this.encodingConfig.codec))this.initPcmEncoder();else{if(typeof AudioEncoder>"u")throw new Error("AudioEncoder is not supported by this browser.");if(!(await AudioEncoder.isConfigSupported(o)).supported)throw new Error("This specific encoder configuration not supported by this browser. Consider using another codec or changing your audio parameters.");this.encoder=new AudioEncoder({output:(u,l)=>{let m=V.fromEncodedChunk(u);this.encodingConfig.onEncodedPacket?.(m,l),this.muxer.addEncodedAudioPacket(this.source._connectedTrack,m,l)},error:this.encodingConfig.onEncodingError??(u=>console.error("AudioEncoder error:",u))}),this.encoder.configure(o)}f(this.source._connectedTrack),this.muxer=this.source._connectedTrack.output._muxer,this.encoderInitialized=!0,r()}initPcmEncoder(){this.isPcmEncoder=!0;let e=this.encodingConfig.codec,{dataType:t,sampleSize:r,littleEndian:i}=J(e);switch(this.outputSampleSize=r,r){case 1:t==="unsigned"?this.writeOutputValue=(a,s,o)=>a.setUint8(s,L((o+1)*127.5,0,255)):t==="signed"?this.writeOutputValue=(a,s,o)=>{a.setInt8(s,L(Math.round(o*128),-128,127))}:t==="ulaw"?this.writeOutputValue=(a,s,o)=>{let d=L(Math.floor(o*32767),-32768,32767);a.setUint8(s,_i(d))}:t==="alaw"?this.writeOutputValue=(a,s,o)=>{let d=L(Math.floor(o*32767),-32768,32767);a.setUint8(s,Ri(d))}:f(!1);break;case 2:t==="unsigned"?this.writeOutputValue=(a,s,o)=>a.setUint16(s,L((o+1)*32767.5,0,65535),i):t==="signed"?this.writeOutputValue=(a,s,o)=>a.setInt16(s,L(Math.round(o*32767),-32768,32767),i):f(!1);break;case 3:t==="unsigned"?this.writeOutputValue=(a,s,o)=>Xr(a,s,L((o+1)*83886075e-1,0,16777215),i):t==="signed"?this.writeOutputValue=(a,s,o)=>Xa(a,s,L(Math.round(o*8388607),-8388608,8388607),i):f(!1);break;case 4:t==="unsigned"?this.writeOutputValue=(a,s,o)=>a.setUint32(s,L((o+1)*21474836475e-1,0,4294967295),i):t==="signed"?this.writeOutputValue=(a,s,o)=>a.setInt32(s,L(Math.round(o*2147483647),-2147483648,2147483647),i):t==="float"?this.writeOutputValue=(a,s,o)=>a.setFloat32(s,o,i):f(!1)}}async flush(){this.customEncoder?await this.lastCustomEncoderPromise.then(()=>this.customEncoder.flush()):this.encoder&&(await this.encoder.flush(),this.encoder.close())}getQueueSize(){return this.customEncoder?this.customEncoderQueueSize:this.isPcmEncoder?0:(f(this.encoder),this.encoder.encodeQueueSize)}},Dt=class extends xe{constructor(e){va(e),super(e.codec),this._encoder=new Mt(this,e)}add(e){if(!(e instanceof me))throw new TypeError("audioSample must be an AudioSample.");return this._encoder.add(e,!1)}_flush(){return this._encoder.flush()}},Vt=class extends xe{constructor(t){va(t);super(t.codec);this._accumulatedFrameCount=0;this._encoder=new Mt(this,t)}add(t){if(!(t instanceof AudioBuffer))throw new TypeError("audioBuffer must be an AudioBuffer.");let r=64*1024*1024,i=t.numberOfChannels,a=t.sampleRate,s=t.length,o=Math.floor(r/i),d=0,c=s,u=[];for(;c>0;){let l=Math.min(o,c),m=new Float32Array(i*l);for(let h=0;h<i;h++)t.copyFromChannel(m.subarray(h*l,h*l+l),h,d);let p=new me({format:"f32-planar",sampleRate:a,numberOfFrames:l,numberOfChannels:i,timestamp:(this._accumulatedFrameCount+d)/a,data:m});u.push(this._encoder.add(p,!0)),d+=l,c-=l}return this._accumulatedFrameCount+=s,Promise.all(u)}_flush(){return this._encoder.flush()}},Ca=class extends xe{constructor(t,r){if(!(t instanceof MediaStreamTrack)||t.kind!=="audio")throw new TypeError("track must be an audio MediaStreamTrack.");va(r);super(r.codec);this._abortController=null;this._offsetTimestamps=!0;this._encoder=new Mt(this,r),this._track=t}_start(){this._abortController=new AbortController;let t=new MediaStreamTrackProcessor({track:this._track}),r=new WritableStream({write:i=>{if(this._encoder.getQueueSize()>=4){i.close();return}this._encoder.add(new me(i),!0)}});t.readable.pipeTo(r,{signal:this._abortController.signal}).catch(i=>{i instanceof DOMException&&i.name==="AbortError"||console.error("Pipe error:",i)})}async _flush(){this._abortController&&(this._abortController.abort(),this._abortController=null),await this._encoder.flush()}},nt=class extends at{constructor(t){super();this._connectedTrack=null;if(!re.includes(t))throw new TypeError(`Invalid subtitle codec '${t}'. Must be one of: ${re.join(", ")}.`);this._codec=t}},Pa=class extends nt{constructor(e){super(e),this._parser=new dr({codec:e,output:(t,r)=>this._connectedTrack?.output._muxer.addSubtitleCue(this._connectedTrack,t,r)})}add(e){if(typeof e!="string")throw new TypeError("text must be a string.");return this._ensureValidAdd(),this._parser.parse(e),this._connectedTrack.output._muxer.mutex.currentPromise}};var Fi=["video","audio","subtitle"],Ea=n=>{if(!n||typeof n!="object")throw new TypeError("metadata must be an object.");if(n.languageCode!==void 0&&!Ne(n.languageCode))throw new TypeError("metadata.languageCode must be a three-letter, ISO 639-2 language code.")},zt=class{constructor(e){this.state="pending";this._tracks=[];this._startPromise=null;this._cancelPromise=null;this._finalizePromise=null;this._mutex=new de;if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(!(e.format instanceof pe))throw new TypeError("options.format must be an OutputFormat.");if(!(e.target instanceof Oe))throw new TypeError("options.target must be a Target.");if(e.target._output)throw new Error("Target is already used for another output.");e.target._output=this,this.format=e.format,this.target=e.target,this._writer=e.target._createWriter(),this._muxer=e.format._createMuxer(this)}addVideoTrack(e,t={}){if(!(e instanceof ye))throw new TypeError("source must be a VideoSource.");if(Ea(t),t.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError(`Invalid video rotation: ${t.rotation}. Has to be 0, 90, 180 or 270.`);if(!this.format.supportsVideoRotationMetadata&&t.rotation)throw new Error(`${this.format._name} does not support video rotation metadata.`);if(t.frameRate!==void 0&&(!Number.isInteger(t.frameRate)||t.frameRate<=0))throw new TypeError(`Invalid video frame rate: ${t.frameRate}. Must be a positive integer.`);this._addTrack("video",e,t)}addAudioTrack(e,t={}){if(!(e instanceof xe))throw new TypeError("source must be an AudioSource.");Ea(t),this._addTrack("audio",e,t)}addSubtitleTrack(e,t={}){if(!(e instanceof nt))throw new TypeError("source must be a SubtitleSource.");Ea(t),this._addTrack("subtitle",e,t)}_addTrack(e,t,r){if(this.state!=="pending")throw new Error("Cannot add track after output has been started or canceled.");if(t._connectedTrack)throw new Error("Source is already used for a track.");let i=this.format.getSupportedTrackCounts(),a=this._tracks.reduce((c,u)=>c+(u.type===e?1:0),0),s=i[e].max;if(a===s)throw new Error(s===0?`${this.format._name} does not support ${e} tracks.`:`${this.format._name} does not support more than ${s} ${e} track${s===1?"":"s"}.`);let o=i.total.max;if(this._tracks.length===o)throw new Error(`${this.format._name} does not support more than ${o} tracks${o===1?"":"s"} in total.`);let d={id:this._tracks.length+1,output:this,type:e,source:t,metadata:r};if(d.type==="video"){let c=this.format.getSupportedVideoCodecs();if(c.length===0)throw new Error(`${this.format._name} does not support video tracks.`+this.format._codecUnsupportedHint(d.source._codec));if(!c.includes(d.source._codec))throw new Error(`Codec '${d.source._codec}' cannot be contained within ${this.format._name}. Supported video codecs are: ${c.map(u=>`'${u}'`).join(", ")}.`+this.format._codecUnsupportedHint(d.source._codec))}else if(d.type==="audio"){let c=this.format.getSupportedAudioCodecs();if(c.length===0)throw new Error(`${this.format._name} does not support audio tracks.`+this.format._codecUnsupportedHint(d.source._codec));if(!c.includes(d.source._codec))throw new Error(`Codec '${d.source._codec}' cannot be contained within ${this.format._name}. Supported audio codecs are: ${c.map(u=>`'${u}'`).join(", ")}.`+this.format._codecUnsupportedHint(d.source._codec))}else if(d.type==="subtitle"){let c=this.format.getSupportedSubtitleCodecs();if(c.length===0)throw new Error(`${this.format._name} does not support subtitle tracks.`+this.format._codecUnsupportedHint(d.source._codec));if(!c.includes(d.source._codec))throw new Error(`Codec '${d.source._codec}' cannot be contained within ${this.format._name}. Supported subtitle codecs are: ${c.map(u=>`'${u}'`).join(", ")}.`+this.format._codecUnsupportedHint(d.source._codec))}this._tracks.push(d),t._connectedTrack=d}async start(){let e=this.format.getSupportedTrackCounts();for(let r of Fi){let i=this._tracks.reduce((s,o)=>s+(o.type===r?1:0),0),a=e[r].min;if(i<a)throw new Error(a===e[r].max?`${this.format._name} requires exactly ${a} ${r} track${a===1?"":"s"}.`:`${this.format._name} requires at least ${a} ${r} track${a===1?"":"s"}.`)}let t=e.total.min;if(this._tracks.length<t)throw new Error(t===e.total.max?`${this.format._name} requires exactly ${t} track${t===1?"":"s"}.`:`${this.format._name} requires at least ${t} track${t===1?"":"s"}.`);if(this.state==="canceled")throw new Error("Output has been canceled.");return this._startPromise?(console.warn("Output has already been started."),this._startPromise):this._startPromise=(async()=>{this.state="started",this._writer.start();let r=await this._mutex.acquire();await this._muxer.start();for(let i of this._tracks)i.source._start();r()})()}async cancel(){if(this._cancelPromise)return console.warn("Output has already been canceled."),this._cancelPromise;if(this.state==="finalizing"||this.state==="finalized"){console.warn("Output has already been finalized.");return}return this._cancelPromise=(async()=>{this.state="canceled";let e=await this._mutex.acquire(),t=this._tracks.map(r=>r.source._flushOrWaitForClose());await Promise.all(t),await this._writer.close(),e()})()}async finalize(){if(this.state==="pending")throw new Error("Cannot finalize before starting.");if(this.state==="canceled")throw new Error("Cannot finalize after canceling.");return this._finalizePromise?(console.warn("Output has already been finalized."),this._finalizePromise):this._finalizePromise=(async()=>{this.state="finalizing";let e=await this._mutex.acquire(),t=this._tracks.map(r=>r.source._flushOrWaitForClose());await Promise.all(t),await this._muxer.finalize(),await this._writer.flush(),await this._writer.finalize(),this.state="finalized",e()})()}};var Ce=class{constructor(){this._sizePromise=null;this.onread=null}_getSize(){return this._sizePromise??=this._retrieveSize()}},_a=class extends Ce{constructor(e){if(!(e instanceof ArrayBuffer)&&!(e instanceof Uint8Array))throw new TypeError("buffer must be an ArrayBuffer or Uint8Array.");super(),this._bytes=e instanceof Uint8Array?e:new Uint8Array(e)}async _read(e,t){return this._bytes.subarray(e,t)}async _retrieveSize(){return this._bytes.byteLength}},Aa=class extends Ce{constructor(e){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(typeof e.read!="function")throw new TypeError("options.read must be a function.");if(typeof e.getSize!="function")throw new TypeError("options.getSize must be a function.");super(),this._options=e}async _read(e,t){return this._options.read(e,t)}async _retrieveSize(){return this._options.getSize()}},Ra=class extends Ce{constructor(e){if(!(e instanceof Blob))throw new TypeError("blob must be a Blob.");super(),this._blob=e}async _read(e,t){let i=await this._blob.slice(e,t).arrayBuffer();return new Uint8Array(i)}async _retrieveSize(){return this._blob.size}},Oa=class extends Ce{constructor(t,r={}){if(typeof t!="string")throw new TypeError("url must be a string.");if(!r||typeof r!="object")throw new TypeError("options must be an object.");if(r.withCredentials!==void 0&&typeof r.withCredentials!="boolean")throw new TypeError("options.withCredentials, when specified, must be a boolean.");super();this._fullData=null;this._url=t,this._withCredentials=r.withCredentials??!1}_makeRequest(t){return new Promise((r,i)=>{let a=new XMLHttpRequest;a.open("GET",this._url,!0),a.responseType="arraybuffer",a.withCredentials=this._withCredentials,t&&a.setRequestHeader("Range",`bytes=${t.start}-${t.end-1}`),a.onload=()=>{if(a.status>=200&&a.status<300){let s=a.response;t||(this._fullData=s),r({response:s,statusCode:a.status})}else i(new Error(`Error fetching ${this._url}: ${a.status} ${a.statusText}`))},a.onerror=()=>{i(new Error("Network error occurred."))},a.ontimeout=()=>{i(new Error("Request timed out."))},a.send()})}async _read(t,r){if(this._fullData)return new Uint8Array(this._fullData,t,r-t);let{response:i,statusCode:a}=await this._makeRequest({start:t,end:r});return a===200?new Uint8Array(i).subarray(t,r):new Uint8Array(i)}async _retrieveSize(){if(this._fullData)return this._fullData.byteLength;let t=new XMLHttpRequest;t.open("GET",this._url,!0),t.responseType="arraybuffer",t.withCredentials=this._withCredentials,t.setRequestHeader("Range","bytes=0-0"),await new Promise((s,o)=>{t.onload=()=>{t.status>=200&&t.status<300?s():o(new Error(`Error fetching ${this._url} (Range): ${t.status} ${t.statusText}`))},t.onerror=()=>{o(new Error("Network error occurred."))},t.send()});let r=t.getResponseHeader("Content-Range");if(r){let s=r.match(/bytes \d+-\d+\/(\d+)/);if(s&&s[1])return parseInt(s[1],10)}let i=t.getResponseHeader("Content-Length");if(i)return parseInt(i,10);let{response:a}=await this._makeRequest();return a.byteLength}};var Ut=16,ze=class{constructor(e){this.reader=e;this.pos=0}readBytes(e){let{view:t,offset:r}=this.reader.getViewAndOffset(this.pos,this.pos+e);return this.pos+=e,new Uint8Array(t.buffer,r,e)}readU8(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+1);return this.pos++,e.getUint8(t)}readU16(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+2);return this.pos+=2,e.getUint16(t,!1)}readI16(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+2);return this.pos+=2,e.getInt16(t,!1)}readU24(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+3);this.pos+=3;let r=e.getUint16(t,!1),i=e.getUint8(t+2);return r*256+i}readU32(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+4);return this.pos+=4,e.getUint32(t,!1)}readI32(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+4);return this.pos+=4,e.getInt32(t,!1)}readU64(){let e=this.readU32(),t=this.readU32();return e*4294967296+t}readI64(){let e=this.readI32(),t=this.readU32();return e*4294967296+t}readF64(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+8);return this.pos+=8,e.getFloat64(t,!1)}readFixed_16_16(){return this.readI32()/65536}readFixed_2_30(){return this.readI32()/1073741824}readAscii(e){let{view:t,offset:r}=this.reader.getViewAndOffset(this.pos,this.pos+e);this.pos+=e;let i="";for(let a=0;a<e;a++)i+=String.fromCharCode(t.getUint8(r+a));return i}readIsomVariableInteger(){let e=0;for(let t=0;t<4;t++){e<<=7;let r=this.readU8();if(e|=r&127,(r&128)===0)break}return e}readBoxHeader(){let e=this.readU32(),t=this.readAscii(4),r=8;return e===1&&(e=this.readU64(),r=16),{name:t,totalSize:e,headerSize:r,contentSize:e-r}}};var Mr=class extends ie{constructor(t){super(t);this.currentTrack=null;this.tracks=[];this.metadataPromise=null;this.movieTimescale=-1;this.movieDurationInTimescale=-1;this.isQuickTime=!1;this.isFragmented=!1;this.fragmentTrackDefaults=[];this.fragments=[];this.currentFragment=null;this.fragmentLookupMutex=new de;this.metadataReader=new ze(t._mainReader),this.chunkReader=new ze(new ne(t._source,64*2**20))}async computeDuration(){let t=await this.getTracks(),r=await Promise.all(t.map(i=>i.computeDuration()));return Math.max(0,...r)}async getTracks(){return await this.readMetadata(),this.tracks.map(t=>t.inputTrack)}async getMimeType(){await this.readMetadata();let r=(this.tracks.some(i=>i.info?.type==="video")?"video/":this.tracks.some(i=>i.info?.type==="audio")?"audio/":"application/")+(this.isQuickTime?"quicktime":"mp4");if(this.tracks.length>0){let i=await Promise.all(this.tracks.map(s=>s.inputTrack.getCodecParameterString())),a=[...new Set(i.filter(Boolean))];r+=`; codecs="${a.join(", ")}"`}return r}readMetadata(){return this.metadataPromise??=(async()=>{let t=await this.metadataReader.reader.source._getSize();for(;this.metadataReader.pos<t;){await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+Ut);let r=this.metadataReader.pos,i=this.metadataReader.readBoxHeader();if(i.name==="ftyp"){let a=this.metadataReader.readAscii(4);this.isQuickTime=a==="qt  "}else if(i.name==="moov"){await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+i.contentSize),this.readContiguousBoxes(i.contentSize);for(let a of this.tracks){let s=a.editListPreviousSegmentDurations/this.movieTimescale;a.editListOffset-=Math.round(s*a.timescale)}break}this.metadataReader.pos=r+i.totalSize}if(this.isFragmented){await this.metadataReader.reader.loadRange(t-4,t),this.metadataReader.pos=t-4;let r=this.metadataReader.readU32(),i=t-r;if(i>=0&&i<t){await this.metadataReader.reader.loadRange(i,t),this.metadataReader.pos=i;let a=this.metadataReader.readBoxHeader();a.name==="mfra"&&this.readContiguousBoxes(a.contentSize)}}})()}getSampleTableForTrack(t){if(t.sampleTable)return t.sampleTable;let r={sampleTimingEntries:[],sampleCompositionTimeOffsets:[],sampleSizes:[],keySampleIndices:null,chunkOffsets:[],sampleToChunk:[],presentationTimestamps:null,presentationTimestampIndexMap:null};if(t.sampleTable=r,this.metadataReader.pos=t.sampleTableByteOffset,this.currentTrack=t,this.traverseBox(),this.currentTrack=null,t.info?.type==="audio"&&t.info.codec&&D.includes(t.info.codec)&&r.sampleCompositionTimeOffsets.length===0){let a=[],s=[];for(let o=0;o<r.sampleToChunk.length;o++){let d=r.sampleToChunk[o],c=r.sampleToChunk[o+1],u=(c?c.startChunkIndex:r.chunkOffsets.length)-d.startChunkIndex;for(let l=0;l<u;l++){let m=d.startSampleIndex+l*d.samplesPerChunk,p=m+d.samplesPerChunk,h=R(r.sampleTimingEntries,m,P=>P.startIndex),b=r.sampleTimingEntries[h],g=R(r.sampleTimingEntries,p,P=>P.startIndex),k=r.sampleTimingEntries[g],x=b.startDecodeTimestamp+(m-b.startIndex)*b.delta,T=k.startDecodeTimestamp+(p-k.startIndex)*k.delta-x,S=M(a);S&&S.delta===T?S.count++:a.push({startIndex:d.startChunkIndex+l,startDecodeTimestamp:x,count:1,delta:T});let y=0;if(r.sampleSizes.length===1)y=r.sampleSizes[0]*d.samplesPerChunk;else for(let P=m;P<p;P++)y+=r.sampleSizes[P];s.push(y)}d.startSampleIndex=d.startChunkIndex,d.samplesPerChunk=1}r.sampleTimingEntries=a,r.sampleSizes=s}if(r.sampleCompositionTimeOffsets.length>0){r.presentationTimestamps=[];for(let a of r.sampleTimingEntries)for(let s=0;s<a.count;s++)r.presentationTimestamps.push({presentationTimestamp:a.startDecodeTimestamp+s*a.delta,sampleIndex:a.startIndex+s});for(let a of r.sampleCompositionTimeOffsets)for(let s=0;s<a.count;s++){let o=a.startIndex+s,d=r.presentationTimestamps[o];d&&(d.presentationTimestamp+=a.offset)}r.presentationTimestamps.sort((a,s)=>a.presentationTimestamp-s.presentationTimestamp),r.presentationTimestampIndexMap=Array(r.presentationTimestamps.length).fill(-1);for(let a=0;a<r.presentationTimestamps.length;a++)r.presentationTimestampIndexMap[r.presentationTimestamps[a].sampleIndex]=a}return r}async readFragment(){let t=this.metadataReader.pos;await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+Ut);let r=this.metadataReader.readBoxHeader();f(r.name==="moof"),await this.metadataReader.reader.loadRange(t,t+r.totalSize),this.metadataReader.pos=t,this.traverseBox();let i=U(this.fragments,t,s=>s.moofOffset);f(i!==-1);let a=this.fragments[i];f(a.moofOffset===t),this.metadataReader.reader.forgetRange(t,t+r.totalSize);for(let[s,o]of a.trackData){if(o.startTimestampIsFinal)continue;let d=this.tracks.find(p=>p.id===s);this.metadataReader.pos=0;let c=null,u=null,l=R(d.fragments,t-1,p=>p.moofOffset);l!==-1&&(c=d.fragments[l],u=c,this.metadataReader.pos=c.moofOffset+c.moofSize);let m=this.metadataReader.pos===0;for(;this.metadataReader.pos<t;){if(c?.nextFragment)c=c.nextFragment,this.metadataReader.pos=c.moofOffset+c.moofSize;else{await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+Ut);let p=this.metadataReader.pos,h=this.metadataReader.readBoxHeader();if(h.name==="moof"){let b=U(this.fragments,p,k=>k.moofOffset),g;b===-1?(this.metadataReader.pos=p,g=await this.readFragment()):g=this.fragments[b],c&&(c.nextFragment=g),c=g,m&&(g.isKnownToBeFirstFragment=!0,m=!1)}this.metadataReader.pos=p+h.totalSize}c&&c.trackData.has(s)&&(u=c)}if(u){let p=u.trackData.get(s);f(p.startTimestampIsFinal),Di(o,p.endTimestamp)}o.startTimestampIsFinal=!0}return a}readContiguousBoxes(t){let r=this.metadataReader.pos;for(;this.metadataReader.pos-r<t;)this.traverseBox()}traverseBox(){let t=this.metadataReader.pos,r=this.metadataReader.readBoxHeader(),i=t+r.totalSize;switch(r.name){case"mdia":case"minf":case"dinf":case"mfra":case"edts":this.readContiguousBoxes(r.contentSize);break;case"mvhd":{let a=this.metadataReader.readU8();this.metadataReader.pos+=3,a===1?(this.metadataReader.pos+=16,this.movieTimescale=this.metadataReader.readU32(),this.movieDurationInTimescale=this.metadataReader.readU64()):(this.metadataReader.pos+=8,this.movieTimescale=this.metadataReader.readU32(),this.movieDurationInTimescale=this.metadataReader.readU32())}break;case"trak":{let a={id:-1,demuxer:this,inputTrack:null,info:null,timescale:-1,durationInMovieTimescale:-1,durationInMediaTimescale:-1,rotation:0,languageCode:j,sampleTableByteOffset:-1,sampleTable:null,fragmentLookupTable:null,currentFragmentState:null,fragments:[],editListPreviousSegmentDurations:0,editListOffset:0};if(this.currentTrack=a,this.readContiguousBoxes(r.contentSize),a.id!==-1&&a.timescale!==-1&&a.info!==null){if(a.info.type==="video"&&a.info.width!==-1){let s=a;a.inputTrack=new ce(new Fa(s)),this.tracks.push(a)}else if(a.info.type==="audio"&&a.info.numberOfChannels!==-1){let s=a;a.inputTrack=new G(new Ma(s)),this.tracks.push(a)}}this.currentTrack=null}break;case"tkhd":{let a=this.currentTrack;f(a);let s=this.metadataReader.readU8();if(!((this.metadataReader.readU24()&1)!==0))break;if(s===0)this.metadataReader.pos+=8,a.id=this.metadataReader.readU32(),this.metadataReader.pos+=4,a.durationInMovieTimescale=this.metadataReader.readU32();else if(s===1)this.metadataReader.pos+=16,a.id=this.metadataReader.readU32(),this.metadataReader.pos+=4,a.durationInMovieTimescale=this.metadataReader.readU64();else throw new Error(`Incorrect track header version ${s}.`);this.metadataReader.pos+=2*4+2+2+2+2;let c=[this.metadataReader.readFixed_16_16(),this.metadataReader.readFixed_16_16(),this.metadataReader.readFixed_2_30(),this.metadataReader.readFixed_16_16(),this.metadataReader.readFixed_16_16(),this.metadataReader.readFixed_2_30(),this.metadataReader.readFixed_16_16(),this.metadataReader.readFixed_16_16(),this.metadataReader.readFixed_2_30()],u=Ie(Za(xs(c),90));f(u===0||u===90||u===180||u===270),a.rotation=u}break;case"elst":{let a=this.currentTrack;f(a);let s=this.metadataReader.readU8();this.metadataReader.pos+=3;let o=!1,d=0,c=this.metadataReader.readU32();for(let u=0;u<c;u++){let l=s===1?this.metadataReader.readU64():this.metadataReader.readU32(),m=s===1?this.metadataReader.readI64():this.metadataReader.readI32(),p=this.metadataReader.readFixed_16_16();if(l!==0){if(o)throw new Error("Unsupported edit list: multiple edits are not supported.");if(m===-1){d+=l;continue}if(p!==1)throw new Error("Unsupported edit list: media rate must be 1.");a.editListPreviousSegmentDurations=d,a.editListOffset=m,o=!0}}}break;case"mdhd":{let a=this.currentTrack;f(a);let s=this.metadataReader.readU8();this.metadataReader.pos+=3,s===0?(this.metadataReader.pos+=8,a.timescale=this.metadataReader.readU32(),a.durationInMediaTimescale=this.metadataReader.readU32()):s===1&&(this.metadataReader.pos+=16,a.timescale=this.metadataReader.readU32(),a.durationInMediaTimescale=this.metadataReader.readU64());let o=this.metadataReader.readU16();if(o>0){a.languageCode="";for(let d=0;d<3;d++)a.languageCode=String.fromCharCode(96+(o&31))+a.languageCode,o>>=5;Ne(a.languageCode)||(a.languageCode=j)}}break;case"hdlr":{let a=this.currentTrack;f(a),this.metadataReader.pos+=8;let s=this.metadataReader.readAscii(4);s==="vide"?a.info={type:"video",width:-1,height:-1,codec:null,codecDescription:null,colorSpace:null,vp9CodecInfo:null,av1CodecInfo:null}:s==="soun"&&(a.info={type:"audio",numberOfChannels:-1,sampleRate:-1,codec:null,codecDescription:null,aacCodecInfo:null})}break;case"stbl":{let a=this.currentTrack;f(a),a.sampleTableByteOffset=t,this.readContiguousBoxes(r.contentSize)}break;case"stsd":{let a=this.currentTrack;if(f(a),a.info===null||a.sampleTable)break;let s=this.metadataReader.readU8();this.metadataReader.pos+=3;let o=this.metadataReader.readU32();for(let d=0;d<o;d++){let c=this.metadataReader.readBoxHeader(),u=c.name.toLowerCase();if(a.info.type==="video")u==="avc1"?a.info.codec="avc":u==="hvc1"||u==="hev1"?a.info.codec="hevc":u==="vp08"?a.info.codec="vp8":u==="vp09"?a.info.codec="vp9":u==="av01"?a.info.codec="av1":console.warn(`Unsupported video codec (sample entry type '${c.name}').`),this.metadataReader.pos+=6*1+2+2+2+3*4,a.info.width=this.metadataReader.readU16(),a.info.height=this.metadataReader.readU16(),this.metadataReader.pos+=50,this.readContiguousBoxes(t+c.totalSize-this.metadataReader.pos);else{u==="mp4a"||(u==="opus"?a.info.codec="opus":u==="flac"?a.info.codec="flac":u==="twos"||u==="sowt"||u==="raw "||u==="in24"||u==="in32"||u==="fl32"||u==="lpcm"||(u==="ulaw"?a.info.codec="ulaw":u==="alaw"?a.info.codec="alaw":console.warn(`Unsupported audio codec (sample entry type '${c.name}').`))),this.metadataReader.pos+=6*1+2;let l=this.metadataReader.readU16();this.metadataReader.pos+=3*2;let m=this.metadataReader.readU16(),p=this.metadataReader.readU16();this.metadataReader.pos+=2*2;let h=this.metadataReader.readU32()/65536;if(s===0&&l>0){if(l===1)this.metadataReader.pos+=4,p=8*this.metadataReader.readU32(),this.metadataReader.pos+=2*4;else if(l===2){this.metadataReader.pos+=4,h=this.metadataReader.readF64(),m=this.metadataReader.readU32(),this.metadataReader.pos+=4,p=this.metadataReader.readU32();let b=this.metadataReader.readU32();if(this.metadataReader.pos+=2*4,u==="lpcm"){let g=p+7>>3,k=!!(b&1),x=!!(b&2),w=b&4?-1:0;p>0&&p<=64&&(k?p===32&&(a.info.codec=x?"pcm-f32be":"pcm-f32"):w&1<<g-1?g===1?a.info.codec="pcm-s8":g===2?a.info.codec=x?"pcm-s16be":"pcm-s16":g===3?a.info.codec=x?"pcm-s24be":"pcm-s24":g===4&&(a.info.codec=x?"pcm-s32be":"pcm-s32"):g===1&&(a.info.codec="pcm-u8")),a.info.codec===null&&console.warn("Unsupported PCM format.")}}}if(a.info.numberOfChannels=m,a.info.sampleRate=h,u==="twos")if(p===8)a.info.codec="pcm-s8";else if(p===16)a.info.codec="pcm-s16be";else throw new Error(`Unsupported sample size ${p} for codec 'twos'.`);else if(u==="sowt")if(p===8)a.info.codec="pcm-s8";else if(p===16)a.info.codec="pcm-s16";else throw new Error(`Unsupported sample size ${p} for codec 'sowt'.`);else u==="raw "?a.info.codec="pcm-u8":u==="in24"?a.info.codec="pcm-s24be":u==="in32"?a.info.codec="pcm-s32be":u==="fl32"&&(a.info.codec="pcm-f32be");this.readContiguousBoxes(t+c.totalSize-this.metadataReader.pos)}}}break;case"avcC":{let a=this.currentTrack;f(a&&a.info),a.info.codecDescription=this.metadataReader.readBytes(r.contentSize)}break;case"hvcC":{let a=this.currentTrack;f(a&&a.info),a.info.codecDescription=this.metadataReader.readBytes(r.contentSize)}break;case"vpcC":{let a=this.currentTrack;f(a&&a.info?.type==="video"),this.metadataReader.pos+=4;let s=this.metadataReader.readU8(),o=this.metadataReader.readU8(),d=this.metadataReader.readU8(),c=d>>4,u=d>>1&7,l=d&1,m=this.metadataReader.readU8(),p=this.metadataReader.readU8(),h=this.metadataReader.readU8();a.info.vp9CodecInfo={profile:s,level:o,bitDepth:c,chromaSubsampling:u,videoFullRangeFlag:l,colourPrimaries:m,transferCharacteristics:p,matrixCoefficients:h}}break;case"av1C":{let a=this.currentTrack;f(a&&a.info?.type==="video"),this.metadataReader.pos+=1;let s=this.metadataReader.readU8(),o=s>>5,d=s&31,c=this.metadataReader.readU8(),u=c>>7,l=c>>6&1,m=c>>5&1,p=c>>4&1,h=c>>3&1,b=c>>2&1,g=c&3,k=o==2&&l?m?12:10:l?10:8;a.info.av1CodecInfo={profile:o,level:d,tier:u,bitDepth:k,monochrome:p,chromaSubsamplingX:h,chromaSubsamplingY:b,chromaSamplePosition:g}}break;case"colr":{let a=this.currentTrack;if(f(a&&a.info?.type==="video"),this.metadataReader.readAscii(4)!=="nclx")break;let o=this.metadataReader.readU16(),d=this.metadataReader.readU16(),c=this.metadataReader.readU16(),u=!!(this.metadataReader.readU8()&128);a.info.colorSpace={primaries:Lt[o],transfer:Ht[d],matrix:$t[c],fullRange:u}}break;case"wave":r.totalSize>8&&this.readContiguousBoxes(r.contentSize);break;case"esds":{let a=this.currentTrack;f(a&&a.info?.type==="audio"),this.metadataReader.pos+=4;let s=this.metadataReader.readU8();f(s===3),this.metadataReader.readIsomVariableInteger(),this.metadataReader.pos+=2;let o=this.metadataReader.readU8(),d=(o&128)!==0,c=(o&64)!==0,u=(o&32)!==0;if(d&&(this.metadataReader.pos+=2),c){let b=this.metadataReader.readU8();this.metadataReader.pos+=b}u&&(this.metadataReader.pos+=2);let l=this.metadataReader.readU8();f(l===4);let m=this.metadataReader.readIsomVariableInteger(),p=this.metadataReader.pos,h=this.metadataReader.readU8();if(h===64||h===103?(a.info.codec="aac",a.info.aacCodecInfo={isMpeg2:h===103}):h===105||h===107?a.info.codec="mp3":h===221?a.info.codec="vorbis":console.warn(`Unsupported audio codec (objectTypeIndication ${h}) - discarding track.`),this.metadataReader.pos+=12,m>this.metadataReader.pos-p){let b=this.metadataReader.readU8();f(b===5);let g=this.metadataReader.readIsomVariableInteger();if(a.info.codecDescription=this.metadataReader.readBytes(g),a.info.codec==="aac"){let k=Yr(a.info.codecDescription);k.numberOfChannels!==null&&(a.info.numberOfChannels=k.numberOfChannels),k.sampleRate!==null&&(a.info.sampleRate=k.sampleRate)}}}break;case"enda":{let a=this.currentTrack;f(a&&a.info?.type==="audio"),this.metadataReader.readU16()&255&&(a.info.codec==="pcm-s16be"?a.info.codec="pcm-s16":a.info.codec==="pcm-s24be"?a.info.codec="pcm-s24":a.info.codec==="pcm-s32be"?a.info.codec="pcm-s32":a.info.codec==="pcm-f32be"&&(a.info.codec="pcm-f32"))}break;case"dOps":{let a=this.currentTrack;f(a&&a.info?.type==="audio"),this.metadataReader.pos+=1;let s=this.metadataReader.readU8(),o=this.metadataReader.readU16(),d=this.metadataReader.readU32(),c=this.metadataReader.readI16(),u=this.metadataReader.readU8(),l;u!==0?l=this.metadataReader.readBytes(2+s):l=new Uint8Array(0);let m=new Uint8Array(19+l.byteLength),p=new DataView(m.buffer);p.setUint32(0,1332770163,!1),p.setUint32(4,1214603620,!1),p.setUint8(8,1),p.setUint8(9,s),p.setUint16(10,o,!0),p.setUint32(12,d,!0),p.setInt16(16,c,!0),p.setUint8(18,u),m.set(l,19),a.info.codecDescription=m,a.info.numberOfChannels=s,a.info.sampleRate=d}break;case"dfLa":{let a=this.currentTrack;f(a&&a.info?.type==="audio"),this.metadataReader.pos+=4;let s=127,o=128,d=this.metadataReader.pos;for(;this.metadataReader.pos<i;){let p=this.metadataReader.readU8(),h=this.metadataReader.readU24();if((p&s)===0){this.metadataReader.pos+=10;let g=this.metadataReader.readU32(),k=g>>>12,x=(g>>9&7)+1;a.info.sampleRate=k,a.info.numberOfChannels=x,this.metadataReader.pos+=20}else this.metadataReader.pos+=h;if(p&o)break}let c=this.metadataReader.pos;this.metadataReader.pos=d;let u=this.metadataReader.readBytes(c-d),l=new Uint8Array(4+u.byteLength);new DataView(l.buffer).setUint32(0,1716281667,!1),l.set(u,4),a.info.codecDescription=l}break;case"stts":{let a=this.currentTrack;if(f(a),!a.sampleTable)break;this.metadataReader.pos+=4;let s=this.metadataReader.readU32(),o=0,d=0;for(let c=0;c<s;c++){let u=this.metadataReader.readU32(),l=this.metadataReader.readU32();a.sampleTable.sampleTimingEntries.push({startIndex:o,startDecodeTimestamp:d,count:u,delta:l}),o+=u,d+=u*l}}break;case"ctts":{let a=this.currentTrack;if(f(a),!a.sampleTable)break;this.metadataReader.pos+=4;let s=this.metadataReader.readU32(),o=0;for(let d=0;d<s;d++){let c=this.metadataReader.readU32(),u=this.metadataReader.readI32();a.sampleTable.sampleCompositionTimeOffsets.push({startIndex:o,count:c,offset:u}),o+=c}}break;case"stsz":{let a=this.currentTrack;if(f(a),!a.sampleTable)break;this.metadataReader.pos+=4;let s=this.metadataReader.readU32(),o=this.metadataReader.readU32();if(s===0)for(let d=0;d<o;d++){let c=this.metadataReader.readU32();a.sampleTable.sampleSizes.push(c)}else a.sampleTable.sampleSizes.push(s)}break;case"stz2":throw new Error("Unsupported.");case"stss":{let a=this.currentTrack;if(f(a),!a.sampleTable)break;this.metadataReader.pos+=4,a.sampleTable.keySampleIndices=[];let s=this.metadataReader.readU32();for(let o=0;o<s;o++){let d=this.metadataReader.readU32()-1;a.sampleTable.keySampleIndices.push(d)}}break;case"stsc":{let a=this.currentTrack;if(f(a),!a.sampleTable)break;this.metadataReader.pos+=4;let s=this.metadataReader.readU32();for(let d=0;d<s;d++){let c=this.metadataReader.readU32()-1,u=this.metadataReader.readU32(),l=this.metadataReader.readU32();a.sampleTable.sampleToChunk.push({startSampleIndex:-1,startChunkIndex:c,samplesPerChunk:u,sampleDescriptionIndex:l})}let o=0;for(let d=0;d<a.sampleTable.sampleToChunk.length;d++)if(a.sampleTable.sampleToChunk[d].startSampleIndex=o,d<a.sampleTable.sampleToChunk.length-1){let u=a.sampleTable.sampleToChunk[d+1].startChunkIndex-a.sampleTable.sampleToChunk[d].startChunkIndex;o+=u*a.sampleTable.sampleToChunk[d].samplesPerChunk}}break;case"stco":{let a=this.currentTrack;if(f(a),!a.sampleTable)break;this.metadataReader.pos+=4;let s=this.metadataReader.readU32();for(let o=0;o<s;o++){let d=this.metadataReader.readU32();a.sampleTable.chunkOffsets.push(d)}}break;case"co64":{let a=this.currentTrack;if(f(a),!a.sampleTable)break;this.metadataReader.pos+=4;let s=this.metadataReader.readU32();for(let o=0;o<s;o++){let d=this.metadataReader.readU64();a.sampleTable.chunkOffsets.push(d)}}break;case"mvex":this.isFragmented=!0,this.readContiguousBoxes(r.contentSize);break;case"mehd":{let a=this.metadataReader.readU8();this.metadataReader.pos+=3;let s=a===1?this.metadataReader.readU64():this.metadataReader.readU32();this.movieDurationInTimescale=s}break;case"trex":{this.metadataReader.pos+=4;let a=this.metadataReader.readU32(),s=this.metadataReader.readU32(),o=this.metadataReader.readU32(),d=this.metadataReader.readU32(),c=this.metadataReader.readU32();this.fragmentTrackDefaults.push({trackId:a,defaultSampleDescriptionIndex:s,defaultSampleDuration:o,defaultSampleSize:d,defaultSampleFlags:c})}break;case"tfra":{let a=this.metadataReader.readU8();this.metadataReader.pos+=3;let s=this.metadataReader.readU32(),o=this.tracks.find(x=>x.id===s);if(!o)break;o.fragmentLookupTable=[];let d=this.metadataReader.readU32(),c=(d&48)>>4,u=(d&12)>>2,l=d&3,m=this.metadataReader,p=[m.readU8.bind(m),m.readU16.bind(m),m.readU24.bind(m),m.readU32.bind(m)],h=p[c],b=p[u],g=p[l],k=this.metadataReader.readU32();for(let x=0;x<k;x++){let w=a===1?this.metadataReader.readU64():this.metadataReader.readU32(),T=a===1?this.metadataReader.readU64():this.metadataReader.readU32(),S=h(),y=b(),P=g();o.fragmentLookupTable.push({timestamp:w,moofOffset:T})}}break;case"moof":{this.currentFragment={moofOffset:t,moofSize:r.totalSize,implicitBaseDataOffset:t,trackData:new Map,dataStart:1/0,dataEnd:0,nextFragment:null,isKnownToBeFirstFragment:!1},this.readContiguousBoxes(r.contentSize);let a=R(this.fragments,this.currentFragment.moofOffset,s=>s.moofOffset);this.fragments.splice(a+1,0,this.currentFragment);for(let[,s]of this.currentFragment.trackData){let o=s.samples[0],d=M(s.samples);this.currentFragment.dataStart=Math.min(this.currentFragment.dataStart,o.byteOffset),this.currentFragment.dataEnd=Math.max(this.currentFragment.dataEnd,d.byteOffset+d.byteSize)}this.currentFragment=null}break;case"traf":if(f(this.currentFragment),this.readContiguousBoxes(r.contentSize),this.currentTrack){let a=this.currentFragment.trackData.get(this.currentTrack.id);if(a){let s=R(this.currentTrack.fragments,this.currentFragment.moofOffset,d=>d.moofOffset);this.currentTrack.fragments.splice(s+1,0,this.currentFragment);let{currentFragmentState:o}=this.currentTrack;f(o),o.startTimestamp!==null&&(Di(a,o.startTimestamp),a.startTimestampIsFinal=!0)}this.currentTrack.currentFragmentState=null,this.currentTrack=null}break;case"tfhd":{f(this.currentFragment),this.metadataReader.pos+=1;let a=this.metadataReader.readU24(),s=!!(a&1),o=!!(a&2),d=!!(a&8),c=!!(a&16),u=!!(a&32),l=!!(a&65536),m=!!(a&131072),p=this.metadataReader.readU32(),h=this.tracks.find(g=>g.id===p);if(!h)break;let b=this.fragmentTrackDefaults.find(g=>g.trackId===p);this.currentTrack=h,h.currentFragmentState={baseDataOffset:this.currentFragment.implicitBaseDataOffset,sampleDescriptionIndex:b?.defaultSampleDescriptionIndex??null,defaultSampleDuration:b?.defaultSampleDuration??null,defaultSampleSize:b?.defaultSampleSize??null,defaultSampleFlags:b?.defaultSampleFlags??null,startTimestamp:null},s?h.currentFragmentState.baseDataOffset=this.metadataReader.readU64():m&&(h.currentFragmentState.baseDataOffset=this.currentFragment.moofOffset),o&&(h.currentFragmentState.sampleDescriptionIndex=this.metadataReader.readU32()),d&&(h.currentFragmentState.defaultSampleDuration=this.metadataReader.readU32()),c&&(h.currentFragmentState.defaultSampleSize=this.metadataReader.readU32()),u&&(h.currentFragmentState.defaultSampleFlags=this.metadataReader.readU32()),l&&(h.currentFragmentState.defaultSampleDuration=0)}break;case"tfdt":{let a=this.currentTrack;if(!a)break;f(a.currentFragmentState);let s=this.metadataReader.readU8();this.metadataReader.pos+=3;let o=s===0?this.metadataReader.readU32():this.metadataReader.readU64();a.currentFragmentState.startTimestamp=o}break;case"trun":{let a=this.currentTrack;if(!a)break;if(f(this.currentFragment),f(a.currentFragmentState),this.currentFragment.trackData.has(a.id))throw new Error("Can't have two trun boxes for the same track in one fragment.");let s=this.metadataReader.readU8(),o=this.metadataReader.readU24(),d=!!(o&1),c=!!(o&4),u=!!(o&256),l=!!(o&512),m=!!(o&1024),p=!!(o&2048),h=this.metadataReader.readU32(),b=a.currentFragmentState.baseDataOffset;d&&(b+=this.metadataReader.readI32());let g=null;c&&(g=this.metadataReader.readU32());let k=b;if(h===0){this.currentFragment.implicitBaseDataOffset=k;break}let x=0,w={startTimestamp:0,endTimestamp:0,samples:[],presentationTimestamps:[],startTimestampIsFinal:!1};this.currentFragment.trackData.set(a.id,w);for(let y=0;y<h;y++){let P;u?P=this.metadataReader.readU32():(f(a.currentFragmentState.defaultSampleDuration!==null),P=a.currentFragmentState.defaultSampleDuration);let I;l?I=this.metadataReader.readU32():(f(a.currentFragmentState.defaultSampleSize!==null),I=a.currentFragmentState.defaultSampleSize);let E;m?E=this.metadataReader.readU32():(f(a.currentFragmentState.defaultSampleFlags!==null),E=a.currentFragmentState.defaultSampleFlags),y===0&&g!==null&&(E=g);let z=0;p&&(s===0?z=this.metadataReader.readU32():z=this.metadataReader.readI32());let N=!(E&65536);w.samples.push({presentationTimestamp:x+z,duration:P,byteOffset:k,byteSize:I,isKeyFrame:N}),k+=I,x+=P}w.presentationTimestamps=w.samples.map((y,P)=>({presentationTimestamp:y.presentationTimestamp,sampleIndex:P})).sort((y,P)=>y.presentationTimestamp-P.presentationTimestamp);for(let y=0;y<w.presentationTimestamps.length-1;y++){let P=w.presentationTimestamps[y],E=w.presentationTimestamps[y+1].presentationTimestamp-P.presentationTimestamp;w.samples[P.sampleIndex].duration=E}let T=w.samples[w.presentationTimestamps[0].sampleIndex],S=w.samples[M(w.presentationTimestamps).sampleIndex];w.startTimestamp=T.presentationTimestamp,w.endTimestamp=S.presentationTimestamp+S.duration,this.currentFragment.implicitBaseDataOffset=k}break}this.metadataReader.pos=i}},Dr=class{constructor(e){this.internalTrack=e;this.packetToSampleIndex=new WeakMap;this.packetToFragmentLocation=new WeakMap}getId(){return this.internalTrack.id}getCodec(){throw new Error("Not implemented on base class.")}getLanguageCode(){return this.internalTrack.languageCode}getTimeResolution(){return this.internalTrack.timescale}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}async getFirstTimestamp(){return(await this.getFirstPacket({metadataOnly:!0}))?.timestamp??0}async getFirstPacket(e){return this.internalTrack.demuxer.isFragmented?this.performFragmentedLookup(()=>{let t=this.internalTrack.demuxer.fragments[0]??null;if(t?.isKnownToBeFirstFragment){let r=t;for(;r;){if(r.trackData.get(this.internalTrack.id))return{fragmentIndex:U(this.internalTrack.fragments,r.moofOffset,a=>a.moofOffset),sampleIndex:0,correctSampleFound:!0};r=r.nextFragment}}return{fragmentIndex:-1,sampleIndex:-1,correctSampleFound:!1}},-1/0,1/0,e):this.fetchPacketForSampleIndex(0,e)}mapTimestampIntoTimescale(e){return Be(e*this.internalTrack.timescale,14)+this.internalTrack.editListOffset}async getPacket(e,t){let r=this.mapTimestampIntoTimescale(e);if(this.internalTrack.demuxer.isFragmented)return this.performFragmentedLookup(()=>this.findSampleInFragmentsForTimestamp(r),r,r,t);{let i=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),a=Mi(i,r);return this.fetchPacketForSampleIndex(a,t)}}async getNextPacket(e,t){if(this.internalTrack.demuxer.isFragmented){let i=this.packetToFragmentLocation.get(e);if(i===void 0)throw new Error("Packet was not created from this track.");let a=i.fragment.trackData.get(this.internalTrack.id),s=a.samples[i.sampleIndex],o=U(this.internalTrack.fragments,i.fragment.moofOffset,d=>d.moofOffset);return f(o!==-1),this.performFragmentedLookup(()=>{if(i.sampleIndex+1<a.samples.length)return{fragmentIndex:o,sampleIndex:i.sampleIndex+1,correctSampleFound:!0};{let d=i.fragment;for(;d.nextFragment;)if(d=d.nextFragment,d.trackData.get(this.internalTrack.id)){let u=U(this.internalTrack.fragments,d.moofOffset,l=>l.moofOffset);return f(u!==-1),{fragmentIndex:u,sampleIndex:0,correctSampleFound:!0}}return{fragmentIndex:o,sampleIndex:-1,correctSampleFound:!1}}},s.presentationTimestamp,1/0,t)}let r=this.packetToSampleIndex.get(e);if(r===void 0)throw new Error("Packet was not created from this track.");return this.fetchPacketForSampleIndex(r+1,t)}async getKeyPacket(e,t){let r=this.mapTimestampIntoTimescale(e);if(this.internalTrack.demuxer.isFragmented)return this.performFragmentedLookup(()=>this.findKeySampleInFragmentsForTimestamp(r),r,r,t);let i=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),a=Mi(i,r),s=a===-1?-1:Ss(i,a);return this.fetchPacketForSampleIndex(s,t)}async getNextKeyPacket(e,t){if(this.internalTrack.demuxer.isFragmented){let s=this.packetToFragmentLocation.get(e);if(s===void 0)throw new Error("Packet was not created from this track.");let o=s.fragment.trackData.get(this.internalTrack.id),d=o.samples[s.sampleIndex],c=U(this.internalTrack.fragments,s.fragment.moofOffset,u=>u.moofOffset);return f(c!==-1),this.performFragmentedLookup(()=>{let u=o.samples.findIndex((l,m)=>l.isKeyFrame&&m>s.sampleIndex);if(u!==-1)return{fragmentIndex:c,sampleIndex:u,correctSampleFound:!0};{let l=s.fragment;for(;l.nextFragment;){l=l.nextFragment;let m=l.trackData.get(this.internalTrack.id);if(m){let p=U(this.internalTrack.fragments,l.moofOffset,b=>b.moofOffset);f(p!==-1);let h=m.samples.findIndex(b=>b.isKeyFrame);if(h===-1)throw new Error("Not supported: Fragment does not contain key sample.");return{fragmentIndex:p,sampleIndex:h,correctSampleFound:!0}}}return{fragmentIndex:c,sampleIndex:-1,correctSampleFound:!1}}},d.presentationTimestamp,1/0,t)}let r=this.packetToSampleIndex.get(e);if(r===void 0)throw new Error("Packet was not created from this track.");let i=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),a=ys(i,r);return this.fetchPacketForSampleIndex(a,t)}async fetchPacketForSampleIndex(e,t){if(e===-1)return null;let r=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),i=Ts(r,e);if(!i)return null;let a;t.metadataOnly?a=te:(await this.internalTrack.demuxer.chunkReader.reader.loadRange(i.chunkOffset,i.chunkOffset+i.chunkSize),this.internalTrack.demuxer.chunkReader.pos=i.sampleOffset,a=this.internalTrack.demuxer.chunkReader.readBytes(i.sampleSize));let s=(i.presentationTimestamp-this.internalTrack.editListOffset)/this.internalTrack.timescale,o=i.duration/this.internalTrack.timescale,d=new V(a,i.isKeyFrame?"key":"delta",s,o,e,i.sampleSize);return this.packetToSampleIndex.set(d,e),d}async fetchPacketInFragment(e,t,r){if(t===-1)return null;let a=e.trackData.get(this.internalTrack.id).samples[t];f(a);let s;r.metadataOnly?s=te:(await this.internalTrack.demuxer.chunkReader.reader.loadRange(e.dataStart,e.dataEnd),this.internalTrack.demuxer.chunkReader.pos=a.byteOffset,s=this.internalTrack.demuxer.chunkReader.readBytes(a.byteSize));let o=(a.presentationTimestamp-this.internalTrack.editListOffset)/this.internalTrack.timescale,d=a.duration/this.internalTrack.timescale,c=new V(s,a.isKeyFrame?"key":"delta",o,d,e.moofOffset+t,a.byteSize);return this.packetToFragmentLocation.set(c,{fragment:e,sampleIndex:t}),c}findSampleInFragmentsForTimestamp(e){let t=R(this.internalTrack.fragments,e,a=>a.trackData.get(this.internalTrack.id).startTimestamp),r=-1,i=!1;if(t!==-1){let s=this.internalTrack.fragments[t].trackData.get(this.internalTrack.id),o=R(s.presentationTimestamps,e,d=>d.presentationTimestamp);f(o!==-1),r=s.presentationTimestamps[o].sampleIndex,i=e<s.endTimestamp}return{fragmentIndex:t,sampleIndex:r,correctSampleFound:i}}findKeySampleInFragmentsForTimestamp(e){let t=R(this.internalTrack.fragments,e,a=>a.trackData.get(this.internalTrack.id).startTimestamp),r=-1,i=!1;if(t!==-1){let s=this.internalTrack.fragments[t].trackData.get(this.internalTrack.id),o=qt(s.presentationTimestamps,c=>s.samples[c.sampleIndex].isKeyFrame&&c.presentationTimestamp<=e);if(o===-1)throw new Error("Not supported: Fragment does not begin with a key sample.");r=s.presentationTimestamps[o].sampleIndex,i=e<s.endTimestamp}return{fragmentIndex:t,sampleIndex:r,correctSampleFound:i}}async performFragmentedLookup(e,t,r,i){let a=this.internalTrack.demuxer,s=await a.fragmentLookupMutex.acquire();try{let{fragmentIndex:o,sampleIndex:d,correctSampleFound:c}=e();if(c){let T=this.internalTrack.fragments[o];return this.fetchPacketInFragment(T,d,i)}let u=a.metadataReader,l=await u.reader.source._getSize(),m=null,p=o,h=d,b=this.internalTrack.fragmentLookupTable?R(this.internalTrack.fragmentLookupTable,t,T=>T.timestamp):-1,g=b!==-1?this.internalTrack.fragmentLookupTable[b]:null,k=!1;if(o===-1)u.pos=g?.moofOffset??0,k=u.pos===0;else{let T=this.internalTrack.fragments[o];!g||T.moofOffset>=g.moofOffset?(u.pos=T.moofOffset+T.moofSize,m=T):u.pos=g.moofOffset}for(;u.pos<l;){if(m){let y=m.trackData.get(this.internalTrack.id);if(y&&y.startTimestamp>r)break;if(m.nextFragment){u.pos=m.nextFragment.moofOffset+m.nextFragment.moofSize,m=m.nextFragment;continue}}await u.reader.loadRange(u.pos,u.pos+Ut);let T=u.pos,S=u.readBoxHeader();if(S.name==="moof"){let y=U(a.fragments,T,N=>N.moofOffset),P;y===-1?(u.pos=T,P=await a.readFragment()):P=a.fragments[y],m&&(m.nextFragment=P),m=P,k&&(P.isKnownToBeFirstFragment=!0,k=!1);let{fragmentIndex:I,sampleIndex:E,correctSampleFound:z}=e();if(z){let N=this.internalTrack.fragments[I];return this.fetchPacketInFragment(N,E,i)}I!==-1&&(p=I,h=E)}u.pos=T+S.totalSize}let x=null,w=p!==-1?this.internalTrack.fragments[p]:null;if(w&&(x=await this.fetchPacketInFragment(w,h,i)),!x&&g&&(!w||w.moofOffset<g.moofOffset)){let S=this.internalTrack.fragmentLookupTable[b-1]?.timestamp??-1/0;return this.performFragmentedLookup(e,S,r,i)}return x}finally{s()}}},Fa=class extends Dr{constructor(t){super(t);this.decoderConfigPromise=null;this.internalTrack=t}getCodec(){return this.internalTrack.info.codec}getCodedWidth(){return this.internalTrack.info.width}getCodedHeight(){return this.internalTrack.info.height}getRotation(){return this.internalTrack.rotation}async getColorSpace(){return{primaries:this.internalTrack.info.colorSpace?.primaries,transfer:this.internalTrack.info.colorSpace?.transfer,matrix:this.internalTrack.info.colorSpace?.matrix,fullRange:this.internalTrack.info.colorSpace?.fullRange}}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfigPromise??=(async()=>{if(this.internalTrack.info.codec==="vp9"&&!this.internalTrack.info.vp9CodecInfo){let t=await this.getFirstPacket({});this.internalTrack.info.vp9CodecInfo=t&&ar(t.data)}return{codec:rr(this.internalTrack.info),codedWidth:this.internalTrack.info.width,codedHeight:this.internalTrack.info.height,description:this.internalTrack.info.codecDescription??void 0,colorSpace:this.internalTrack.info.colorSpace??void 0}})():null}},Ma=class extends Dr{constructor(t){super(t);this.decoderConfig=null;this.internalTrack=t}getCodec(){return this.internalTrack.info.codec}getNumberOfChannels(){return this.internalTrack.info.numberOfChannels}getSampleRate(){return this.internalTrack.info.sampleRate}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfig??={codec:ir(this.internalTrack.info),numberOfChannels:this.internalTrack.info.numberOfChannels,sampleRate:this.internalTrack.info.sampleRate,description:this.internalTrack.info.codecDescription??void 0}:null}},Mi=(n,e)=>{if(n.presentationTimestamps){let t=R(n.presentationTimestamps,e,r=>r.presentationTimestamp);return t===-1?-1:n.presentationTimestamps[t].sampleIndex}else{let t=R(n.sampleTimingEntries,e,i=>i.startDecodeTimestamp);if(t===-1)return-1;let r=n.sampleTimingEntries[t];return r.startIndex+Math.min(Math.floor((e-r.startDecodeTimestamp)/r.delta),r.count-1)}},Ts=(n,e)=>{let t=R(n.sampleTimingEntries,e,k=>k.startIndex),r=n.sampleTimingEntries[t];if(!r||r.startIndex+r.count<=e)return null;let a=r.startDecodeTimestamp+(e-r.startIndex)*r.delta,s=R(n.sampleCompositionTimeOffsets,e,k=>k.startIndex),o=n.sampleCompositionTimeOffsets[s];o&&e-o.startIndex<o.count&&(a+=o.offset);let d=n.sampleSizes[Math.min(e,n.sampleSizes.length-1)],c=R(n.sampleToChunk,e,k=>k.startSampleIndex),u=n.sampleToChunk[c];f(u);let l=u.startChunkIndex+Math.floor((e-u.startSampleIndex)/u.samplesPerChunk),m=n.chunkOffsets[l],p=u.startSampleIndex+(l-u.startChunkIndex)*u.samplesPerChunk,h=0,b=m;if(n.sampleSizes.length===1)b+=d*(e-p),h+=d*u.samplesPerChunk;else for(let k=p;k<p+u.samplesPerChunk;k++){let x=n.sampleSizes[k];k<e&&(b+=x),h+=x}let g=r.delta;if(n.presentationTimestamps){let k=n.presentationTimestampIndexMap[e];f(k!==void 0),k<n.presentationTimestamps.length-1&&(g=n.presentationTimestamps[k+1].presentationTimestamp-a)}return{presentationTimestamp:a,duration:g,sampleOffset:b,sampleSize:d,chunkOffset:m,chunkSize:h,isKeyFrame:n.keySampleIndices?U(n.keySampleIndices,e,k=>k)!==-1:!0}},Ss=(n,e)=>{if(!n.keySampleIndices)return e;let t=R(n.keySampleIndices,e,r=>r);return n.keySampleIndices[t]??-1},ys=(n,e)=>{if(!n.keySampleIndices)return e+1;let t=R(n.keySampleIndices,e,r=>r);return n.keySampleIndices[t+1]??-1},Di=(n,e)=>{n.startTimestamp+=e,n.endTimestamp+=e;for(let t of n.samples)t.presentationTimestamp+=e;for(let t of n.presentationTimestamps)t.presentationTimestamp+=e},xs=n=>{let[e,,,t]=n,r=Math.hypot(e,t),i=e/r,a=t/r;return-Math.atan2(a,i)*(180/Math.PI)};var Da=[{id:290298740,flag:"seekHeadSeen"},{id:357149030,flag:"infoSeen"},{id:374648427,flag:"tracksSeen"},{id:475249515,flag:"cuesSeen"}],Vr=class extends ie{constructor(t){super(t);this.readMetadataPromise=null;this.segments=[];this.currentSegment=null;this.currentTrack=null;this.currentCluster=null;this.currentBlock=null;this.currentCueTime=null;this.isWebM=!1;this.metadataReader=new Fe(t._mainReader),this.clusterReader=new Fe(new ne(t._source,64*2**20))}async computeDuration(){let t=await this.getTracks(),r=await Promise.all(t.map(i=>i.computeDuration()));return Math.max(0,...r)}async getTracks(){return await this.readMetadata(),this.segments.flatMap(t=>t.tracks.map(r=>r.inputTrack))}async getMimeType(){await this.readMetadata();let r=(this.segments.some(a=>a.tracks.some(s=>s.info?.type==="video"))?"video/":this.segments.some(a=>a.tracks.some(s=>s.info?.type==="audio"))?"audio/":"application/")+(this.isWebM?"webm":"x-matroska"),i=await this.getTracks();if(i.length>0){let a=await Promise.all(i.map(o=>o.getCodecParameterString())),s=[...new Set(a.filter(Boolean))];r+=`; codecs="${s.join(", ")}"`}return r}assertDefinedSize(t){if(t===-1)throw new Error("Undefined element size is used in a place where it is not supported.")}readMetadata(){return this.readMetadataPromise??=(async()=>{this.metadataReader.pos=0;let t=await this.input._source._getSize();for(;this.metadataReader.pos<t-da;){await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+kt);let{id:r,size:i}=this.metadataReader.readElementHeader(),a=this.metadataReader.pos;if(r===440786851)await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+i),this.readContiguousElements(this.metadataReader,i);else if(r===408125543&&(await this.readSegment(i),i===-1))break;this.assertDefinedSize(i),this.metadataReader.pos=a+i}})()}async readSegment(t){let r=this.metadataReader.pos;this.currentSegment={seekHeadSeen:!1,infoSeen:!1,tracksSeen:!1,cuesSeen:!1,timestampScale:-1,timestampFactor:-1,duration:-1,seekEntries:[],tracks:[],cuePoints:[],dataStartPos:r,elementEndPos:t===-1?await this.input._source._getSize()-da:r+t,clusterSeekStartPos:r,clusters:[],clusterLookupMutex:new de},this.segments.push(this.currentSegment),await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+2**14);let i=!1;for(;this.metadataReader.pos<this.currentSegment.elementEndPos;){await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+kt);let c=this.metadataReader.pos,{id:u,size:l}=this.metadataReader.readElementHeader(),m=this.metadataReader.pos,p=Da.findIndex(h=>h.id===u);if(p!==-1){let h=Da[p].flag;this.currentSegment[h]=!0,await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+l),this.readContiguousElements(this.metadataReader,l)}else u===524531317&&(i||(i=!0,this.currentSegment.clusterSeekStartPos=c));if(this.currentSegment.infoSeen&&this.currentSegment.tracksSeen&&this.currentSegment.cuesSeen)break;if(this.currentSegment.seekHeadSeen){let h=this.currentSegment.infoSeen,b=this.currentSegment.tracksSeen,g=this.currentSegment.cuesSeen;for(let k of this.currentSegment.seekEntries)k.id===357149030?h=!0:k.id===374648427?b=!0:k.id===475249515&&(g=!0);if(h&&b&&g)break}this.assertDefinedSize(l),this.metadataReader.pos=m+l,i||(this.currentSegment.clusterSeekStartPos=this.metadataReader.pos)}for(let c of Da){if(this.currentSegment[c.flag])continue;let u=this.currentSegment.seekEntries.find(p=>p.id===c.id);if(!u)continue;this.metadataReader.pos=r+u.segmentPosition,await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+2**12);let{id:l,size:m}=this.metadataReader.readElementHeader();l===c.id&&(this.currentSegment[c.flag]=!0,await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+m),this.readContiguousElements(this.metadataReader,m))}this.currentSegment.tracks.sort((c,u)=>Number(u.isDefault)-Number(c.isDefault)),this.currentSegment.cuePoints.sort((c,u)=>c.clusterPosition-u.clusterPosition);let a=this.currentSegment.tracks.map(c=>c.id),s=new Set,o=null,d=null;for(let c of this.currentSegment.cuePoints){if(c.clusterPosition!==o){for(let l of s)f(d),this.currentSegment.tracks.find(p=>p.id===l).cuePoints.push(d);for(let l of a)s.add(l)}if(d=c,!s.has(c.trackId))continue;this.currentSegment.tracks.find(l=>l.id===c.trackId).cuePoints.push(c),s.delete(c.trackId),o=c.clusterPosition}for(let c of s)f(d),this.currentSegment.tracks.find(l=>l.id===c).cuePoints.push(d);for(let c of this.currentSegment.tracks)c.cuePoints.sort((u,l)=>u.time-l.time);this.currentSegment=null}async readCluster(t){await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+kt);let r=this.metadataReader.pos,{id:i,size:a}=this.metadataReader.readElementHeader(),s=this.metadataReader.pos;f(i===524531317),this.clusterReader.pos=s,await this.clusterReader.reader.loadRange(this.clusterReader.pos,this.clusterReader.pos+a);let o={elementStartPos:r,elementEndPos:s+a,dataStartPos:s,timestamp:-1,trackData:new Map,nextCluster:null,isKnownToBeFirstCluster:!1};this.currentCluster=o,this.readContiguousElements(this.clusterReader,a);for(let[c,u]of o.trackData){let l=!1;f(u.blocks.length>0);for(let g=0;g<u.blocks.length;g++){let k=u.blocks[g];k.timestamp+=o.timestamp,l||=k.referencedTimestamps.length>0}l&&(u.blocks=Cs(u.blocks)),u.presentationTimestamps=u.blocks.map((g,k)=>({timestamp:g.timestamp,blockIndex:k})).sort((g,k)=>g.timestamp-k.timestamp);let m=!1;for(let g=0;g<u.presentationTimestamps.length;g++){let k=u.presentationTimestamps[g],x=u.blocks[k.blockIndex];if(x.isKeyFrame&&(m=!0,u.firstKeyFrameTimestamp===null&&x.isKeyFrame&&(u.firstKeyFrameTimestamp=x.timestamp)),g<u.presentationTimestamps.length-1){let w=u.presentationTimestamps[g+1],T=u.blocks[w.blockIndex];x.duration=T.timestamp-x.timestamp}}let p=u.blocks[u.presentationTimestamps[0].blockIndex],h=u.blocks[M(u.presentationTimestamps).blockIndex];u.startTimestamp=p.timestamp,u.endTimestamp=h.timestamp+h.duration;let b=t.tracks.find(g=>g.id===c);if(b){let g=R(b.clusters,o.timestamp,k=>k.timestamp);if(b.clusters.splice(g+1,0,o),m){let k=R(b.clustersWithKeyFrame,o.timestamp,x=>x.timestamp);b.clustersWithKeyFrame.splice(k+1,0,o)}}}let d=R(t.clusters,r,c=>c.elementStartPos);return t.clusters.splice(d+1,0,o),this.currentCluster=null,o}getTrackDataInCluster(t,r){let i=t.trackData.get(r);return i||(i={startTimestamp:0,endTimestamp:0,firstKeyFrameTimestamp:null,blocks:[],presentationTimestamps:[]},t.trackData.set(r,i)),i}readContiguousElements(t,r){let i=t.pos;for(;t.pos-i<r;)this.traverseElement(t)}traverseElement(t){let{id:r,size:i}=t.readElementHeader(),a=t.pos;switch(r){case 17026:this.isWebM=t.readString(i)==="webm";break;case 19899:{if(!this.currentSegment)break;let s={id:-1,segmentPosition:-1};this.currentSegment.seekEntries.push(s),this.readContiguousElements(t,i),(s.id===-1||s.segmentPosition===-1)&&this.currentSegment.seekEntries.pop()}break;case 21419:{let s=this.currentSegment?.seekEntries[this.currentSegment.seekEntries.length-1];if(!s)break;s.id=t.readUnsignedInt(i)}break;case 21420:{let s=this.currentSegment?.seekEntries[this.currentSegment.seekEntries.length-1];if(!s)break;s.segmentPosition=t.readUnsignedInt(i)}break;case 2807729:{if(!this.currentSegment)break;this.currentSegment.timestampScale=t.readUnsignedInt(i),this.currentSegment.timestampFactor=1e9/this.currentSegment.timestampScale}break;case 17545:{if(!this.currentSegment)break;this.currentSegment.duration=t.readFloat(i)}break;case 174:{if(!this.currentSegment)break;if(this.currentTrack={id:-1,segment:this.currentSegment,demuxer:this,clusters:[],clustersWithKeyFrame:[],cuePoints:[],isDefault:!1,inputTrack:null,codecId:null,codecPrivate:null,languageCode:j,info:null},this.readContiguousElements(t,i),this.currentTrack&&this.currentTrack.id!==-1&&this.currentTrack.codecId&&this.currentTrack.info){let s=this.currentTrack.codecId.indexOf("/"),o=s===-1?this.currentTrack.codecId:this.currentTrack.codecId.slice(0,s);if(this.currentTrack.info.type==="video"&&this.currentTrack.info.width!==-1&&this.currentTrack.info.height!==-1){this.currentTrack.codecId===ee.avc?this.currentTrack.info.codec="avc":this.currentTrack.codecId===ee.hevc?this.currentTrack.info.codec="hevc":o===ee.vp8?this.currentTrack.info.codec="vp8":o===ee.vp9?this.currentTrack.info.codec="vp9":o===ee.av1&&(this.currentTrack.info.codec="av1");let d=this.currentTrack,c=new ce(new Va(d));this.currentTrack.inputTrack=c,this.currentSegment.tracks.push(this.currentTrack)}else if(this.currentTrack.info.type==="audio"&&this.currentTrack.info.numberOfChannels!==-1&&this.currentTrack.info.sampleRate!==-1){o===ee.aac?(this.currentTrack.info.codec="aac",this.currentTrack.info.aacCodecInfo={isMpeg2:this.currentTrack.codecId.includes("MPEG2")}):this.currentTrack.codecId===ee.mp3?this.currentTrack.info.codec="mp3":o===ee.opus?this.currentTrack.info.codec="opus":o===ee.vorbis?this.currentTrack.info.codec="vorbis":o===ee.flac?this.currentTrack.info.codec="flac":this.currentTrack.codecId==="A_PCM/INT/LIT"?this.currentTrack.info.bitDepth===8?this.currentTrack.info.codec="pcm-u8":this.currentTrack.info.bitDepth===16?this.currentTrack.info.codec="pcm-s16":this.currentTrack.info.bitDepth===24?this.currentTrack.info.codec="pcm-s24":this.currentTrack.info.bitDepth===32&&(this.currentTrack.info.codec="pcm-s32"):this.currentTrack.codecId==="A_PCM/INT/BIG"?this.currentTrack.info.bitDepth===8?this.currentTrack.info.codec="pcm-u8":this.currentTrack.info.bitDepth===16?this.currentTrack.info.codec="pcm-s16be":this.currentTrack.info.bitDepth===24?this.currentTrack.info.codec="pcm-s24be":this.currentTrack.info.bitDepth===32&&(this.currentTrack.info.codec="pcm-s32be"):this.currentTrack.codecId==="A_PCM/FLOAT/IEEE"&&this.currentTrack.info.bitDepth===32&&(this.currentTrack.info.codec="pcm-f32");let d=this.currentTrack,c=new G(new za(d));this.currentTrack.inputTrack=c,this.currentSegment.tracks.push(this.currentTrack)}}this.currentTrack=null}break;case 215:{if(!this.currentTrack)break;this.currentTrack.id=t.readUnsignedInt(i)}break;case 131:{if(!this.currentTrack)break;let s=t.readUnsignedInt(i);s===1?this.currentTrack.info={type:"video",width:-1,height:-1,rotation:0,codec:null,colorSpace:null}:s===2&&(this.currentTrack.info={type:"audio",numberOfChannels:-1,sampleRate:-1,bitDepth:-1,codec:null,aacCodecInfo:null})}break;case 185:{if(!this.currentTrack)break;t.readUnsignedInt(i)||(this.currentSegment.tracks.pop(),this.currentTrack=null)}break;case 136:{if(!this.currentTrack)break;this.currentTrack.isDefault=!!t.readUnsignedInt(i)}break;case 134:{if(!this.currentTrack)break;this.currentTrack.codecId=t.readString(i)}break;case 25506:{if(!this.currentTrack)break;this.currentTrack.codecPrivate=t.readBytes(i)}break;case 2274716:{if(!this.currentTrack)break;this.currentTrack.languageCode=t.readString(i),Ne(this.currentTrack.languageCode)||(this.currentTrack.languageCode=j)}break;case 224:{if(this.currentTrack?.info?.type!=="video")break;this.readContiguousElements(t,i)}break;case 176:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.width=t.readUnsignedInt(i)}break;case 186:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.height=t.readUnsignedInt(i)}break;case 21936:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.colorSpace={},this.readContiguousElements(t,i)}break;case 21937:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;let s=t.readUnsignedInt(i),o=$t[s]??null;this.currentTrack.info.colorSpace.matrix=o}break;case 21945:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;this.currentTrack.info.colorSpace.fullRange=t.readUnsignedInt(i)===2}break;case 21946:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;let s=t.readUnsignedInt(i),o=Ht[s]??null;this.currentTrack.info.colorSpace.transfer=o}break;case 21947:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;let s=t.readUnsignedInt(i),o=Lt[s]??null;this.currentTrack.info.colorSpace.primaries=o}break;case 30320:{if(this.currentTrack?.info?.type!=="video")break;this.readContiguousElements(t,i)}break;case 30325:{if(this.currentTrack?.info?.type!=="video")break;let o=-t.readFloat(i);try{this.currentTrack.info.rotation=Ie(o)}catch{}}break;case 225:{if(this.currentTrack?.info?.type!=="audio")break;this.readContiguousElements(t,i)}break;case 181:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.sampleRate=t.readFloat(i)}break;case 159:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.numberOfChannels=t.readUnsignedInt(i)}break;case 25188:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.bitDepth=t.readUnsignedInt(i)}break;case 187:{if(!this.currentSegment)break;this.readContiguousElements(t,i),this.currentCueTime=null}break;case 179:this.currentCueTime=t.readUnsignedInt(i);break;case 183:{if(this.currentCueTime===null)break;f(this.currentSegment);let s={time:this.currentCueTime,trackId:-1,clusterPosition:-1};this.currentSegment.cuePoints.push(s),this.readContiguousElements(t,i),(s.trackId===-1||s.clusterPosition===-1)&&this.currentSegment.cuePoints.pop()}break;case 247:{let s=this.currentSegment?.cuePoints[this.currentSegment.cuePoints.length-1];if(!s)break;s.trackId=t.readUnsignedInt(i)}break;case 241:{let s=this.currentSegment?.cuePoints[this.currentSegment.cuePoints.length-1];if(!s)break;f(this.currentSegment),s.clusterPosition=this.currentSegment.dataStartPos+t.readUnsignedInt(i)}break;case 231:{if(!this.currentCluster)break;this.currentCluster.timestamp=t.readUnsignedInt(i)}break;case 163:{if(!this.currentCluster)break;let s=t.readVarInt(),o=t.readS16(),c=!!(t.readU8()&128);this.getTrackDataInCluster(this.currentCluster,s).blocks.push({timestamp:o,duration:0,isKeyFrame:c,referencedTimestamps:[],data:t.readBytes(i-(t.pos-a))})}break;case 160:{if(!this.currentCluster)break;if(this.readContiguousElements(t,i),this.currentBlock){for(let s=0;s<this.currentBlock.referencedTimestamps.length;s++)this.currentBlock.referencedTimestamps[s]+=this.currentBlock.timestamp;this.currentBlock=null}}break;case 161:{if(!this.currentCluster)break;let s=t.readVarInt(),o=t.readS16(),d=t.readU8(),c=this.getTrackDataInCluster(this.currentCluster,s);this.currentBlock={timestamp:o,duration:0,isKeyFrame:!0,referencedTimestamps:[],data:t.readBytes(i-(t.pos-a))},c.blocks.push(this.currentBlock)}break;case 155:{if(!this.currentBlock)break;this.currentBlock.duration=t.readUnsignedInt(i)}break;case 251:{if(!this.currentBlock)break;this.currentBlock.isKeyFrame=!1;let s=t.readSignedInt(i);this.currentBlock.referencedTimestamps.push(s)}break}this.assertDefinedSize(i),t.pos=a+i}},zr=class{constructor(e){this.internalTrack=e;this.packetToClusterLocation=new WeakMap}getId(){return this.internalTrack.id}getCodec(){throw new Error("Not implemented on base class.")}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getLanguageCode(){return this.internalTrack.languageCode}async getFirstTimestamp(){return(await this.getFirstPacket({metadataOnly:!0}))?.timestamp??0}getTimeResolution(){return this.internalTrack.segment.timestampFactor}async getFirstPacket(e){return this.performClusterLookup(()=>{let t=this.internalTrack.segment.clusters[0]??null;if(t?.isKnownToBeFirstCluster){let r=t;for(;r;){if(r.trackData.get(this.internalTrack.id))return{clusterIndex:U(this.internalTrack.clusters,r.elementStartPos,a=>a.elementStartPos),blockIndex:0,correctBlockFound:!0};r=r.nextCluster}}return{clusterIndex:-1,blockIndex:-1,correctBlockFound:!1}},-1/0,1/0,e)}intoTimescale(e){return Be(e*this.internalTrack.segment.timestampFactor,14)}async getPacket(e,t){let r=this.intoTimescale(e);return this.performClusterLookup(()=>this.findBlockInClustersForTimestamp(r),r,r,t)}async getNextPacket(e,t){let r=this.packetToClusterLocation.get(e);if(r===void 0)throw new Error("Packet was not created from this track.");let i=r.cluster.trackData.get(this.internalTrack.id),a=i.blocks[r.blockIndex],s=U(this.internalTrack.clusters,r.cluster.elementStartPos,o=>o.elementStartPos);return f(s!==-1),this.performClusterLookup(()=>{if(r.blockIndex+1<i.blocks.length)return{clusterIndex:s,blockIndex:r.blockIndex+1,correctBlockFound:!0};{let o=r.cluster;for(;o.nextCluster;)if(o=o.nextCluster,o.trackData.get(this.internalTrack.id)){let c=U(this.internalTrack.clusters,o.elementStartPos,u=>u.elementStartPos);return f(c!==-1),{clusterIndex:c,blockIndex:0,correctBlockFound:!0}}return{clusterIndex:s,blockIndex:-1,correctBlockFound:!1}}},a.timestamp,1/0,t)}async getKeyPacket(e,t){let r=this.intoTimescale(e);return this.performClusterLookup(()=>this.findKeyBlockInClustersForTimestamp(r),r,r,t)}async getNextKeyPacket(e,t){let r=this.packetToClusterLocation.get(e);if(r===void 0)throw new Error("Packet was not created from this track.");let i=r.cluster.trackData.get(this.internalTrack.id),a=i.blocks[r.blockIndex],s=U(this.internalTrack.clusters,r.cluster.elementStartPos,o=>o.elementStartPos);return f(s!==-1),this.performClusterLookup(()=>{let o=i.blocks.findIndex((d,c)=>d.isKeyFrame&&c>r.blockIndex);if(o!==-1)return{clusterIndex:s,blockIndex:o,correctBlockFound:!0};{let d=r.cluster;for(;d.nextCluster;){d=d.nextCluster;let c=d.trackData.get(this.internalTrack.id);if(c&&c.firstKeyFrameTimestamp!==null){let u=U(this.internalTrack.clusters,d.elementStartPos,m=>m.elementStartPos);f(u!==-1);let l=c.blocks.findIndex(m=>m.isKeyFrame);return f(l!==-1),{clusterIndex:u,blockIndex:l,correctBlockFound:!0}}}return{clusterIndex:s,blockIndex:-1,correctBlockFound:!1}}},a.timestamp,1/0,t)}async fetchPacketInCluster(e,t,r){if(t===-1)return null;let a=e.trackData.get(this.internalTrack.id).blocks[t];f(a);let s=r.metadataOnly?te:a.data,o=a.timestamp/this.internalTrack.segment.timestampFactor,d=a.duration/this.internalTrack.segment.timestampFactor,c=new V(s,a.isKeyFrame?"key":"delta",o,d,e.dataStartPos+t,a.data.byteLength);return this.packetToClusterLocation.set(c,{cluster:e,blockIndex:t}),c}findBlockInClustersForTimestamp(e){let t=R(this.internalTrack.clusters,e,a=>a.trackData.get(this.internalTrack.id).startTimestamp),r=-1,i=!1;if(t!==-1){let s=this.internalTrack.clusters[t].trackData.get(this.internalTrack.id),o=R(s.presentationTimestamps,e,d=>d.timestamp);f(o!==-1),r=s.presentationTimestamps[o].blockIndex,i=e<s.endTimestamp}return{clusterIndex:t,blockIndex:r,correctBlockFound:i}}findKeyBlockInClustersForTimestamp(e){let t=R(this.internalTrack.clustersWithKeyFrame,e,s=>s.trackData.get(this.internalTrack.id).firstKeyFrameTimestamp),r=-1,i=-1,a=!1;if(t!==-1){let s=this.internalTrack.clustersWithKeyFrame[t];r=U(this.internalTrack.clusters,s.elementStartPos,u=>u.elementStartPos),f(r!==-1);let o=s.trackData.get(this.internalTrack.id),d=qt(o.presentationTimestamps,u=>o.blocks[u.blockIndex].isKeyFrame&&u.timestamp<=e);f(d!==-1),i=o.presentationTimestamps[d].blockIndex,a=e<o.endTimestamp}return{clusterIndex:r,blockIndex:i,correctBlockFound:a}}async performClusterLookup(e,t,r,i){let{demuxer:a,segment:s}=this.internalTrack,o=await s.clusterLookupMutex.acquire();try{let{clusterIndex:d,blockIndex:c,correctBlockFound:u}=e();if(u){let T=this.internalTrack.clusters[d];return this.fetchPacketInCluster(T,c,i)}let l=a.metadataReader,m=null,p=d,h=c,b=R(this.internalTrack.cuePoints,t,T=>T.time),g=b!==-1?this.internalTrack.cuePoints[b]:null,k=!1;if(d===-1)l.pos=g?.clusterPosition??s.clusterSeekStartPos,k=l.pos===s.clusterSeekStartPos;else{let T=this.internalTrack.clusters[d];!g||T.elementStartPos>=g.clusterPosition?(l.pos=T.elementEndPos,m=T):l.pos=g.clusterPosition}for(;l.pos<s.elementEndPos;){if(m){let I=m.trackData.get(this.internalTrack.id);if(I&&I.startTimestamp>r)break;if(m.nextCluster){l.pos=m.nextCluster.elementEndPos,m=m.nextCluster;continue}}await l.reader.loadRange(l.pos,l.pos+kt);let T=l.pos,{id:S,size:y}=l.readElementHeader(),P=l.pos;if(S===524531317){let I=U(s.clusters,T,Pe=>Pe.elementStartPos),E;I===-1?(l.pos=T,E=await a.readCluster(s)):E=s.clusters[I],m&&(m.nextCluster=E),m=E,k&&(E.isKnownToBeFirstCluster=!0,k=!1);let{clusterIndex:z,blockIndex:N,correctBlockFound:K}=e();if(K){let Pe=this.internalTrack.clusters[z];return this.fetchPacketInCluster(Pe,N,i)}z!==-1&&(p=z,h=N)}l.pos=P+y}let x=null,w=p!==-1?this.internalTrack.clusters[p]:null;if(w&&(x=await this.fetchPacketInCluster(w,h,i)),!x&&g&&(!w||w.elementStartPos<g.clusterPosition)){let S=this.internalTrack.cuePoints[b-1]?.time??-1/0;return this.performClusterLookup(e,S,r,i)}return x}finally{o()}}},Va=class extends zr{constructor(t){super(t);this.decoderConfigPromise=null;this.internalTrack=t}getCodec(){return this.internalTrack.info.codec}getCodedWidth(){return this.internalTrack.info.width}getCodedHeight(){return this.internalTrack.info.height}getRotation(){return this.internalTrack.info.rotation}async getColorSpace(){return{primaries:this.internalTrack.info.colorSpace?.primaries,transfer:this.internalTrack.info.colorSpace?.transfer,matrix:this.internalTrack.info.colorSpace?.matrix,fullRange:this.internalTrack.info.colorSpace?.fullRange}}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfigPromise??=(async()=>{let t=null;return(this.internalTrack.info.codec==="vp9"||this.internalTrack.info.codec==="av1")&&(t=await this.getFirstPacket({})),{codec:rr({width:this.internalTrack.info.width,height:this.internalTrack.info.height,codec:this.internalTrack.info.codec,codecDescription:this.internalTrack.codecPrivate,colorSpace:this.internalTrack.info.colorSpace,vp9CodecInfo:this.internalTrack.info.codec==="vp9"&&t?ar(t.data):null,av1CodecInfo:this.internalTrack.info.codec==="av1"&&t?ai(t.data):null}),codedWidth:this.internalTrack.info.width,codedHeight:this.internalTrack.info.height,description:this.internalTrack.codecPrivate??void 0,colorSpace:this.internalTrack.info.colorSpace??void 0}})():null}},za=class extends zr{constructor(t){super(t);this.decoderConfig=null;this.internalTrack=t}getCodec(){return this.internalTrack.info.codec}getNumberOfChannels(){return this.internalTrack.info.numberOfChannels}getSampleRate(){return this.internalTrack.info.sampleRate}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfig??={codec:ir({codec:this.internalTrack.info.codec,codecDescription:this.internalTrack.codecPrivate,aacCodecInfo:this.internalTrack.info.aacCodecInfo}),numberOfChannels:this.internalTrack.info.numberOfChannels,sampleRate:this.internalTrack.info.sampleRate,description:this.internalTrack.codecPrivate??void 0}:null}},Cs=n=>{let e=new Map;for(let a=0;a<n.length;a++){let s=n[a];e.set(s.timestamp,s)}let t=new Set,r=[],i=a=>{if(!t.has(a)){t.add(a);for(let s=0;s<a.referencedTimestamps.length;s++){let o=a.referencedTimestamps[s],d=e.get(o);d&&i(d)}r.push(a)}};for(let a=0;a<n.length;a++)i(n[a]);return r};var st=class{constructor(e){this.reader=e;this.pos=0;this.fileSize=null}readBytes(e){let{view:t,offset:r}=this.reader.getViewAndOffset(this.pos,this.pos+e);return this.pos+=e,new Uint8Array(t.buffer,r,e)}readU16(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+2);return this.pos+=2,e.getUint16(t,!1)}readU32(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+4);return this.pos+=4,e.getUint32(t,!1)}readAscii(e){let{view:t,offset:r}=this.reader.getViewAndOffset(this.pos,this.pos+e);this.pos+=e;let i="";for(let a=0;a<e;a++)i+=String.fromCharCode(t.getUint8(r+a));return i}readId3(){return this.readAscii(3)!=="ID3"?(this.pos-=3,null):(this.pos+=3,{size:Is(this.readU32())})}readNextFrameHeader(e){for(f(this.fileSize),e??=this.fileSize;this.pos<e-4;){let t=this.readU32();this.pos-=4;let r=Sr(t,this);if(r)return r}return null}},Is=n=>{let e=2130706432,t=0;for(;e!==0;)t>>=1,t|=n&e,e>>=8;return t};var Ur=class extends ie{constructor(t){super(t);this.metadataPromise=null;this.firstFrameHeader=null;this.allSamples=[];this.tracks=[];this.reader=new st(t._mainReader)}async readMetadata(){return this.metadataPromise??=(async()=>{let t=await this.input._source._getSize();this.reader.fileSize=t,await this.reader.reader.loadRange(0,t);let r=this.reader.readId3();r&&(this.reader.pos+=r.size);let i=0;for(;;){let a=this.reader.readNextFrameHeader();if(!a)break;let s=Ye(a.mpegVersionId,a.channel);this.reader.pos=a.startPos+s;let o=this.reader.readU32(),d=o===Xe||o===wr;if(this.reader.pos=a.startPos+a.totalSize-1,d)continue;this.firstFrameHeader||(this.firstFrameHeader=a);let c=a.audioSamplesInFrame/a.sampleRate,u={timestamp:i/a.sampleRate,duration:c,dataStart:a.startPos,dataSize:a.totalSize};this.allSamples.push(u),i+=a.audioSamplesInFrame}if(!this.firstFrameHeader)throw new Error("No MP3 frames found.");this.tracks=[new G(new Ua(this))]})()}async getMimeType(){return"audio/mpeg"}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){await this.readMetadata();let t=M(this.allSamples);return f(t),t.timestamp+t.duration}},Ua=class{constructor(e){this.demuxer=e}getId(){return 1}async getFirstTimestamp(){return 0}getTimeResolution(){return f(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.sampleRate/this.demuxer.firstFrameHeader.audioSamplesInFrame}computeDuration(){return this.demuxer.computeDuration()}getLanguageCode(){return j}getCodec(){return"mp3"}getNumberOfChannels(){return f(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.channel===3?1:2}getSampleRate(){return f(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.sampleRate}async getDecoderConfig(){return f(this.demuxer.firstFrameHeader),{codec:"mp3",numberOfChannels:this.demuxer.firstFrameHeader.channel===3?1:2,sampleRate:this.demuxer.firstFrameHeader.sampleRate}}getPacketAtIndex(e,t){if(e===-1)return null;let r=this.demuxer.allSamples[e];if(!r)return null;let i;return t.metadataOnly?i=te:(this.demuxer.reader.pos=r.dataStart,i=this.demuxer.reader.readBytes(r.dataSize)),new V(i,"key",r.timestamp,r.duration,e)}async getFirstPacket(e){return this.getPacketAtIndex(0,e)}async getNextPacket(e,t){let r=U(this.demuxer.allSamples,e.timestamp,i=>i.timestamp);if(r===-1)throw new Error("Packet was not created from this track.");return this.getPacketAtIndex(r+1,t)}async getPacket(e,t){let r=R(this.demuxer.allSamples,e,i=>i.timestamp);return this.getPacketAtIndex(r,t)}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}};var Br=class extends ie{constructor(t){super(t);this.metadataPromise=null;this.fileSize=null;this.bitstreams=[];this.tracks=[];this.reader=new Ze(new ne(t._source,64*2**20))}async readMetadata(){return this.metadataPromise??=(async()=>{for(this.fileSize=await this.input._source._getSize();this.reader.pos<this.fileSize-Je;){await this.reader.reader.loadRange(this.reader.pos,this.reader.pos+Me);let t=this.reader.readPageHeader();if(!t||!!!(t.headerType&2))break;this.bitstreams.push({serialNumber:t.serialNumber,bosPage:t,description:null,numberOfChannels:-1,sampleRate:-1,codecInfo:{codec:null,vorbisInfo:null,opusInfo:null},lastMetadataPacket:null}),this.reader.pos=t.headerStartPos+t.totalSize}for(let t of this.bitstreams){let r=await this.readPacket(this.reader,t.bosPage,0);r&&(r.data.byteLength>=7&&r.data[0]===1&&r.data[1]===118&&r.data[2]===111&&r.data[3]===114&&r.data[4]===98&&r.data[5]===105&&r.data[6]===115?await this.readVorbisMetadata(r,t):r.data.byteLength>=8&&r.data[0]===79&&r.data[1]===112&&r.data[2]===117&&r.data[3]===115&&r.data[4]===72&&r.data[5]===101&&r.data[6]===97&&r.data[7]===100&&await this.readOpusMetadata(r,t),t.codecInfo.codec!==null&&this.tracks.push(new G(new Ba(t,this))))}})()}async readVorbisMetadata(t,r){let i=await this.findNextPacketStart(this.reader,t);if(!i)return;let a=await this.readPacket(this.reader,i.startPage,i.startSegmentIndex);if(!a||(i=await this.findNextPacketStart(this.reader,a),!i))return;let s=await this.readPacket(this.reader,i.startPage,i.startSegmentIndex);if(!s||a.data[0]!==3||s.data[0]!==5)return;let o=[],d=m=>{for(;o.push(Math.min(255,m)),!(m<255);)m-=255};d(t.data.length),d(a.data.length);let c=new Uint8Array(1+o.length+t.data.length+a.data.length+s.data.length);c[0]=o.length,c.set(o,1),c.set(t.data,1+o.length),c.set(a.data,1+o.length+t.data.length),c.set(s.data,1+o.length+t.data.length+a.data.length),r.codecInfo.codec="vorbis",r.description=c,r.lastMetadataPacket=s;let u=Y(t.data);r.numberOfChannels=u.getUint8(11),r.sampleRate=u.getUint32(12,!0);let l=u.getUint8(28);r.codecInfo.vorbisInfo={blocksizes:[1<<(l&15),1<<(l>>4)],modeBlockflags:Ir(s.data).modeBlockflags}}async readOpusMetadata(t,r){let i=await this.findNextPacketStart(this.reader,t);if(!i)return;let a=await this.readPacket(this.reader,i.startPage,i.startSegmentIndex);if(!a)return;r.codecInfo.codec="opus",r.description=t.data,r.lastMetadataPacket=a;let s=Ee(t.data);r.numberOfChannels=s.outputChannelCount,r.sampleRate=s.inputSampleRate,r.codecInfo.opusInfo={preSkip:s.preSkip}}async readPacket(t,r,i){f(i<r.lacingValues.length),f(this.fileSize);let a=0;for(let p=0;p<i;p++)a+=r.lacingValues[p];let s=r,o=a,d=i,c=[];e:for(;;){await t.reader.loadRange(s.dataStartPos,s.dataStartPos+s.dataSize),t.pos=s.dataStartPos;let p=t.readBytes(s.dataSize);for(;;){if(d===s.lacingValues.length){c.push(p.subarray(a,o));break}let h=s.lacingValues[d];if(o+=h,h<255){c.push(p.subarray(a,o));break e}d++}for(;;){if(t.pos=s.headerStartPos+s.totalSize,t.pos>=this.fileSize-Je)return null;await t.reader.loadRange(t.pos,t.pos+Me);let h=t.readPageHeader();if(!h)return null;if(s=h,s.serialNumber===r.serialNumber)break}a=0,o=0,d=0}let u=c.reduce((p,h)=>p+h.length,0),l=new Uint8Array(u),m=0;for(let p=0;p<c.length;p++){let h=c[p];l.set(h,m),m+=h.length}return{data:l,endPage:s,endSegmentIndex:d}}async findNextPacketStart(t,r){if(f(this.fileSize!==null),r.endSegmentIndex<r.endPage.lacingValues.length-1)return{startPage:r.endPage,startSegmentIndex:r.endSegmentIndex+1};if(!!(r.endPage.headerType&4))return null;for(t.pos=r.endPage.headerStartPos+r.endPage.totalSize;;){if(t.pos>=this.fileSize-Je)return null;await t.reader.loadRange(t.pos,t.pos+Me);let a=t.readPageHeader();if(!a)return null;if(a.serialNumber===r.endPage.serialNumber)return{startPage:a,startSegmentIndex:0};t.pos=a.headerStartPos+a.totalSize}}async getMimeType(){await this.readMetadata();let t="audio/ogg";if(this.tracks.length>0){let r=await Promise.all(this.tracks.map(a=>a.getCodecParameterString())),i=[...new Set(r.filter(Boolean))];t+=`; codecs="${i.join(", ")}"`}return t}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){let t=await this.getTracks(),r=await Promise.all(t.map(i=>i.computeDuration()));return Math.max(0,...r)}},Ba=class{constructor(e,t){this.bitstream=e;this.demuxer=t;this.encodedPacketToMetadata=new WeakMap;this.internalSampleRate=e.codecInfo.codec==="opus"?He:e.sampleRate}getId(){return this.bitstream.serialNumber}getNumberOfChannels(){return this.bitstream.numberOfChannels}getSampleRate(){return this.bitstream.sampleRate}getTimeResolution(){return this.bitstream.sampleRate}getCodec(){return this.bitstream.codecInfo.codec}async getDecoderConfig(){return f(this.bitstream.codecInfo.codec),{codec:this.bitstream.codecInfo.codec,numberOfChannels:this.bitstream.numberOfChannels,sampleRate:this.bitstream.sampleRate,description:this.bitstream.description??void 0}}getLanguageCode(){return j}async getFirstTimestamp(){return 0}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}granulePositionToTimestampInSamples(e){return this.bitstream.codecInfo.codec==="opus"?(f(this.bitstream.codecInfo.opusInfo),e-this.bitstream.codecInfo.opusInfo.preSkip):e}createEncodedPacketFromOggPacket(e,t,r){if(!e)return null;let{durationInSamples:i,vorbisBlockSize:a}=Pr(e.data,this.bitstream.codecInfo,t.vorbisLastBlocksize),s=new V(r.metadataOnly?te:e.data,"key",Math.max(0,t.timestampInSamples)/this.internalSampleRate,i/this.internalSampleRate,e.endPage.headerStartPos+e.endSegmentIndex);return this.encodedPacketToMetadata.set(s,{packet:e,timestampInSamples:t.timestampInSamples,durationInSamples:i,vorbisBlockSize:a}),s}async getFirstPacket(e){f(this.bitstream.lastMetadataPacket);let t=await this.demuxer.findNextPacketStart(this.demuxer.reader,this.bitstream.lastMetadataPacket);if(!t)return null;let r=0;this.bitstream.codecInfo.codec==="opus"&&(f(this.bitstream.codecInfo.opusInfo),r-=this.bitstream.codecInfo.opusInfo.preSkip);let i=await this.demuxer.readPacket(this.demuxer.reader,t.startPage,t.startSegmentIndex);return this.createEncodedPacketFromOggPacket(i,{timestampInSamples:r,vorbisLastBlocksize:null},e)}async getNextPacket(e,t){let r=this.encodedPacketToMetadata.get(e);if(!r)throw new Error("Packet was not created from this track.");let i=await this.demuxer.findNextPacketStart(this.demuxer.reader,r.packet);if(!i)return null;let a=r.timestampInSamples+r.durationInSamples,s=await this.demuxer.readPacket(this.demuxer.reader,i.startPage,i.startSegmentIndex);return this.createEncodedPacketFromOggPacket(s,{timestampInSamples:a,vorbisLastBlocksize:r.vorbisBlockSize},t)}async getPacket(e,t){f(this.demuxer.fileSize!==null);let r=Be(e*this.internalSampleRate,14);if(r===0)return this.getFirstPacket(t);if(r<0)return null;let i=this.demuxer.reader;f(this.bitstream.lastMetadataPacket);let a=await this.demuxer.findNextPacketStart(i,this.bitstream.lastMetadataPacket);if(!a)return null;let s=a.startPage,o=this.demuxer.fileSize,d=[s];e:for(;s.headerStartPos+s.totalSize<o;){let w=s.headerStartPos,T=Math.floor((w+o)/2),S=T;for(;;){let y=Math.min(S+vr,o-Je);if(await i.reader.loadRange(S,y),i.pos=S,!i.findNextPageHeader(y)){o=T+Je;continue e}await i.reader.loadRange(i.pos,i.pos+Me);let I=i.readPageHeader();f(I);let E=!1;if(I.serialNumber===this.bitstream.serialNumber)E=!0;else{await i.reader.loadRange(I.headerStartPos,I.headerStartPos+I.totalSize),i.pos=I.headerStartPos;let N=i.readBytes(I.totalSize);E=Cr(N)===I.checksum}if(!E){S=I.headerStartPos+4;continue}if(E&&I.serialNumber!==this.bitstream.serialNumber){S=I.headerStartPos+I.totalSize;continue}if(I.granulePosition===-1){S=I.headerStartPos+I.totalSize;continue}this.granulePositionToTimestampInSamples(I.granulePosition)>r?o=I.headerStartPos:(s=I,d.push(I));continue e}}let c=a.startPage;for(let w of d){if(w.granulePosition===s.granulePosition)break;(!c||w.headerStartPos>c.headerStartPos)&&(c=w)}let u=c,l=[u];for(;!(u.serialNumber===this.bitstream.serialNumber&&u.granulePosition===s.granulePosition);){i.pos=u.headerStartPos+u.totalSize,await i.reader.loadRange(i.pos,i.pos+Me);let w=i.readPageHeader();f(w),u=w,u.serialNumber===this.bitstream.serialNumber&&l.push(u)}f(u.granulePosition!==-1);let m=null,p,h,b=u,g=0;if(u.headerStartPos===a.startPage.headerStartPos)p=this.granulePositionToTimestampInSamples(0),h=!0,m=0;else{p=0,h=!1;for(let S=u.lacingValues.length-1;S>=0;S--)if(u.lacingValues[S]<255){m=S+1;break}if(m===null)throw new Error("Invalid page with granule position: no packets end on this page.");g=m-1;let w={data:te,endPage:b,endSegmentIndex:g};if(await this.demuxer.findNextPacketStart(i,w)){let S=zi(l,u,m);f(S);let y=Vi(l,S.page,S.segmentIndex);y&&(u=y.page,m=y.segmentIndex)}else for(;;){let S=zi(l,u,m);if(!S)break;let y=Vi(l,S.page,S.segmentIndex);if(!y)break;if(u=y.page,m=y.segmentIndex,S.page.headerStartPos!==b.headerStartPos){b=S.page,g=S.segmentIndex;break}}}let k=null,x=null;for(;u!==null;){f(m!==null);let w=await this.demuxer.readPacket(i,u,m);if(!w)break;if(!(u.headerStartPos===a.startPage.headerStartPos&&m<a.startSegmentIndex)){let y=this.createEncodedPacketFromOggPacket(w,{timestampInSamples:p,vorbisLastBlocksize:x?.vorbisBlockSize??null},t);f(y);let P=this.encodedPacketToMetadata.get(y);if(f(P),!h&&w.endPage.headerStartPos===b.headerStartPos&&w.endSegmentIndex===g?(p=this.granulePositionToTimestampInSamples(u.granulePosition),h=!0,y=this.createEncodedPacketFromOggPacket(w,{timestampInSamples:p-P.durationInSamples,vorbisLastBlocksize:x?.vorbisBlockSize??null},t),f(y),P=this.encodedPacketToMetadata.get(y),f(P)):p+=P.durationInSamples,k=y,x=P,h&&(Math.max(p,0)>r||Math.max(P.timestampInSamples,0)===r))break}let S=await this.demuxer.findNextPacketStart(i,w);if(!S)break;u=S.startPage,m=S.startSegmentIndex}return k}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}},Vi=(n,e,t)=>{let r=e,i=t;e:for(;;){for(i--,i;i>=0;i--)if(r.lacingValues[i]<255){i++;break e}if(f(i===-1),!(r.headerType&1)){i=0;break}let s=Kr(n,o=>o.headerStartPos<r.headerStartPos);if(!s)return null;r=s,i=r.lacingValues.length}if(f(i!==-1),i===r.lacingValues.length){let a=n[n.indexOf(r)+1];f(a),r=a,i=0}return{page:r,segmentIndex:i}},zi=(n,e,t)=>{if(t>0)return{page:e,segmentIndex:t-1};let r=Kr(n,i=>i.headerStartPos<e.headerStartPos);return r?{page:r,segmentIndex:r.lacingValues.length-1}:null};var he=class{},Bt=class extends he{async _getMajorBrand(e){if(await e._mainReader.source._getSize()<12)return null;let r=new ze(e._mainReader);return r.pos=4,r.readAscii(4)!=="ftyp"?null:r.readAscii(4)}_createDemuxer(e){return new Mr(e)}},Nr=class extends Bt{async _canReadInput(e){let t=await this._getMajorBrand(e);return!!t&&t!=="qt  "}getName(){return"MP4"}getMimeType(){return"video/mp4"}},Wr=class extends Bt{async _canReadInput(e){return await this._getMajorBrand(e)==="qt  "}getName(){return"QuickTime File Format"}getMimeType(){return"video/quicktime"}},Nt=class extends he{async isSupportedEBMLOfDocType(e,t){if(await e._mainReader.source._getSize()<8)return!1;let i=new Fe(e._mainReader),a=i.readVarIntSize();if(a<1||a>8||i.readUnsignedInt(a)!==440786851)return!1;let o=i.readElementSize();if(o===-1)return!1;let d=i.pos;for(;i.pos<d+o;){let{id:c,size:u}=i.readElementHeader(),l=i.pos;if(u===-1)return!1;switch(c){case 17030:if(i.readUnsignedInt(u)!==1)return!1;break;case 17143:if(i.readUnsignedInt(u)!==1)return!1;break;case 17026:if(i.readString(u)!==t)return!1;break;case 17031:if(i.readUnsignedInt(u)>4)return!1;break}i.pos=l+u}return!0}_canReadInput(e){return this.isSupportedEBMLOfDocType(e,"matroska")}_createDemuxer(e){return new Vr(e)}getName(){return"Matroska"}getMimeType(){return"video/x-matroska"}},Lr=class extends Nt{_canReadInput(e){return this.isSupportedEBMLOfDocType(e,"webm")}getName(){return"WebM"}getMimeType(){return"video/webm"}},Hr=class extends he{async _canReadInput(e){let t=await e._mainReader.source._getSize();if(t<4)return!1;let r=new st(e._mainReader);r.fileSize=t;let i=r.readId3();i&&(r.pos+=i.size);let a=r.pos;await r.reader.loadRange(r.pos,r.pos+4096);let s=r.readNextFrameHeader(a+4096);if(!s)return!1;if(i)return!0;r.pos=s.startPos+s.totalSize;let o=r.readNextFrameHeader(a+4096);return!(!o||s.channel!==o.channel||s.sampleRate!==o.sampleRate)}_createDemuxer(e){return new Ur(e)}getName(){return"MP3"}getMimeType(){return"audio/mpeg"}},$r=class extends he{async _canReadInput(e){if(await e._mainReader.source._getSize()<12)return!1;let r=new Ve(e._mainReader),i=r.readAscii(4);return i!=="RIFF"&&i!=="RIFX"?!1:(r.pos=8,r.readAscii(4)==="WAVE")}_createDemuxer(e){return new Ar(e)}getName(){return"WAVE"}getMimeType(){return"audio/wav"}},Qr=class extends he{async _canReadInput(e){return await e._mainReader.source._getSize()<4?!1:new Ze(e._mainReader).readAscii(4)==="OggS"}_createDemuxer(e){return new Br(e)}getName(){return"Ogg"}getMimeType(){return"application/ogg"}},Ui=new Nr,Bi=new Wr,Ni=new Nt,Wi=new Lr,Li=new Hr,Hi=new $r,$i=new Qr,vs=[Ui,Bi,Ni,Wi,Hi,$i,Li];var Wt=class{constructor(e){this._demuxerPromise=null;this._format=null;if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(!Array.isArray(e.formats)||e.formats.some(t=>!(t instanceof he)))throw new TypeError("options.formats must be an array of InputFormat.");if(!(e.source instanceof Ce))throw new TypeError("options.source must be a Source.");this._formats=e.formats,this._source=e.source,this._mainReader=new ne(e.source)}_getDemuxer(){return this._demuxerPromise??=(async()=>{await this._mainReader.loadRange(0,4096);for(let e of this._formats)if(await e._canReadInput(this))return this._format=e,e._createDemuxer(this);throw new Error("Input has an unsupported or unrecognizable format.")})()}async getFormat(){return await this._getDemuxer(),f(this._format),this._format}async computeDuration(){return(await this._getDemuxer()).computeDuration()}async getTracks(){return(await this._getDemuxer()).getTracks()}async getVideoTracks(){return(await this.getTracks()).filter(t=>t.isVideoTrack())}async getPrimaryVideoTrack(){return(await this.getTracks()).find(t=>t.isVideoTrack())??null}async getAudioTracks(){return(await this.getTracks()).filter(t=>t.isAudioTrack())}async getPrimaryAudioTrack(){return(await this.getTracks()).find(t=>t.isAudioTrack())??null}async getMimeType(){return(await this._getDemuxer()).getMimeType()}async getSize(){return await this._source._getSize()}};var Na=2,Wa=48e3,Es=async n=>{let e=await qr.init(n);return await e.execute(),e},qr=class n{constructor(e){this._addedCounts={video:0,audio:0,subtitle:0};this._totalTrackCount=0;this._trackPromises=[];this._executed=!1;this._synchronizer=new La;this._totalDuration=null;this._maxTimestamps=new Map;this._canceled=!1;this.progress=0;this.onProgress=void 0;this.utilizedTracks=[];this.discardedTracks=[];if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(!(e.input instanceof Wt))throw new TypeError("options.input must be an Input.");if(!(e.output instanceof zt))throw new TypeError("options.output must be an Output.");if(e.video!==void 0&&(!e.video||typeof e.video!="object"))throw new TypeError("options.video, when provided, must be an object.");if(e.video?.discard!==void 0&&typeof e.video.discard!="boolean")throw new TypeError("options.video.discard, when provided, must be a boolean.");if(e.video?.forceReencode!==void 0&&typeof e.video.forceReencode!="boolean")throw new TypeError("options.video.forceReencode, when provided, must be a boolean.");if(e.video?.codec!==void 0&&!H.includes(e.video.codec))throw new TypeError(`options.video.codec, when provided, must be one of: ${H.join(", ")}.`);if(e.video?.bitrate!==void 0&&!(e.video.bitrate instanceof X)&&(!Number.isInteger(e.video.bitrate)||e.video.bitrate<=0))throw new TypeError("options.video.bitrate, when provided, must be a positive integer or a quality.");if(e.video?.width!==void 0&&(!Number.isInteger(e.video.width)||e.video.width<=0))throw new TypeError("options.video.width, when provided, must be a positive integer.");if(e.video?.height!==void 0&&(!Number.isInteger(e.video.height)||e.video.height<=0))throw new TypeError("options.video.height, when provided, must be a positive integer.");if(e.video?.fit!==void 0&&!["fill","contain","cover"].includes(e.video.fit))throw new TypeError('options.video.fit, when provided, must be one of "fill", "contain", or "cover".');if(e.video?.width!==void 0&&e.video.height!==void 0&&e.video.fit===void 0)throw new TypeError("When both options.video.width and options.video.height are provided, options.video.fit must also be provided.");if(e.video?.rotate!==void 0&&![0,90,180,270].includes(e.video.rotate))throw new TypeError("options.video.rotate, when provided, must be 0, 90, 180 or 270.");if(e.audio!==void 0&&(!e.audio||typeof e.audio!="object"))throw new TypeError("options.video, when provided, must be an object.");if(e.audio?.discard!==void 0&&typeof e.audio.discard!="boolean")throw new TypeError("options.audio.discard, when provided, must be a boolean.");if(e.audio?.forceReencode!==void 0&&typeof e.audio.forceReencode!="boolean")throw new TypeError("options.audio.forceReencode, when provided, must be a boolean.");if(e.audio?.codec!==void 0&&!q.includes(e.audio.codec))throw new TypeError(`options.audio.codec, when provided, must be one of: ${q.join(", ")}.`);if(e.audio?.bitrate!==void 0&&!(e.audio.bitrate instanceof X)&&(!Number.isInteger(e.audio.bitrate)||e.audio.bitrate<=0))throw new TypeError("options.audio.bitrate, when provided, must be a positive integer or a quality.");if(e.audio?.numberOfChannels!==void 0&&(!Number.isInteger(e.audio.numberOfChannels)||e.audio.numberOfChannels<=0))throw new TypeError("options.audio.numberOfChannels, when provided, must be a positive integer.");if(e.audio?.sampleRate!==void 0&&(!Number.isInteger(e.audio.sampleRate)||e.audio.sampleRate<=0))throw new TypeError("options.audio.sampleRate, when provided, must be a positive integer.");if(e.trim!==void 0&&(!e.trim||typeof e.trim!="object"))throw new TypeError("options.trim, when provided, must be an object.");if(e.trim?.start!==void 0&&(!Number.isFinite(e.trim.start)||e.trim.start<0))throw new TypeError("options.trim.start, when provided, must be a non-negative number.");if(e.trim?.end!==void 0&&(!Number.isFinite(e.trim.end)||e.trim.end<0))throw new TypeError("options.trim.end, when provided, must be a non-negative number.");if(e.trim?.start!==void 0&&e.trim.end!==void 0&&e.trim.start>=e.trim.end)throw new TypeError("options.trim.start must be less than options.trim.end.");if(e.computeProgress!==void 0&&typeof e.computeProgress!="boolean")throw new TypeError("options.computeProgress, when provided, must be a boolean.");this._options=e,this._input=e.input,this._output=e.output,this._startTimestamp=e.trim?.start??0,this._endTimestamp=e.trim?.end??1/0;let{promise:t,resolve:r}=W();this._started=t,this._start=r}static async init(e){let t=new n(e);return await t._init(),t}async _init(){let e=await this._input.getTracks(),t=this._output.format.getSupportedTrackCounts();for(let r of e){if(this._totalTrackCount===t.total.max){this.discardedTracks.push({track:r,reason:"maxTrackCountReached"});continue}if(this._addedCounts[r.type]===t[r.type].max){this.discardedTracks.push({track:r,reason:"maxTrackCountOfTypeReached"});continue}if(r.isVideoTrack()){if(this._options.video?.discard){this.discardedTracks.push({track:r,reason:"discardedByUser"});continue}await this._processVideoTrack(r)}else if(r.isAudioTrack()){if(this._options.audio?.discard){this.discardedTracks.push({track:r,reason:"discardedByUser"});continue}await this._processAudioTrack(r)}}this._options.computeProgress&&(this._totalDuration=Math.min(await this._input.computeDuration()-this._startTimestamp,this._endTimestamp-this._startTimestamp),this.onProgress?.())}async execute(){if(this._executed)throw new Error("Conversion cannot be executed twice.");this._executed=!0,await this._output.start(),this._start(),await Promise.all(this._trackPromises),this._canceled&&await new Promise(()=>{}),await this._output.finalize(),this._options.computeProgress&&(this.progress=1,this.onProgress?.())}async cancel(){if(!(this._output.state==="finalizing"||this._output.state==="finalized")){if(this._canceled){console.warn("Conversion already canceled.");return}this._canceled=!0,await this._output.cancel()}}async _processVideoTrack(e){let t=e.codec;if(!t){this.discardedTracks.push({track:e,reason:"unknownSourceCodec"});return}let r,i=Ie(e.rotation+(this._options.video?.rotate??0)),a=this._output.format.supportsVideoRotationMetadata,[s,o]=i%180===0?[e.codedWidth,e.codedHeight]:[e.codedHeight,e.codedWidth],d=s,c=o,u=d/c,l=g=>Math.ceil(g/2)*2;this._options.video?.width!==void 0&&this._options.video.height===void 0?(d=l(this._options.video.width),c=l(Math.round(d/u))):this._options.video?.width===void 0&&this._options.video?.height!==void 0?(c=l(this._options.video.height),d=l(Math.round(c*u))):this._options.video?.width!==void 0&&this._options.video.height!==void 0&&(d=l(this._options.video.width),c=l(this._options.video.height));let m=await e.getFirstTimestamp(),p=!!this._options.video?.forceReencode||this._startTimestamp>0||m<0,h=d!==s||c!==o||i!==0&&!a,b=this._output.format.getSupportedVideoCodecs();if(!p&&!this._options.video?.bitrate&&!h&&b.includes(t)&&(!this._options.video?.codec||this._options.video?.codec===t)){let g=new Rt(t);r=g,this._trackPromises.push((async()=>{await this._started;let k=new fe(e),w={decoderConfig:await e.getDecoderConfig()??void 0};for await(let T of k.packets(void 0,this._endTimestamp)){if(this._synchronizer.shouldWait(e.id,T.timestamp)&&await this._synchronizer.wait(T.timestamp),this._canceled)return;await g.add(T,w),this._reportProgress(e.id,T.timestamp+T.duration)}await g.close(),this._synchronizer.closeTrack(e.id)})())}else{if(!await e.canDecode()){this.discardedTracks.push({track:e,reason:"undecodableSourceCodec"});return}this._options.video?.codec&&(b=b.filter(w=>w===this._options.video?.codec));let k=await cr(b,{width:d,height:c});if(k.length===0){this.discardedTracks.push({track:e,reason:"noEncodableTargetCodec"});return}let x={codec:k[0],bitrate:this._options.video?.bitrate??ut,onEncodedPacket:w=>this._reportProgress(e.id,w.timestamp+w.duration)};if(h){let w=new it(x);r=w,this._trackPromises.push((async()=>{await this._started;let S=new vt(e,{width:d,height:c,fit:this._options.video?.fit??"fill",rotation:i,poolSize:1}).canvases(this._startTimestamp,this._endTimestamp);for await(let{canvas:y,timestamp:P,duration:I}of S){if(this._synchronizer.shouldWait(e.id,P)&&await this._synchronizer.wait(P),this._canceled)return;let E=new oe(y,{timestamp:Math.max(P-this._startTimestamp,0),duration:I});await w.add(E),E.close()}})())}else{let w=new it(x);r=w,this._trackPromises.push((async()=>{await this._started;let T=new et(e);for await(let S of T.samples(this._startTimestamp,this._endTimestamp)){if(this._synchronizer.shouldWait(e.id,S.timestamp)&&await this._synchronizer.wait(S.timestamp),S.setTimestamp(Math.max(S.timestamp-this._startTimestamp,0)),this._canceled)return;await w.add(S),S.close()}await w.close(),this._synchronizer.closeTrack(e.id)})())}}this._output.addVideoTrack(r,{languageCode:e.languageCode,rotation:h?0:i}),this._addedCounts.video++,this._totalTrackCount++,this.utilizedTracks.push(e)}async _processAudioTrack(e){let t=e.codec;if(!t){this.discardedTracks.push({track:e,reason:"unknownSourceCodec"});return}let r,i=e.numberOfChannels,a=e.sampleRate,s=await e.getFirstTimestamp(),o=this._options.audio?.numberOfChannels??i,d=this._options.audio?.sampleRate??a,c=o!==i||d!==a||this._startTimestamp>0||s<0,u=this._output.format.getSupportedAudioCodecs();if(!this._options.audio?.forceReencode&&!this._options.audio?.bitrate&&!c&&u.includes(t)&&(!this._options.audio?.codec||this._options.audio.codec===t)){let l=new Ft(t);r=l,this._trackPromises.push((async()=>{await this._started;let m=new fe(e),h={decoderConfig:await e.getDecoderConfig()??void 0};for await(let b of m.packets(void 0,this._endTimestamp)){if(this._synchronizer.shouldWait(e.id,b.timestamp)&&await this._synchronizer.wait(b.timestamp),this._canceled)return;await l.add(b,h),this._reportProgress(e.id,b.timestamp+b.duration)}await l.close(),this._synchronizer.closeTrack(e.id)})())}else{if(!await e.canDecode()){this.discardedTracks.push({track:e,reason:"undecodableSourceCodec"});return}let m=null;this._options.audio?.codec&&(u=u.filter(h=>h===this._options.audio.codec));let p=await lt(u,{numberOfChannels:o,sampleRate:d});if(!p.some(h=>we.includes(h))&&u.some(h=>we.includes(h))&&(o!==Na||d!==Wa)){let h=await lt(u,{numberOfChannels:Na,sampleRate:Wa});h.some(b=>we.includes(b))&&(c=!0,m=h[0],o=Na,d=Wa)}else m=p[0]??null;if(m===null){this.discardedTracks.push({track:e,reason:"noEncodableTargetCodec"});return}if(c)r=this._resampleAudio(e,m,o,d);else{let h=new Dt({codec:m,bitrate:this._options.audio?.bitrate??ut,onEncodedPacket:b=>this._reportProgress(e.id,b.timestamp+b.duration)});r=h,this._trackPromises.push((async()=>{await this._started;let b=new tt(e);for await(let g of b.samples(void 0,this._endTimestamp)){if(this._synchronizer.shouldWait(e.id,g.timestamp)&&await this._synchronizer.wait(g.timestamp),this._canceled)return;await h.add(g),g.close()}await h.close(),this._synchronizer.closeTrack(e.id)})())}}this._output.addAudioTrack(r,{languageCode:e.languageCode}),this._addedCounts.audio++,this._totalTrackCount++,this.utilizedTracks.push(e)}_resampleAudio(e,t,r,i){let a=new Vt({codec:t,bitrate:this._options.audio?.bitrate??ut,onEncodedPacket:s=>this._reportProgress(e.id,s.timestamp+s.duration)});return this._trackPromises.push((async()=>{await this._started;let s=Math.min(await e.computeDuration()-this._startTimestamp,this._endTimestamp-this._startTimestamp),o=Math.round(s*i),d=5*i,c=0,u=new OfflineAudioContext({length:Math.min(o-c,d),numberOfChannels:r,sampleRate:i}),m=new Et(e).buffers(this._startTimestamp,this._endTimestamp);for await(let{buffer:p,timestamp:h,duration:b}of m){this._synchronizer.shouldWait(e.id,h)&&await this._synchronizer.wait(h);let g=h-this._startTimestamp,k=g+b;for(;u;){let x=c/i,w=(c+u.length)/i;if(g<w){let T=u.createBufferSource();T.buffer=p,T.connect(u.destination),g<x?T.start(0,x-g):T.start(g-x)}if(k>=w){let T=await u.startRendering();if(this._canceled)return;await a.add(T),c+=u.length;let S=Math.min(o-c,d);u=S>0?new OfflineAudioContext({length:S,numberOfChannels:r,sampleRate:i}):null}else break}}if(u){let p=await u.startRendering();if(this._canceled)return;await a.add(p)}await a.close(),this._synchronizer.closeTrack(e.id)})()),a}_reportProgress(e,t){if(!this._options.computeProgress)return;f(this._totalDuration!==null),this._maxTimestamps.set(e,Math.max(t,this._maxTimestamps.get(e)??-1/0));let r=0;for(let[,a]of this._maxTimestamps)r+=a;let i=r/this._totalTrackCount;this.progress=.99*L(i/this._totalDuration,0,1),this.onProgress?.()}},Qi=5,La=class{constructor(){this.maxTimestamps=new Map;this.resolvers=[]}computeMinAndMaybeResolve(){let e=1/0;for(let[,t]of this.maxTimestamps)e=Math.min(e,t);for(let t=0;t<this.resolvers.length;t++){let r=this.resolvers[t];r.timestamp-e<Qi&&(r.resolve(),this.resolvers.splice(t,1),t--)}return e}shouldWait(e,t){this.maxTimestamps.set(e,Math.max(t,this.maxTimestamps.get(e)??-1/0));let r=this.computeMinAndMaybeResolve();return t-r>=Qi}wait(e){let{promise:t,resolve:r}=W();return this.resolvers.push({timestamp:e,resolve:r}),t}closeTrack(e){this.maxTimestamps.delete(e),this.computeMinAndMaybeResolve()}};export{vs as ALL_FORMATS,Fi as ALL_TRACK_TYPES,q as AUDIO_CODECS,Et as AudioBufferSink,Vt as AudioBufferSource,me as AudioSample,tt as AudioSampleSink,Dt as AudioSampleSource,xe as AudioSource,It as BaseMediaSampleSink,Ra as BlobSource,_a as BufferSource,gt as BufferTarget,vt as CanvasSink,ya as CanvasSource,qr as Conversion,Kt as CustomAudioDecoder,Xt as CustomAudioEncoder,Gt as CustomVideoDecoder,jt as CustomVideoEncoder,Ft as EncodedAudioPacketSource,V as EncodedPacket,fe as EncodedPacketSink,Rt as EncodedVideoPacketSource,Wt as Input,G as InputAudioTrack,he as InputFormat,De as InputTrack,ce as InputVideoTrack,Bt as IsobmffInputFormat,_t as IsobmffOutputFormat,Ni as MATROSKA,Li as MP3,Ui as MP4,Nt as MatroskaInputFormat,at as MediaSource,Ca as MediaStreamAudioTrackSource,xa as MediaStreamVideoTrackSource,At as MkvOutputFormat,Ge as MovOutputFormat,Hr as Mp3InputFormat,wa as Mp3OutputFormat,Nr as Mp4InputFormat,Fr as Mp4OutputFormat,we as NON_PCM_AUDIO_CODECS,$i as OGG,Qr as OggInputFormat,Sa as OggOutputFormat,zt as Output,pe as OutputFormat,D as PCM_AUDIO_CODECS,Bi as QTFF,ut as QUALITY_HIGH,en as QUALITY_LOW,tn as QUALITY_MEDIUM,rn as QUALITY_VERY_HIGH,Ji as QUALITY_VERY_LOW,X as Quality,Wr as QuickTimeInputFormat,re as SUBTITLE_CODECS,Ce as Source,Aa as StreamSource,ca as StreamTarget,nt as SubtitleSource,Oe as Target,Pa as TextSubtitleSource,Oa as UrlSource,H as VIDEO_CODECS,oe as VideoSample,et as VideoSampleSink,it as VideoSampleSource,ye as VideoSource,Hi as WAVE,Wi as WEBM,$r as WaveInputFormat,Ta as WaveOutputFormat,Lr as WebMInputFormat,wt as WebMOutputFormat,un as canEncode,Jr as canEncodeAudio,ea as canEncodeSubtitles,Zr as canEncodeVideo,Es as convert,lt as getEncodableAudioCodecs,ln as getEncodableCodecs,ni as getEncodableSubtitleCodecs,cr as getEncodableVideoCodecs,Gi as registerDecoder,Ki as registerEncoder};
